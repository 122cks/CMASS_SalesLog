<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CMASS - ì‹œì‘</title>
  <!-- Version: 2025-11-01-v2 Clean URLs -->
  <style>
    :root{ --bg:#f5f6fa; --card-bg:#fff; --muted:#556; --brand-1:#12325a; --brand-2:#1e3c72; --accent:#6b8bff }
    body{font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:#071a2e;margin:0;padding:20px 16px}
    .container{max-width:1100px;margin:0 auto}
    h1{text-align:center;color:var(--brand-1);margin:6px 0 14px 0;font-size:28px}
    .hero{background:var(--card-bg);border-radius:14px;padding:18px 20px;box-shadow:0 12px 40px rgba(10,20,60,0.06);margin-bottom:14px}
    .btn-row{display:flex;gap:12px;align-items:center;justify-content:center;margin:14px 0}
    .big-btn{padding:12px 18px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--brand-1),var(--brand-2));color:#fff;font-weight:800;font-size:15px;cursor:pointer}
    .alt-btn{padding:10px 14px;border-radius:12px;border:1px solid #e1e7f6;background:var(--card-bg);color:var(--brand-1);font-weight:800;cursor:pointer}
    .card{background:var(--card-bg);border-radius:12px;padding:14px;margin-top:12px;box-shadow:0 10px 30px rgba(10,20,60,0.04)}
    /* stats grid: responsive auto-fit */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:12px}
    .stat{background:#f7fbff;border-radius:10px;padding:12px;border:1px solid #e6eefc;display:flex;flex-direction:column;justify-content:center}
    .stat div { line-height:1 }
    .stat .small{margin-top:6px;color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:8px;background:transparent}
  th,td{padding:.5rem .6rem;border:1px solid #eef2ff;text-align:left;font-size:13px}
  /* notes table: fixed layout, wrap long text and sticky header for better UX */
  .notes-table{table-layout:fixed;width:100%;border-collapse:collapse}
  .notes-table th{position:sticky;top:0;background:var(--card-bg);z-index:3}
  /* make the table denser: smaller padding and font-size for compactness */
  .notes-table th, .notes-table td{padding:.28rem .4rem;border:1px solid #eef2ff;text-align:left;font-size:12px;vertical-align:top}
  /* allow long notes to wrap and preserve line breaks; make notes column the most flexible */
  .notes-table td{word-break:break-word;white-space:normal}
  /* column width suggestions:
    1) ë°©ë¬¸ì¼ - short
    2) ë°©ë¬¸ì‹œê°„ - short
    3) ì„ ìƒë‹˜ëª… - medium-short
    4) ê³¼ëª©ëª… - short
    5) ì˜ì—…í™œë™ - slightly wider
    6) íŠ¹ì´ì‚¬í•­ - flexible / remaining space (wide)
  */
  /* Make first columns compact and give more room to activity/note columns */
  .notes-table th:nth-child(1), .notes-table td:nth-child(1){width:70px}   /* ë°©ë¬¸ì¼ */
  .notes-table th:nth-child(2), .notes-table td:nth-child(2){width:140px}  /* í•™êµ */
  .notes-table th:nth-child(3), .notes-table td:nth-child(3){width:70px}   /* ë°©ë¬¸ì‹œê°„ */
  .notes-table th:nth-child(4), .notes-table td:nth-child(4){width:90px}   /* ì„ ìƒë‹˜ëª… */
  .notes-table th:nth-child(5), .notes-table td:nth-child(5){width:90px}   /* ê³¼ëª©ëª… */
  .notes-table th:nth-child(6), .notes-table td:nth-child(6){width:220px}  /* ì˜ì—…í™œë™ - wider */
  .notes-table th:nth-child(7), .notes-table td:nth-child(7){width:auto}    /* íŠ¹ì´ì‚¬í•­ - flexible */
    .small{font-size:13px;color:var(--muted)}
  /* charts responsive height */
  canvas{width:100% !important; height:220px !important}
    /* card sections */
    #dashboardArea > div { margin-top:8px }
    /* top teachers list styling */
    #topTeachers div{padding:6px 8px;border-bottom:1px solid #f1f5ff;font-size:14px}
    /* follow-up badges grid */
    #followUpSummary div{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}

    /* mobile tweaks */
    @media (max-width:720px){
      body{padding:12px}
      h1{font-size:20px}
      .hero{padding:12px}
      .big-btn{padding:10px 12px;font-size:14px}
      canvas{height:180px !important}
      .card{padding:12px}
    }

    /* Mobile-specific dashboard tweaks: compact buttons, horizontal scroll for button bars,
       denser table cells, and responsive chart sizes for small screens */
    @media (max-width:720px){
      /* make school/subject button rows scrollable horizontally */
      #schoolButtons, #subjectButtons { overflow-x:auto; -webkit-overflow-scrolling:touch; gap:8px; flex-wrap:nowrap; white-space:nowrap; padding-bottom:6px }
      #schoolButtons .alt-btn, #subjectButtons .alt-btn { padding:6px 8px; font-size:13px; white-space:nowrap; border-radius:8px }

      /* reduce stats card density */
      .stat { padding:10px 8px }

      /* table tweaks: denser and mobile-friendly */
      .notes-table th, .notes-table td { font-size:11px; padding:.25rem .35rem }
      .notes-table th { position:sticky; top:0; z-index:4; background:var(--card-bg) }
      #schoolVisitsTableContainer { max-height:320px }

      /* charts: give more vertical room on mobile but keep them compact */
      #subjectsChart, #actionsPieChart { height:90px !important }
    /* make action and monthly charts larger for readability */
    #actionsChart { height:200px !important }
    #monthlyChart { height:240px !important }

      /* reduce margins for compactness */
      .hero, .card { padding:10px }
    }

    /* additional mobile tweaks for visit tables: avoid extreme wrapping by
       making the table horizontally scrollable when needed. Use a fixed
       table-layout with a reasonable min-width so columns keep their shape. */
    @media (max-width:720px){
      /* container is the scroll viewport for sticky header to work */
      #schoolVisitsTableContainer { overflow:auto; -webkit-overflow-scrolling:touch; padding:4px }
      /* give the table a min-width so columns don't collapse into a thin vertical strip */
      .notes-table { table-layout:fixed !important; min-width:720px; width:100% }
      .notes-table th, .notes-table td { padding:.2rem .35rem; font-size:11px }
      .notes-table td { white-space:normal; word-break:break-word }
      /* reduce header height impact */
      .notes-table thead th { font-size:12px }
      /* keep last column flexible for long notes */
  .notes-table th:nth-child(1), .notes-table td:nth-child(1){width:80px}
  .notes-table th:nth-child(2), .notes-table td:nth-child(2){width:140px}
  .notes-table th:nth-child(3), .notes-table td:nth-child(3){width:70px}
  .notes-table th:nth-child(4), .notes-table td:nth-child(4){width:100px}
  .notes-table th:nth-child(5), .notes-table td:nth-child(5){width:80px}
  .notes-table th:nth-child(6), .notes-table td:nth-child(6){width:120px}
  .notes-table th:nth-child(7), .notes-table td:nth-child(7){width:auto}
    }
    /* personal map styling */
    #personalMap{width:100%;height:420px;border-radius:8px;border:1px solid #eef2ff;margin-top:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Leaflet map for per-user geocode distribution -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
</head>
<body>
  <div class="container">
    <h1>CMASS ì˜ì—…ì¼ì§€</h1>
    <div class="hero">
      <div style="text-align:center">
        <div class="btn-row">
          <button id="goInput" class="big-btn">ì˜ì—…ì¼ì§€ ì…ë ¥</button>
          <button id="btnForceRefresh" class="alt-btn" title="ì„œë¹„ìŠ¤ì›Œì»¤ ê°•ì œ ì—…ë°ì´íŠ¸ / í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨">ìƒˆë¡œê³ ì¹¨(ìµœì‹ )</button>
        </div>

        <!-- map moved into the visit-summary section (rendered below) -->
        <div id="staffLabel" class="small" style="margin-top:6px;font-weight:800">ë‹´ë‹¹ì: ì†¡í›ˆì¬ ë¶€ì¥</div>
        <div class="small" id="heroNote">ì•„ë˜ëŠ” ë³¸ì¸ì˜ ì €ì¥ëœ ë°©ë¬¸ê¸°ë¡ ìš”ì•½ì…ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div id="personalCard" class="card">
      <h3>ë‚´ ë°©ë¬¸ ê¸°ë¡ ìš”ì•½</h3>
      <div id="noAuth" class="small" style="display:none;color:#a33;margin-bottom:.6rem;">ì‚¬ìš©ì ì •ë³´ê°€ URLì— ì—†ìŠµë‹ˆë‹¤. ì˜ˆ: <code>?user=LimJunho</code></div>
  <div id="loading" class="small" style="display: none;">ê°€ì ¸ì˜¨ í–‰ ìˆ˜: 27</div>
  <div id="loadingSpinner" style="margin-top: 6px; display: none;" class="small">ğŸ”„ ì²˜ë¦¬ì¤‘...</div>
      <div id="dashboardArea" style="display: block;">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="small" style="font-weight:700">ê¸°ê°„:</label>
            <input type="date" id="filterStart" style="padding:.4rem;border-radius:.5rem;border:1px solid #e6eefc">
            <span class="small">~</span>
            <input type="date" id="filterEnd" style="padding:.4rem;border-radius:.5rem;border:1px solid #e6eefc">
            <!-- Quick range buttons -->
            <div id="quickRanges" style="display:flex;gap:6px;align-items:center;margin-left:8px;flex-wrap:wrap">
              <button id="btnYesterday" class="alt-btn" title="ì–´ì œ">ì–´ì œ</button>
              <button id="btnToday" class="alt-btn" title="ì˜¤ëŠ˜">ì˜¤ëŠ˜</button>
              <button id="btnLastWeek" class="alt-btn" title="ì§€ë‚œì£¼ (ì›”~ì¼)">ì§€ë‚œì£¼</button>
              <button id="btnThisWeek" class="alt-btn" title="ì´ë²ˆì£¼ (ì›”~ì¼)">ì´ë²ˆì£¼</button>
              <button id="btnLastMonth" class="alt-btn" title="ì§€ë‚œë‹¬ (1ì¼~ë§ì¼)">ì§€ë‚œë‹¬</button>
              <button id="btnThisMonth" class="alt-btn" title="ì´ë²ˆë‹¬ (1ì¼~ë§ì¼)">ì´ë²ˆë‹¬</button>
            </div>
            <button id="filterApply" class="alt-btn">ì ìš©</button>
            <button id="filterClear" class="alt-btn">ì´ˆê¸°í™”</button>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <label class="small" style="font-weight:700">ê³¼ëª© í•„í„°:</label>
            <select id="subjectFilter" style="padding:.4rem;border-radius:.5rem;border:1px solid #e6eefc;background:#fff">
              <option value="">ì „ì²´</option>
            </select>
            <button id="loadMoreBtn" class="alt-btn" style="margin-left:8px;display:none" data-bound="1">ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="exportCsvBtn" class="alt-btn" style="margin-left: 6px;" data-bound="1">CSV ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>

        <div class="stats">
          <div class="stat"><div style="font-size:18px;font-weight:800" id="totalVisits">27</div><div class="small">ì´ ì €ì¥ ë¯¸íŒ… ìˆ˜</div></div>
          <div class="stat"><div style="font-size:18px;font-weight:800" id="uniqueSchools">7</div><div class="small">ë°©ë¬¸í•œ í•™êµ ìˆ˜</div></div>
          <div class="stat"><div style="font-size:18px;font-weight:800" id="totalTime">560</div><div class="small">í•™êµì— ìˆì—ˆë˜ ì´ ë°©ë¬¸ ì‹œê°„(ë¶„)</div></div>
          <div class="stat"><div style="font-size:18px;font-weight:800" id="avgDuration">80</div><div class="small">í‰ê·  ë°©ë¬¸ ì‹œê°„(ë¶„) (í•™êµë‹¹)</div></div>
          <div class="stat"><div style="font-size:18px;font-weight:800" id="contactsCount">0</div><div class="small">ìˆ˜ì§‘ëœ ì—°ë½ì²˜</div></div>
          <div class="stat"><div style="font-size:18px;font-weight:800" id="followUpsCount">27</div><div class="small">í›„ì† ì¡°ì¹˜ í•­ëª© ìˆ˜</div></div>
          <div class="stat"><div style="font-size:18px;font-weight:800" id="recentDate">2025-10-30</div><div class="small">ìµœê·¼ ë°©ë¬¸ì¼</div></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px">
          <div style="width:100%">
            <div style="font-weight:800;margin-bottom:.4rem">ë°©ë¬¸í•œ í•™êµë³„ ê¸°ë¡</div>
            <!-- ë°©ë¬¸ì¼ í•„í„° ë²„íŠ¼ (ì „ì²´ / YYYY-MM-DD / ...) -->
            <div id="dateButtons" style="margin-bottom:6px;display:flex;flex-wrap:wrap;gap:6px"><button class="alt-btn" data-date="" style="background: rgb(223, 234, 255); border: 1px solid rgb(167, 194, 255); color: rgb(11, 43, 90);">ì „ì²´</button><button class="alt-btn" data-date="2025-10-30">2025-10-30(13)</button><button class="alt-btn" data-date="2025-10-29">2025-10-29(14)</button></div>
            <div id="schoolButtons" style="margin-bottom:6px;display:flex;flex-wrap:wrap;gap:6px"><button class="alt-btn" data-school="" style="background: rgb(223, 234, 255); border: 1px solid rgb(167, 194, 255); color: rgb(11, 43, 90);">ì „ì²´</button><button class="alt-btn" data-school="ì—°í˜„ì¤‘í•™êµ">ì—°í˜„ì¤‘í•™êµ(9)</button><button class="alt-btn" data-school="ì² ì‚°ì¤‘í•™êµ">ì² ì‚°ì¤‘í•™êµ(4)</button><button class="alt-btn" data-school="ìš©ì´ì¤‘í•™êµ">ìš©ì´ì¤‘í•™êµ(5)</button><button class="alt-btn" data-school="í•œê´‘ì¤‘í•™êµ">í•œê´‘ì¤‘í•™êµ(2)</button><button class="alt-btn" data-school="ì–‘ì§„ì¤‘í•™êµ">ì–‘ì§„ì¤‘í•™êµ(3)</button><button class="alt-btn" data-school="í•œê´‘ì—¬ìì¤‘í•™êµ">í•œê´‘ì—¬ìì¤‘í•™êµ(3)</button><button class="alt-btn" data-school="ë°°ë‹¤ë¦¬ì¤‘í•™êµ">ë°°ë‹¤ë¦¬ì¤‘í•™êµ(1)</button></div>
            <!-- subject buttons appear under the school buttons for quick filtering -->
            <div id="subjectButtons" style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:6px"><button class="alt-btn" data-subject="" style="background: rgb(223, 234, 255); border: 1px solid rgb(167, 194, 255); color: rgb(11, 43, 90);">ì „ì²´</button><button class="alt-btn" data-subject="ì •ë³´">ì •ë³´(5)</button><button class="alt-btn" data-subject="ì§„ë¡œ">ì§„ë¡œ(9)</button><button class="alt-btn" data-subject="ë³´ê±´">ë³´ê±´(10)</button><button class="alt-btn" data-subject="ë¯¸ìˆ ">ë¯¸ìˆ (0)</button><button class="alt-btn" data-subject="ì²´ìœ¡">ì²´ìœ¡(0)</button><button class="alt-btn" data-subject="ë„ì„œê´€ì‚¬ì„œ">ë„ì„œê´€ì‚¬ì„œ(0)</button><button class="alt-btn" data-subject="íŠ¹ì„±í™”">íŠ¹ì„±í™”(0)</button><button class="alt-btn" data-subject="ê¸°íƒ€">ê¸°íƒ€(3)</button></div>
            <div id="schoolVisitsTableContainer" style="max-height:420px;overflow:auto;border:1px solid #eef2ff;padding:6px;border-radius:6px;background:#fff"><div style="width: 100%; overflow: visible;"><table class="notes-table"><thead><tr><th>ë°©ë¬¸ì¼</th><th>í•™êµ</th><th>ë°©ë¬¸ì‹œê°„</th><th>ì„ ìƒë‹˜ëª…</th><th>ê³¼ëª©ëª…</th><th>ì˜ì—…í™œë™</th><th>íŠ¹ì´ì‚¬í•­</th></tr></thead><tbody><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td></td><td>ë³´ê±´</td><td></td><td></td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td>ë¯¸ìƒ</td><td>ë³´ê±´</td><td>ëª…í•¨ì¸ì‚¬</td><td></td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td>ë°•ëª…ìˆ™</td><td>ì§„ë¡œ</td><td>ëª…í•¨ì¸ì‚¬, ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td>3í•™ë…„ ë‹´ì„ë“¤ê³¼ ê³ 1í•™ì—…ì„¤ê³„ì™€ ê³ êµí•™ì ì œ ì›Œí¬ë¶ ìˆ˜ì—…í˜‘ì˜í•´ ë³´ê² ê³  AIì§ì—…ì„¸ê³„ëŠ” ë‚¨ì€ ì˜ˆì‚° í™•ì¸í•˜ì—¬ êµ¬ì…í† ë¡í•˜ê² ìŒ.ë‹¨ì´‰ë°©ë„ ì˜ í™œìš©í•˜ê³  ìˆìŒ</td></tr><tr><td>2025-10-30</td><td>ì² ì‚°ì¤‘í•™êµ</td><td>14:15 - 15:05</td><td>ì„í›ˆì˜</td><td>ë³´ê±´</td><td>ëª…í•¨ì¸ì‚¬</td><td>ìš°ë¦¬í•™êµëŠ” êµê³¼ì„œ ìˆ˜ì—…ì„ í•˜ê³ ìˆì§€ ì•ŠìŒ. í¬ìŠ¤í„°ëŠ” ë§ì€ ë„ì›€ì´ ë ê²ƒ ê°™ìŒ</td></tr><tr><td>2025-10-30</td><td>ì² ì‚°ì¤‘í•™êµ</td><td>14:15 - 15:05</td><td>ìœ¤ì„ í¬</td><td>ì •ë³´</td><td>ëª…í•¨ì¸ì‚¬, ì—°ìˆ˜ì•ˆë‚´</td><td>AIDTêµìœ¡ìë£Œ ì•ˆë‚´. í•™êµ ì§€ì¹¨ì€ ìˆ˜ì—… ì•ˆí•˜ê¸°ë¡œ í–ˆìœ¼ë‚˜ ê²€í† ëŠ” í•´ë³´ê² ìŒ</td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td></td><td>ë³´ê±´</td><td></td><td></td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td>ë°•ëª…ìˆ™</td><td>ì§„ë¡œ</td><td>ëª…í•¨ì¸ì‚¬, ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td>3í•™ë…„ ë‹´ì„ë“¤ê³¼ ê³ 1í•™ì—…ì„¤ê³„ì™€ ê³ êµí•™ì ì œ ì›Œí¬ë¶ ìˆ˜ì—…í˜‘ì˜í•´ ë³´ê² ê³  AIì§ì—…ì„¸ê³„ëŠ” ë‚¨ì€ ì˜ˆì‚° í™•ì¸í•˜ì—¬ êµ¬ì…í† ë¡í•˜ê² ìŒ.ë‹¨ì´‰ë°©ë„ ì˜ í™œìš©í•˜ê³  ìˆìŒ</td></tr><tr><td>2025-10-30</td><td>ì² ì‚°ì¤‘í•™êµ</td><td>14:15 - 15:05</td><td>ì‚¬ì„œ ì´í˜„ì£¼</td><td>ê¸°íƒ€</td><td>ëª…í•¨ì¸ì‚¬</td><td>ì§„ë¡œë„ì„œ ë¸Œë¡œìŠˆì–´ ì „ë‹¬í•˜ë©° ë„ì„œì¶”ì²œ ë¶€íƒ</td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td>ë°•ëª…ìˆ™</td><td>ì§„ë¡œ</td><td>ëª…í•¨ì¸ì‚¬, ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td>3í•™ë…„ ë‹´ì„ë“¤ê³¼ ê³ 1í•™ì—…ì„¤ê³„ì™€ ê³ êµí•™ì ì œ ì›Œí¬ë¶ ìˆ˜ì—…í˜‘ì˜í•´ ë³´ê² ê³  AIì§ì—…ì„¸ê³„ëŠ” ë‚¨ì€ ì˜ˆì‚° í™•ì¸í•˜ì—¬ êµ¬ì…í† ë¡í•˜ê² ìŒ.ë‹¨ì´‰ë°©ë„ ì˜ í™œìš©í•˜ê³  ìˆìŒ</td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td>ë¯¸ìƒ</td><td>ë³´ê±´</td><td>ëª…í•¨ì¸ì‚¬</td><td></td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td></td><td>ë³´ê±´</td><td></td><td></td></tr><tr><td>2025-10-30</td><td>ì² ì‚°ì¤‘í•™êµ</td><td>14:15 - 15:05</td><td>ì´ë´‰ì¶˜</td><td>ì§„ë¡œ</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´</td><td>ë‹¨í†¡ë°© í™œìš©í•˜ê³  ìˆìœ¼ë©° ì„œì±…êµê³¼ì„œëŠ” ì‚¬ìš©í•˜ì§€ì•Šê³  ì°½ì²´ìˆ˜ì—…ìœ¼ë¡œ ëŒ€ì²´í•¨
ê³ 1í•™ì—…ì„¤ê³„ ë° AIì§ì—…ì„¸ê³„ëŠ” ë‚´ìš©ì€ ë„ì›€ì´ ë ê²ƒ ê°™ì€ë° ë³¸ì¸ì´ í™œë™ì¤‘ì‹¬ì˜ ìˆ˜ì—…ì„ ì„ í˜¸í•˜ì—¬ êµ¬ì…ì€ í˜ë“¤ê²ƒ ê°™ìŒ</td></tr><tr><td>2025-10-30</td><td>ì—°í˜„ì¤‘í•™êµ</td><td>16:25 - 17:05</td><td>ë¯¸ìƒ</td><td>ë³´ê±´</td><td>ëª…í•¨ì¸ì‚¬</td><td></td></tr><tr><td>2025-10-29</td><td>ìš©ì´ì¤‘í•™êµ</td><td>-</td><td>ì´ì›ì„ </td><td>ê¸°íƒ€</td><td></td><td>3í•™ë…„ë¶€ì¥ ê³ 1í•™ì—…ìˆ˜ì—… ë° ê³ êµí•™ì ì œ ì›Œí¬ë¶ ì•ˆë‚´ ë° ë¦¬í”Œë¦¿ ì „ë‹¬</td></tr><tr><td>2025-10-29</td><td>í•œê´‘ì¤‘í•™êµ</td><td>-</td><td>ê¹€ì¬ê· </td><td>ì§„ë¡œ</td><td>ëª…í•¨ì¸ì‚¬, ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td>ì§€í•™ì‚¬ ì§‘í•„ì§„ìœ¼ë¡œ ì”¨ë§ˆìŠ¤ì— ìš°í˜¸ì ì¸ë¶„. ë¦¬í”Œë¦¿ ì „ë‹¬í–ˆìœ¼ë©° ì›Œí¬ë¶ì— ê´€ì‹¬ì´ ë§ì€ ë¶„ìœ¼ë¡œ ê²€í† í•´ì„œ ì—°ë½í•˜ê¸°ë¡œ í•¨</td></tr><tr><td>2025-10-29</td><td>ì–‘ì§„ì¤‘í•™êµ</td><td>-</td><td>ê°•ê²½ìˆ˜</td><td>ì§„ë¡œ</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td>ì§„ë¡œíƒìƒ‰ì›Œí¬ë¶ ê°€ê²©ë¬¸ì˜ í›„ ì‚¼ì–‘ì— ë¹„í•´ ê°€ê²©ì´ ë¹„ì‹¸ë‹¤ê³  í•¨. ê°€ê²©ì ˆì¶© ê°€ëŠ¥í•˜ë‹¤ê³  ì•Œë ¤ ë“œë ¸ìŒ</td></tr><tr><td>2025-10-29</td><td>ì–‘ì§„ì¤‘í•™êµ</td><td>-</td><td>ì–‘ëª…ì´</td><td>ì •ë³´</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´, êµêµ¬ì¬ì•ˆë‚´, í¬ìŠ¤í„°, ì—°ìˆ˜ì•ˆë‚´</td><td></td></tr><tr><td>2025-10-29</td><td>í•œê´‘ì—¬ìì¤‘í•™êµ</td><td>-</td><td>ì†¡ë¯¸ì˜</td><td>ì§„ë¡œ</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td>ì›Œí¬ë¶ ë¬´ìƒì§€ì› ì°½ì—…ê°€ì •ì‹  ê¸°ì´ˆí¸ 11ì›”ì¤‘ ì‹ ì²­í•˜ê² ìŒ. ê³ 1í•™ì—…ì„¤ê³„ë“± ë‹¨í–‰ë³¸ì€ ì¤‘3ë‹´ì„ë“¤ê³¼ í˜‘ì˜í•˜ì—¬ ë„ì„œê´€ì„ í†µí•˜ê±°ë‚˜ ìì²´êµ¬ì…í•˜ê² ìŒ</td></tr><tr><td>2025-10-29</td><td>í•œê´‘ì—¬ìì¤‘í•™êµ</td><td>-</td><td>ê¶Œí˜„ì •</td><td>ì •ë³´</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´</td><td>í•™ìì‹œ êµê³¼ì„œ ê´€ë ¨í•˜ì—¬ í˜‘ì˜(í•™ìš´ìœ„ì— ì˜¬ë ¤ë³´ê² ìŒ)ì”¨ë§ˆìŠ¤ ì—°ìˆ˜ì— ëŒ€í•´ í˜¸í‰í•˜ì‹œë©° ê´€ë ¨ì§ì›ë“¤ ë…¸ê³  ì¹­ì°¬ ë° ê°œì¸ì ìœ¼ë¡œ ì½”ë‹µ ë‹¨í–‰ë³¸ êµ¬ì…í•˜ì˜€ìŒ</td></tr><tr><td>2025-10-29</td><td>ë°°ë‹¤ë¦¬ì¤‘í•™êµ</td><td>-</td><td>í•œì„±ìˆ˜</td><td>ì§„ë¡œ</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td>ì°½ì—…ê°€ì •ì‹ (ê¸°ì´ˆ)ì›Œí¬ë¶ êµ¬ì… ê²°ì •(170ë¶€)ê³ 1í•™ì—…ì„¤ê³„ ê²€í† í›„ êµ¬ì… ì§„ë¡œêµê³¼ì„œ ì”¨ë§ˆìŠ¤ ì„ ì •(3í•™ë…„í¸ì„±).êµê³¼ì„œ ì£¼ë¬¸ì€ ë‚´ë…„ì— í• ìˆ˜ë„ ìˆìŒ</td></tr><tr><td>2025-10-29</td><td>í•œê´‘ì—¬ìì¤‘í•™êµ</td><td>-</td><td>ë¯¸ìƒ</td><td>ë³´ê±´</td><td>ëª…í•¨ì¸ì‚¬</td><td>ìë£Œì „ë‹¬</td></tr><tr><td>2025-10-29</td><td>ìš©ì´ì¤‘í•™êµ</td><td>-</td><td>ìµœì€ì§„</td><td>ë³´ê±´</td><td>ëª…í•¨ì¸ì‚¬</td><td>í¬ìŠ¤í„° ë“± ì „ë‹¬. ìˆ˜ì—… ë¯¸ì‹¤ì‹œ</td></tr><tr><td>2025-10-29</td><td>ì–‘ì§„ì¤‘í•™êµ</td><td>-</td><td>ìœ¤ì¸ì˜</td><td>ë³´ê±´</td><td>ëª…í•¨ì¸ì‚¬</td><td>í¬ìŠ¤í„° ë° ì›Œí¬ë¶ ì „ë‹¬ êµê³¼ì„œ ìˆ˜ì—… ì—†ìŒ</td></tr><tr><td>2025-10-29</td><td>ìš©ì´ì¤‘í•™êµ</td><td>-</td><td>ë§¹ì‚¼í˜¸</td><td>ì •ë³´</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´, êµêµ¬ì¬ì•ˆë‚´</td><td></td></tr><tr><td>2025-10-29</td><td>í•œê´‘ì¤‘í•™êµ</td><td>-</td><td>ë¯¸ìƒ</td><td>ì •ë³´</td><td>ëª…í•¨ì¸ì‚¬, ë‹¨í–‰ë³¸ì•ˆë‚´</td><td></td></tr><tr><td>2025-10-29</td><td>ìš©ì´ì¤‘í•™êµ</td><td>-</td><td></td><td></td><td></td><td></td></tr><tr><td>2025-10-29</td><td>ìš©ì´ì¤‘í•™êµ</td><td>-</td><td></td><td>ì§„ë¡œ</td><td>ë‹¨í–‰ë³¸ì•ˆë‚´, ì›Œí¬ë¶ì•ˆë‚´</td><td></td></tr></tbody></table></div></div>
          </div>

          <div style="width:100%">
            <div style="display:flex;flex-direction:column;gap:12px">
                  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
                    <div style="flex:1 1 320px;min-width:220px">
                      <div style="font-weight:800;margin-bottom:.4rem">ê³¼ëª© ë¶„í¬</div>
                      <canvas id="subjectsChart" style="max-width: 100%; height: 249px; box-sizing: border-box; display: block; width: 530px;" width="530" height="249"></canvas><div id="subjectsChart_placeholder" class="small" style="padding: 0.8rem; color: var(--muted); min-height: 60px; display: none;"></div>
                    </div>
                    <div style="flex:1 1 320px;min-width:220px">
                      <div style="font-weight:800;margin-bottom:.4rem">ì˜ì—…í™œë™ ë¶„í¬</div>
                      <canvas id="actionsPieChart" style="max-width: 100%; height: 249px; box-sizing: border-box; display: block; width: 530px;" width="530" height="249"></canvas><div id="actionsPieChart_placeholder" class="small" style="padding: 0.8rem; color: var(--muted); min-height: 60px; display: none;"></div>
                    </div>
                  </div>
                  <!-- monthlyChart moved below behavior/keywords per layout change -->
            </div>
          </div>
        </div>

        <!-- Reordered sections: í›„ì†ì¡°ì¹˜ ìš”ì•½ + íŠ¹ì´ì‚¬í•­ ë¶„ì„ first, then í–‰ë™ ë¶„ì„, monthly timeline, then personal map -->
        <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem">
          <div style="flex:1 1 360px">
            <div style="font-weight:800;margin-bottom:.4rem">í›„ì†ì¡°ì¹˜ ìš”ì•½</div>
            <div id="followUpSummary"><div style="display: grid; gap: 0.3rem;"><div style="padding: 0.25rem 0.3rem; border: 1px solid rgb(238, 242, 255); border-radius: 6px;">ì™„ë£Œ (ì¶”ê°€ ì¡°ì¹˜ ì—†ìŒ) Â· 13</div><div style="padding: 0.25rem 0.3rem; border: 1px solid rgb(238, 242, 255); border-radius: 6px;">ë¯¸ì§€ì • Â· 6</div><div style="padding: 0.25rem 0.3rem; border: 1px solid rgb(238, 242, 255); border-radius: 6px;">ì›Œí¬ë¶ ë¬´ìƒì§€ì› ì œì•ˆ Â· 5</div><div style="padding: 0.25rem 0.3rem; border: 1px solid rgb(238, 242, 255); border-radius: 6px;">ì±„íŒ…ë°© ì§€ì† ê´€ë¦¬ Â· 2</div><div style="padding: 0.25rem 0.3rem; border: 1px solid rgb(238, 242, 255); border-radius: 6px;">ì„ ì • ì‹œê¸° ì—°ë½ ëŒ€ê¸° Â· 1</div></div></div>
          </div>
          <div style="flex:1 1 360px">
            <div style="font-weight:800;margin-bottom:.4rem">íŠ¹ì´ì‚¬í•­ í‚¤ì›Œë“œ ë¶„ì„</div>
            <div id="noteKeywords" style="min-height:120px;padding:.6rem;border-radius:8px;border:1px solid #eef2ff;background:#fbfdff"><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ì›Œí¬ë¶ Â· 7</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë‹´ì„ë“¤ê³¼ Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ê³ êµí•™ì ì œ Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ì§ì—…ì„¸ê³„ëŠ” Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">í™œìš©í•˜ê³  Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ìˆìŒ Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ai Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ê³ êµí•™ì ì œ ì›Œí¬ë¶ Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">êµê³¼ì„œ Â· 4</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">í•™ë…„ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">í•™ì—…ì„¤ê³„ì™€ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ìˆ˜ì—…í˜‘ì˜í•´ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë³´ê² ê³  Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë‚¨ì€ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ì˜ˆì‚° Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">í™•ì¸í•˜ì—¬ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">êµ¬ì…í† ë¡í•˜ê² ìŒ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë‹¨ì´‰ë°©ë„ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">í•™ë…„ ë‹´ì„ë“¤ê³¼ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë‹´ì„ë“¤ê³¼ í•™ì—…ì„¤ê³„ì™€ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">í•™ì—…ì„¤ê³„ì™€ ê³ êµí•™ì ì œ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ì›Œí¬ë¶ ìˆ˜ì—…í˜‘ì˜í•´ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ìˆ˜ì—…í˜‘ì˜í•´ ë³´ê² ê³  Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë³´ê² ê³  ì§ì—…ì„¸ê³„ëŠ” Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ì§ì—…ì„¸ê³„ëŠ” ë‚¨ì€ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë‚¨ì€ ì˜ˆì‚° Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ì˜ˆì‚° í™•ì¸í•˜ì—¬ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">í™•ì¸í•˜ì—¬ êµ¬ì…í† ë¡í•˜ê² ìŒ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">êµ¬ì…í† ë¡í•˜ê² ìŒ ë‹¨ì´‰ë°©ë„ Â· 3</span><span style="display: inline-block; margin: 4px 6px; padding: 6px 8px; border-radius: 12px; background: rgb(238, 245, 255); font-size: 13px;">ë‹¨ì´‰ë°©ë„ í™œìš©í•˜ê³  Â· 3</span></div>
          </div>
        </div>

        <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem">
          <div style="flex:1 1 720px">
            <div style="font-weight:800;margin-bottom:.4rem">í–‰ë™(ëª…í•¨ì¸ì‚¬/í‹°ì¹­ìƒ˜ì†Œê°œ/ì±„íŒ…ë°©ì†Œê°œ ë“±) ë¶„ì„</div>
            <canvas id="actionsChart" style="max-width: 100%; height: 786px; box-sizing: border-box; display: block; width: 1072px;" width="1072" height="786"></canvas><div id="actionsChart_placeholder" class="small" style="padding: 0.8rem; color: var(--muted); min-height: 60px; display: none;"></div>
          </div>
        </div>

        <!-- monthly timeline follows the behavior analysis -->
        <div style="font-weight:800;margin:14px 0 .4rem">ì›”ë³„ ë°©ë¬¸ ì¶”ì´ (ì—°ê°„)</div>
        <canvas id="monthlyChart" style="max-width: 100%; height: 2560px; box-sizing: border-box; display: block; width: 1072px;" width="1072" height="2560"></canvas><div id="monthlyChart_placeholder" class="small" style="padding: 0.8rem; color: var(--muted); min-height: 60px; display: none;"></div>

        <!-- personal map placed at the bottom -->
        <div id="mapCard" class="card" style="margin-top:12px">
          <div style="font-weight:800;margin-bottom:.4rem">ë‚´ ì§€ì—­ ë°©ë¬¸ ì§€ë„</div>
          <div id="personalMap"></div>
          <div class="small" style="margin-top:6px">ì§€ë„ëŠ” ì„œë²„ì˜ ì‚¬ì „ ê³„ì‚°ëœ <code>geocodes.json</code>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì¼ë¶€ í•™êµëŠ” ì¢Œí‘œê°€ ì—†ì–´ í‘œì‹œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>
    <div style="height:40px"></div>
  </div>

  <script>
    // small helper: map user token to display staff (same mapping used elsewhere)
    function getStaffFromQuery(){
      try{
        const params = new URLSearchParams(window.location.search);
        const user = params.get('user') || '';
        if (!user) return '';
        const lower = user.toLowerCase();
        // canonical lowercase/legacy mapping
        const map = {
          'songhoonjae': 'ì†¡í›ˆì¬ ë¶€ì¥',
          'songhunje': 'ì†¡í›ˆì¬ ë¶€ì¥',
          'limjunho': 'ì„ì¤€í˜¸ ì°¨ì¥',
          'imjunho': 'ì„ì¤€í˜¸ ì°¨ì¥',
          'choyounghwan': 'ì¡°ì˜í™˜ ë¶€ì¥',
          'joyounghwan': 'ì¡°ì˜í™˜ ë¶€ì¥'
        };
        if (map[lower]) return map[lower];
  // Accept exact-case tokens used by the index select and input pages
        if (user === 'SongHoonjae' || user === 'Songhoonjae') return 'ì†¡í›ˆì¬ ë¶€ì¥';
        if (user === 'LimJunho') return 'ì„ì¤€í˜¸ ì°¨ì¥';
        if (user === 'ChoYounghwan' || user === 'ChoYoungHwan') return 'ì¡°ì˜í™˜ ë¶€ì¥';
        return user;
      }catch(e){return ''}
    }

    document.getElementById('goInput').addEventListener('click', ()=>{
      // preserve user token if present
      try{
        const qs = window.location.search || '';
        const origin = (location && location.origin) ? location.origin : (location.protocol + '//' + location.host);
  const target = origin + '/input' + qs;
        // debug log to help diagnose in TWA/webview environments
        try{ console.log('goInput -> navigating to', target); }catch(e){}

        // Try multiple navigation strategies in order of reliability across webviews/TWAs.
        // 1) assign
        try{ window.location.assign(target); }catch(e){ /* ignore */ }
  // 2) replace (avoid adding to back history)
  // NOTE: calling replace() here after assign() removed the originating
  // page from the session history which prevented the browser back
  // button from returning to the front page. Remove the unconditional
  // replace() call so the previous page remains in the history.
  // If a webview requires replace semantics we can enable it behind a
  // feature-flag later, but for normal browsers retain assign()/href.
  // try{ window.location.replace(target); }catch(e){ /* ignore */ }
        // 3) href fallback
        try{ window.location.href = target; }catch(e){ /* ignore */ }
        // 4) synthetic anchor click (some webviews handle anchor clicks differently)
        try{
          let a = document.getElementById('__goInputAnchor');
          if (!a){ a = document.createElement('a'); a.id='__goInputAnchor'; a.style.display='none'; document.body.appendChild(a); }
          a.href = target; a.target = '_self'; a.click();
        }catch(e){ /* ignore */ }

        // 5) as a last resort, attempt opening in same origin via window.open
        try{ window.open(target, '_self'); }catch(e){ /* ignore */ }

        // If nothing happened (some webviews swallow navigation), surface a visible fallback link
        try{
          setTimeout(()=>{
            const msgId = '__goInputFallbackMsg';
            if (!document.getElementById(msgId)){
              const div = document.createElement('div'); div.id = msgId; div.style.marginTop='8px'; div.style.textAlign='center';
              div.innerHTML = 'ìë™ ì´ë™ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. <a href="'+ target +'" onclick="return true;">ì—¬ê¸°</a>ë¥¼ ëˆ„ë¥´ë©´ ì´ë™í•©ë‹ˆë‹¤.';
              const hero = document.querySelector('.hero') || document.body;
              hero.parentNode.insertBefore(div, hero.nextSibling);
            }
          }, 300);
        }catch(e){ /* ignore */ }

      }catch(e){ console.warn('goInput navigation failed', e); }
    });

    // Force-refresh helper: try to update service worker and activate it, then reload
    async function forceServiceWorkerUpdate(){
      try{
        if (!('serviceWorker' in navigator)){ location.reload(true); return; }
        const reg = await navigator.serviceWorker.getRegistration();
        if (!reg){ // no service worker registered â€” fallback to reload
          location.reload(true); return;
        }

        // If there's a waiting SW, message it to skipWaiting (if it supports message), and watch for activation
        if (reg.waiting){
          let handled = false;
          const p = new Promise((resolve)=>{
            function onStateChange(){
              if (reg.waiting && reg.waiting.state === 'activated'){
                handled = true; resolve(true);
              }
            }
            reg.waiting.addEventListener('statechange', onStateChange);
            // try postMessage; some SWs listen for this pattern
            try{ reg.waiting.postMessage({ type: 'SKIP_WAITING' }); }catch(e){}
            // fallback: after short timeout, resolve so we can reload
            setTimeout(()=>{ if (!handled) resolve(false); }, 2500);
          });
          const ok = await p;
          if (ok){ window.location.reload(); return; }
        }

        // Otherwise, ask the SW to check for updates, then if there's a waiting worker, activate it
        try{ await reg.update(); }catch(e){ console.warn('sw update failed', e); }
        if (reg.waiting){ try{ reg.waiting.postMessage({ type:'SKIP_WAITING' }); }catch(e){} /* let statechange listener reload on activation */ }
        // final fallback: reload after small delay to pick up new content
        setTimeout(()=>{ window.location.reload(); }, 1500);
      }catch(e){ console.warn('forceServiceWorkerUpdate failed', e); try{ window.location.reload(); }catch(_){ } }
    }

    const btnForce = document.getElementById('btnForceRefresh');
    if (btnForce) btnForce.addEventListener('click', ()=>{
      btnForce.disabled = true; btnForce.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';
      forceServiceWorkerUpdate().finally(()=>{ setTimeout(()=>{ btnForce.disabled=false; btnForce.textContent='ìƒˆë¡œê³ ì¹¨(ìµœì‹ )'; }, 1600); });
    });

    // no visible fallback link â€” only the left button remains

    // Defensive: remove accidental plain-text CSS snippets accidentally rendered at top
    (function removeStrayCssText(){
      try{
        const children = Array.from(document.body.childNodes);
        for (const node of children){
          if (node.nodeType === Node.TEXT_NODE){
            const txt = (node.textContent||'').trim();
            if (!txt) continue;
            // heuristic: if text looks like CSS rules, remove it
            if (txt.indexOf('.stat{') !== -1 || txt.indexOf('table{') !== -1 || txt.indexOf('.small{') !== -1){
              node.parentNode && node.parentNode.removeChild(node);
            }
          }
        }
      }catch(e){ /* ignore */ }
    })();

    async function loadPersonalVisits(){
      const staff = getStaffFromQuery();
      try { const lbl = document.getElementById('staffLabel'); if (lbl) lbl.textContent = staff ? ('ë‹´ë‹¹ì: ' + staff) : ''; } catch(e){}
      if (!staff){ document.getElementById('noAuth').style.display='block'; document.getElementById('loading').style.display='none'; return; }

      // UI hooks
      const startEl = document.getElementById('filterStart');
      const endEl = document.getElementById('filterEnd');
  const btnYesterday = document.getElementById('btnYesterday');
  const btnToday = document.getElementById('btnToday');
  const btnLastWeek = document.getElementById('btnLastWeek');
  const btnThisWeek = document.getElementById('btnThisWeek');
  const btnLastMonth = document.getElementById('btnLastMonth');
  const btnThisMonth = document.getElementById('btnThisMonth');
      const subjectFilterEl = document.getElementById('subjectFilter');
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      const loadingEl = document.getElementById('loading');
      const loadingSpinner = document.getElementById('loadingSpinner');

      function showLoading(msg){ if (loadingEl) { loadingEl.style.display='block'; loadingEl.textContent = msg || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'; } if (loadingSpinner) loadingSpinner.style.display = '' }
      function hideLoading(){ if (loadingEl) loadingEl.style.display='none'; if (loadingSpinner) loadingSpinner.style.display = 'none' }

      // helper: format Date -> yyyy-mm-dd
      function fmt(d){ if (!d) return ''; const y = d.getFullYear(); const m = (d.getMonth()+1).toString().padStart(2,'0'); const day = d.getDate().toString().padStart(2,'0'); return `${y}-${m}-${day}`; }

      // compute week (Mon-Sun) for date 'ref'
      function weekRangeFor(ref){ const d = new Date(ref.getFullYear(), ref.getMonth(), ref.getDate()); const dow = d.getDay(); // 0=Sun..6=Sat
        const diffToMon = (dow === 0) ? -6 : (1 - dow); const mon = new Date(d); mon.setDate(d.getDate() + diffToMon); const sun = new Date(mon); sun.setDate(mon.getDate() + 6); return [mon, sun]; }

      // compute month range for year,month index
      function monthRangeFor(year, monthIndex){ const start = new Date(year, monthIndex, 1); const end = new Date(year, monthIndex + 1, 0); return [start, end]; }

      // set inputs and optionally reload data
      function setRangeAndReload(sDate, eDate, reload=true){ if (!startEl || !endEl) return; startEl.value = sDate; endEl.value = eDate; if (reload) { renderAndReload(); } }

      // renderAndReload: call loadPersonalVisits again by re-invoking fetch flow
      function renderAndReload(){ try{ // call the existing fetch by re-running loadPersonalVisits's inner fetch path: easiest is to call loadPersonalVisits() again
          // remove old dashboard and call loadPersonalVisits to re-fetch
          // Note: loadPersonalVisits is attached to window via DOMContentLoaded; ensure it's accessible
          if (typeof loadPersonalVisits === 'function') { loadPersonalVisits(); }
        }catch(e){ console.warn('reload failed', e); } }

      // wire quick buttons
      if (btnToday) btnToday.addEventListener('click', ()=>{ const t = new Date(); setRangeAndReload(fmt(t), fmt(t)); });
      if (btnYesterday) btnYesterday.addEventListener('click', ()=>{ const t = new Date(); t.setDate(t.getDate() - 1); setRangeAndReload(fmt(t), fmt(t)); });
      if (btnThisWeek) btnThisWeek.addEventListener('click', ()=>{ const [mon, sun] = weekRangeFor(new Date()); setRangeAndReload(fmt(mon), fmt(sun)); });
      if (btnLastWeek) btnLastWeek.addEventListener('click', ()=>{ const ref = new Date(); ref.setDate(ref.getDate() - 7); const [mon, sun] = weekRangeFor(ref); setRangeAndReload(fmt(mon), fmt(sun)); });
      if (btnThisMonth) btnThisMonth.addEventListener('click', ()=>{ const now = new Date(); const [s,e] = monthRangeFor(now.getFullYear(), now.getMonth()); setRangeAndReload(fmt(s), fmt(e)); });
      if (btnLastMonth) btnLastMonth.addEventListener('click', ()=>{ const now = new Date(); const [s,e] = monthRangeFor(now.getFullYear(), now.getMonth()-1); setRangeAndReload(fmt(s), fmt(e)); });

      // wire apply/clear buttons to reload
      const filterApplyBtn = document.getElementById('filterApply');
      const filterClearBtn = document.getElementById('filterClear');
      if (filterApplyBtn) filterApplyBtn.addEventListener('click', ()=>{ renderAndReload(); });
      if (filterClearBtn) filterClearBtn.addEventListener('click', ()=>{ if (startEl) startEl.value=''; if (endEl) endEl.value=''; renderAndReload(); });

      // base staff name without title suffix
  const base = staff.replace(/\s*(ë¶€ì¥|ì°¨ì¥|ê³¼ì¥|ëŒ€ë¦¬|ì‚¬ì›|íŒ€ì¥|ì„ ìƒë‹˜|ì„ ìƒ)$/,'').trim();

      // Build initial query params
      const userToken = (new URLSearchParams(window.location.search)).get('user') || '';
      const buildUrl = (cursor) => {
        const params = new URLSearchParams();
        params.set('useEntries','true');
        params.set('pageSize','100');
        // send both a human-friendly staff base (Korean) and the original user token
  // send the full staff label (including title) when available so Firestore equality matches stored docs
  if (staff) params.set('staff', staff);
        if (userToken) params.set('user', userToken);
        const sVal = startEl && startEl.value ? startEl.value : '';
        const eVal = endEl && endEl.value ? endEl.value : '';
        const subj = subjectFilterEl && subjectFilterEl.value ? subjectFilterEl.value : '';
        if (sVal) params.set('start', sVal);
        if (eVal) params.set('end', eVal);
        if (subj) params.set('subject', subj);
        if (cursor) params.set('cursor', cursor);
        return '/api/visits?' + params.toString();
      };

      try{
        // Default date range: this week (Mon-Sun). Exception: if today is Monday,
        // default to last week instead.
        try{
          if (startEl && endEl && !startEl.value && !endEl.value){
            const today = new Date();
            const isMonday = (today.getDay() === 1);
            const ref = new Date(today);
            if (isMonday){ ref.setDate(ref.getDate() - 7); }
            const [dMon, dSun] = weekRangeFor(ref);
            startEl.value = fmt(dMon);
            endEl.value = fmt(dSun);
          }
        }catch(e){ console.warn('default range calc failed', e); }

        showLoading('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        // reset accumulators
        window._visitsAccum = [];
        window._visitsNextCursor = null;

        // fetch first page
        const url = buildUrl(null);
        const res = await fetch(url);
        const j = await res.json();
        if (!j || !j.ok) { hideLoading(); loadingEl.textContent = 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'; return; }
        const rows = Array.isArray(j.rows) ? j.rows : [];
        // Debug: surface fetched row count so users can see whether API returned data
        try{
          const params = new URLSearchParams(window.location.search);
          const debug = params.get('debug');
          if (loadingEl) loadingEl.textContent = 'ê°€ì ¸ì˜¨ í–‰ ìˆ˜: ' + rows.length;
          if (debug === '1'){
            let dbg = document.getElementById('__fetch_debug');
            if (!dbg){ dbg = document.createElement('pre'); dbg.id = '__fetch_debug'; dbg.style.maxHeight = '220px'; dbg.style.overflow = 'auto'; dbg.style.padding = '.6rem'; dbg.style.background = '#fbfdff'; dbg.style.border = '1px solid #eef2ff'; dbg.style.marginTop = '8px'; loadingEl.parentNode && loadingEl.parentNode.insertBefore(dbg, loadingEl.nextSibling); }
            dbg.textContent = JSON.stringify(j, null, 2);
          }
        }catch(e){ console.warn('debug UI update failed', e); }
        window._visitsAccum = rows.slice();
        window._visitsNextCursor = j.nextCursor || null;

        // show load more/export controls if applicable
        if (window._visitsNextCursor) { loadMoreBtn.style.display = ''; loadMoreBtn.disabled = false; }
        else { loadMoreBtn.style.display = 'none'; }
        if (window._visitsAccum.length) exportCsvBtn.style.display = ''; else exportCsvBtn.style.display = 'none';

        // wire load more
        if (!loadMoreBtn.dataset.bound){ loadMoreBtn.addEventListener('click', async ()=>{
          if (!window._visitsNextCursor) return; loadMoreBtn.disabled = true; loadMoreBtn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
          try{
            const moreUrl = buildUrl(window._visitsNextCursor);
            const r2 = await fetch(moreUrl); const j2 = await r2.json(); if (j2 && j2.ok && Array.isArray(j2.rows)){
              window._visitsAccum = window._visitsAccum.concat(j2.rows);
              window._visitsNextCursor = j2.nextCursor || null;
              if (!window._visitsNextCursor) { loadMoreBtn.style.display = 'none'; }
            }
          }catch(e){ console.warn('load more failed', e); }
          loadMoreBtn.disabled = false; loadMoreBtn.textContent = 'ë” ë¶ˆëŸ¬ì˜¤ê¸°';
          // re-render with new data
          renderFromVisitEntries(window._visitsAccum);
        }); loadMoreBtn.dataset.bound = '1'; }

        // CSV export
        if (!exportCsvBtn.dataset.bound){ exportCsvBtn.addEventListener('click', ()=>{
          const notes = collectNotesFromEntries(window._visitsAccum);
          if (!notes.length){ alert('ë‚´ë³´ë‚¼ íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
          const csvRows = [['ì¼ì','í•™êµ','ê³¼ëª©','ì„ ìƒë‹˜','íŠ¹ì´ì‚¬í•­']].concat(notes.map(r=>[r.date||'', r.school||'', r.subject||'', r.teacher||'', (r.note||'').replace(/\n/g,' ')]));
          const csv = csvRows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""') }"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'notes_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }); exportCsvBtn.dataset.bound = '1'; }

        // render
        renderFromVisitEntries(window._visitsAccum);
      }catch(e){ console.warn('loadPersonalVisits failed', e); document.getElementById('loading').textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜: ' + (e && e.message); }
      finally{ hideLoading(); document.getElementById('dashboardArea').style.display='block'; }

      // helper to collect notes array from per-entry rows
      function collectNotesFromEntries(entries){
        const out = [];
        (entries||[]).forEach(r => { const note = (r.conversation || r.conversation || '').toString().trim(); if (note) out.push({ date: r.visitDate || '', school: r.school || '', subject: r.subject || '', teacher: r.teacher || '', note }); });
        return out;
      }

      // Map helpers: create map, load precomputed geocodes and plot markers for the current user's visits
      function createPersonalMap(){
        try{
          // If Leaflet isn't available yet, bail out
          if (typeof L === 'undefined') { console.warn('Leaflet (L) is not loaded'); return null; }
          // If window.personalMap exists and looks like a Leaflet map (has setView), return it
          if (window.personalMap && typeof window.personalMap.setView === 'function') return window.personalMap;

          const map = L.map('personalMap', { preferCanvas: true }).setView([37.5665,126.9780], 10);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
          window.personalMap = map;
          try{ window.personalMarkerCluster = L.markerClusterGroup({ chunkedLoading: true }); window.personalMap.addLayer(window.personalMarkerCluster); }catch(e){ console.warn('marker cluster init failed', e); }
          // simple control to show mapped count
          try{
            const info = L.control({ position: 'topright' });
            info.onAdd = function(){ const div = L.DomUtil.create('div','small'); div.style.background = 'rgba(255,255,255,0.95)'; div.style.padding = '6px 8px'; div.style.borderRadius = '8px'; div.style.boxShadow = '0 6px 18px rgba(10,20,60,0.06)'; div.id = 'personalMapInfo'; div.innerHTML = 'ì§€ë„ ë¡œë”© ì¤‘...'; return div; };
            info.addTo(map);
          }catch(e){ console.warn('personalMapInfo control init failed', e); }
          return map;
        }catch(e){ console.warn('createPersonalMap failed', e); return null; }
      }

      async function loadGeocodes(){
        if (window._geocodeCache) return window._geocodeCache;
        try{
          const r = await fetch('/geocodes.json');
          if (!r.ok) { window._geocodeCache = {}; return window._geocodeCache; }
          const j = await r.json(); window._geocodeCache = j || {}; return window._geocodeCache;
        }catch(e){ console.warn('loadGeocodes failed', e); window._geocodeCache = {}; return window._geocodeCache; }
      }

      // Try to geocode an address with Nominatim (OpenStreetMap). Results are cached in-memory and in localStorage
      async function geocodeAddress(address){
        if (!address) return null;
        try{
          // use local cache first
          const cacheKey = 'cmass_geocode_cache_v1';
          let cache = {};
          try{ cache = JSON.parse(localStorage.getItem(cacheKey) || '{}'); }catch(e){ cache = {}; }
          if (cache[address]) return cache[address];

          // Respect polite usage: include format=json and limit=1
          const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(address + ', ëŒ€í•œë¯¼êµ­');
          const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!resp.ok) return null;
          const arr = await resp.json();
          if (!Array.isArray(arr) || !arr.length) return null;
          const one = arr[0];
          const res = { lat: Number(one.lat), lon: Number(one.lon), display_name: one.display_name };
          cache[address] = res;
          try{ localStorage.setItem(cacheKey, JSON.stringify(cache)); }catch(e){}
          return res;
        }catch(e){ console.warn('geocodeAddress failed', e); return null; }
      }

      async function updateMapFromVisits(visits){
        try{
          if (!Array.isArray(visits)) visits = window._visitsAccum || [];
          const map = createPersonalMap();
          // Defensive: if map wasn't created (Leaflet not loaded or createPersonalMap failed), bail out
          if (!map || typeof map.setView !== 'function'){
            console.warn('map not ready or createPersonalMap failed', map);
            return;
          }
          const geos = await loadGeocodes();
          if (!window.personalMarkerCluster) window.personalMarkerCluster = L.markerClusterGroup();
          window.personalMarkerCluster.clearLayers();
          const schoolSet = new Set((visits||[]).map(v => (v.school||'').trim()).filter(Boolean));
          let plotted = 0;
          const bounds = [];
          // iterate schools and attempt to plot; if coords missing try to geocode from NEIS address
          for (const school of Array.from(schoolSet)){
            let g = geos[school];
            // if no geocode entry, skip for now
            if (!g) continue;
            let lat = Number(g.lat || g.latitude || g.y || (Array.isArray(g) && g[0]));
            let lon = Number(g.lon || g.longitude || g.x || (Array.isArray(g) && g[1]));
            // If coords missing but NEIS address exists, try client geocoding and update cache
            if ((!lat || !lon || isNaN(lat) || isNaN(lon)) && g && g.neis && g.neis.ORG_RDNMA){
              try{
                const addr = (g.neis.ORG_RDNMA || '').toString().trim();
                if (addr){
                  const geo = await geocodeAddress(addr);
                  if (geo){
                    lat = Number(geo.lat); lon = Number(geo.lon);
                    // persist into geos object for this session
                    try{ g.lat = lat; g.lon = lon; geos[school] = g; window._geocodeCache = geos; }catch(e){}
                    // also try to persist into localStorage cache for quicker future loads
                    try{ const storeKey = 'cmass_geocode_cache_v1'; const ls = JSON.parse(localStorage.getItem(storeKey)||'{}'); ls[school] = { lat, lon, source: 'neis-nominatim' }; localStorage.setItem(storeKey, JSON.stringify(ls)); }catch(e){}
                  }
                }
              }catch(e){ console.warn('geocode fallback failed for', school, e); }
            }
            if (!lat || !lon || isNaN(lat) || isNaN(lon)) continue;
            const visitsForSchool = (visits||[]).filter(v=> (v.school||'').trim() === school ).slice(0,10);
            const dates = visitsForSchool.map(v=> v.visitDate || '').filter(Boolean).slice(0,5).join('<br/>');
            const safeSchool = String(school).replace(/'/g, "\\'");
            const popup = `<div style="min-width:160px"><strong>${school}</strong><div class="small">ë°©ë¬¸ ìˆ˜: ${g.count||visitsForSchool.length||1}</div><div style="margin-top:6px">ìµœê·¼:<br/>${dates||'(ê¸°ë¡ì—†ìŒ)'}</div><div style="margin-top:8px"><button class="alt-btn" onclick="(function(s){ try{ if(window.scrollToSchool) window.scrollToSchool(s); else alert('ëª©ë¡ ê¸°ëŠ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }catch(e){ console.warn(e); } })('${safeSchool}')">ëª©ë¡ì—ì„œ ë³´ê¸°</button></div></div>`;
            const marker = L.marker([lat,lon]);
            marker.bindPopup(popup);
            window.personalMarkerCluster.addLayer(marker);
            bounds.push([lat,lon]); plotted++;
          }
          if (plotted){ try{ const b = L.latLngBounds(bounds); map.fitBounds(b.pad(0.2)); }catch(e){}
            const infoEl = document.getElementById('personalMapInfo'); if (infoEl) { infoEl.innerText = 'í‘œì‹œëœ í•™êµ: ' + plotted; } else { console.warn('personalMapInfo element not found when setting plotted count'); }
          }
          else {
            const infoEl = document.getElementById('personalMapInfo'); if (infoEl) { infoEl.innerText = 'ì§€ë„ì— í‘œì‹œëœ í•™êµê°€ ì—†ìŠµë‹ˆë‹¤.'; } else { console.warn('personalMapInfo element not found when clearing plotted count'); }
            map.setView([37.5665,126.9780], 10);
          }
        }catch(e){ console.warn('updateMapFromVisits failed', e); }
      }

      // scroll helper: find notes table row for a school and scroll it into view
      function scrollToSchool(school){
        try{
          if (!school) return;
          // find notes table body
          const tbody = document.querySelector('#notesTableContainer .notes-table tbody');
          if (!tbody){ alert('ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const idx = rows.findIndex(tr => (tr.cells[1] && tr.cells[1].textContent && tr.cells[1].textContent.trim()) === school);
          if (idx === -1){ alert(school + 'ì— í•´ë‹¹í•˜ëŠ” í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
          const row = rows[idx];
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // brief highlight
          const orig = row.style.backgroundColor;
          row.style.backgroundColor = '#fff4d6';
          setTimeout(()=>{ row.style.backgroundColor = orig; }, 2000);
        }catch(e){ console.warn('scrollToSchool failed', e); }
      }

      // expose globally so other pieces can call after load
      window.updateMapFromVisits = updateMapFromVisits;

      // render logic shared with legacy renderer but adapted to per-entry items
      function renderFromVisitEntries(entries){
        try{
          // Defensive normalization: accept multiple date field names and formats
          const raw = Array.isArray(entries) ? entries.slice() : [];
          const visits = raw.map(v => {
            try{
              const copy = Object.assign({}, v);
              // prefer visitDate, then visit_date, then createdAt/created_at, then payload.visitDate
              let dateStr = copy.visitDate || copy.visit_date || copy.createdAt || copy.created_at || (copy.payload && (copy.payload.visitDate || copy.payload.visit_date || copy.payload.createdAt)) || '';
              // If createdAt/visitDate came as Firestore-like object with _seconds, handle it
              if (dateStr && typeof dateStr === 'object'){
                if (dateStr._seconds){ dateStr = new Date(Number(dateStr._seconds)*1000).toISOString(); }
                else if (dateStr.toDate && typeof dateStr.toDate === 'function'){ try{ dateStr = dateStr.toDate().toISOString(); }catch(e){ dateStr = '' } }
              }
              // If visitDate_ts exists as object with toDate(), use that
              if ((!dateStr || dateStr === '') && copy.visitDate_ts && typeof copy.visitDate_ts.toDate === 'function'){
                try{ dateStr = copy.visitDate_ts.toDate().toISOString(); }catch(e){}
              }
              copy.visitDate = dateStr || '';
              // normalize visitStart / visitEnd from multiple possible field names and timestamp shapes
              function normTimeField(val){
                if (!val && val !== 0) return '';
                // Firestore timestamp-like
                if (typeof val === 'object'){
                  if (val._seconds){ try{ return new Date(Number(val._seconds)*1000).toISOString().substring(11,16); }catch(e){} }
                  if (val.toDate && typeof val.toDate === 'function'){ try{ return val.toDate().toISOString().substring(11,16); }catch(e){} }
                }
                // strings: if ISO datetime -> extract HH:MM; if contains HH:MM -> return first match; else return trimmed
                if (typeof val === 'string'){
                  const isoMatch = val.match(/\d{4}-\d{2}-\d{2}T(\d{2}:\d{2})/);
                  if (isoMatch) return isoMatch[1];
                  const pm = val.match(/(\d{1,2}:\d{2})/);
                  if (pm) return pm[1];
                  return val.trim();
                }
                return '';
              }
              // common candidate keys for start/end
              const startCandidates = [copy.visitStart, copy.visit_start, copy.start, copy.visit_time_start, (copy.payload && (copy.payload.visitStart || copy.payload.visit_start || copy.payload.start)), copy.visitStart_ts, copy.start_ts];
              const endCandidates = [copy.visitEnd, copy.visit_end, copy.end, copy.visit_time_end, (copy.payload && (copy.payload.visitEnd || copy.payload.visit_end || copy.payload.end)), copy.visitEnd_ts, copy.end_ts];
              let sVal = '';
              for (const c of startCandidates){ const n = normTimeField(c); if (n) { sVal = n; break; } }
              let eVal = '';
              for (const c of endCandidates){ const n = normTimeField(c); if (n) { eVal = n; break; } }
              // if we found ISO visitDate and start/end are HH:MM, prefer to store full ISO local-ish datetimes? Keep as HH:MM for display/parse
              copy.visitStart = sVal || '';
              copy.visitEnd = eVal || '';
              return copy;
            }catch(e){ return v; }
          });

          // sort by visitDate (newest first). Fallback to createdAt if missing.
          visits.sort((a,b)=>{
            const ad = a.visitDate || a.createdAt || '';
            const bd = b.visitDate || b.createdAt || '';
            const at = ad ? new Date(ad).getTime() : 0;
            const bt = bd ? new Date(bd).getTime() : 0;
            return bt - at;
          });
          document.getElementById('totalVisits').textContent = visits.length;
          const uniq = Array.from(new Set(visits.map(m=> (m.school||'').toString().trim() ).filter(Boolean)));
          document.getElementById('uniqueSchools').textContent = uniq.length;
          // recentDate: show the most recent visit date in readable YYYY-MM-DD
          const recentShown = visits.length ? (visits[0].visitDate || visits[0].createdAt || '-') : '-';
          document.getElementById('recentDate').textContent = recentShown ? (recentShown.substring(0,10)) : '-';

          // small helper: show placeholder when chart has no data
          function setChartVisibility(canvasId, hasData, message){
            const c = document.getElementById(canvasId);
            if (!c) return;
            let ph = document.getElementById(canvasId + '_placeholder');
            if (!ph){ ph = document.createElement('div'); ph.id = canvasId + '_placeholder'; ph.className = 'small'; ph.style.padding = '.8rem'; ph.style.color = 'var(--muted)'; ph.style.minHeight = '60px'; c.parentNode.insertBefore(ph, c.nextSibling); }
            if (!hasData){ c.style.display = 'none'; ph.style.display = ''; ph.textContent = message || 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'; }
            else { c.style.display = ''; ph.style.display = 'none'; }
          }

          // schools chart removed per user request

          // build school buttons and per-school visits table + subject quick-filter
          const buttonsEl = document.getElementById('schoolButtons');
          const subjectBtnsEl = document.getElementById('subjectButtons');
          const tableCont = document.getElementById('schoolVisitsTableContainer');
          // standard subject list (includes 'ë„ì„œê´€ì‚¬ì„œ' and ê¸°íƒ€)
          const standardSubjects = ['ì •ë³´','ì§„ë¡œ','ë³´ê±´','ë¯¸ìˆ ','ì²´ìœ¡','ë„ì„œê´€ì‚¬ì„œ','íŠ¹ì„±í™”','ê¸°íƒ€'];
          let currentSchool = null;
          let currentSubject = '';
          let currentDate = '';

          // build school buttons with counts
          const schoolCounts = {};
          visits.forEach(v => { const s = (v.school||'').toString().trim(); if (!s) return; schoolCounts[s] = (schoolCounts[s]||0) + 1; });
          if (buttonsEl) {
            buttonsEl.innerHTML = '';
            const allBtn = document.createElement('button'); allBtn.className='alt-btn'; allBtn.textContent = 'ì „ì²´'; allBtn.dataset.school = ''; allBtn.onclick = ()=>{ currentSchool = null; renderSchoolVisits(null, currentSubject, currentDate); };
            buttonsEl.appendChild(allBtn);
            uniq.forEach(sch => {
              const cnt = schoolCounts[sch] || 0;
              const b = document.createElement('button'); b.className = 'alt-btn'; b.textContent = `${sch}(${cnt})`; b.dataset.school = sch; b.onclick = ()=>{ currentSchool = sch; renderSchoolVisits(sch, currentSubject, currentDate); };
              buttonsEl.appendChild(b);
            });
          }

          // render subject quick-buttons (show counts per subject)
          if (subjectBtnsEl){
            subjectBtnsEl.innerHTML = '';
            // compute counts for subjects (including ê¸°íƒ€)
            const subjCountsMap = {};
            visits.forEach(v => { const key = (v.subject || 'ë¯¸ì§€ì •').toString().trim() || 'ë¯¸ì§€ì •'; subjCountsMap[key] = (subjCountsMap[key]||0) + 1; });
            const allS = document.createElement('button'); allS.className = 'alt-btn'; allS.textContent = 'ì „ì²´'; allS.dataset.subject = ''; allS.onclick = ()=>{ currentSubject=''; renderSchoolVisits(currentSchool, currentSubject, currentDate); };
            subjectBtnsEl.appendChild(allS);
            standardSubjects.forEach(sb => {
              const cnt = subjCountsMap[sb] || 0;
              const btn = document.createElement('button'); btn.className='alt-btn'; btn.textContent = `${sb}(${cnt})`; btn.dataset.subject = sb; btn.onclick = ()=>{ currentSubject = sb; renderSchoolVisits(currentSchool, currentSubject, currentDate); };
              subjectBtnsEl.appendChild(btn);
            });
            // also add ê¸°íƒ€ count for non-standard subjects â€” avoid duplicating if 'ê¸°íƒ€' is already a standard subject
            const otherCount = Object.keys(subjCountsMap).reduce((acc,k)=> acc + ((standardSubjects.indexOf(k)===-1)? subjCountsMap[k]:0), 0);
            if (standardSubjects.indexOf('ê¸°íƒ€') === -1) {
              const ê¸°íƒ€Btn = document.createElement('button');
              ê¸°íƒ€Btn.className='alt-btn';
              ê¸°íƒ€Btn.textContent = `ê¸°íƒ€(${otherCount})`;
              ê¸°íƒ€Btn.dataset.subject = 'ê¸°íƒ€';
              ê¸°íƒ€Btn.onclick = ()=>{ currentSubject = 'ê¸°íƒ€'; renderSchoolVisits(currentSchool, currentSubject, currentDate); };
              subjectBtnsEl.appendChild(ê¸°íƒ€Btn);
            } else {
              // If 'ê¸°íƒ€' already exists in the standardSubjects buttons, update its label to include otherCount
              try {
                const existing = Array.from(subjectBtnsEl.querySelectorAll('button')).find(b => b.dataset && b.dataset.subject === 'ê¸°íƒ€');
                if (existing) {
                  const baseCount = subjCountsMap['ê¸°íƒ€'] || 0;
                  const total = baseCount + (otherCount || 0);
                  existing.textContent = `ê¸°íƒ€(${total})`;
                }
              } catch(e) { /* ignore */ }
            }
          }

          // helper: update charts based on filtered rows
          function updateCharts(rows){
            // subjects distribution
            const subjCounts = {}; rows.forEach(v=>{ const key = (v.subject || 'ë¯¸ì§€ì •').toString().trim() || 'ë¯¸ì§€ì •'; subjCounts[key] = (subjCounts[key]||0) + 1; });
            const subjLabels = Object.keys(subjCounts).sort((a,b)=>subjCounts[b]-subjCounts[a]).slice(0,8);
            const subjData = subjLabels.map(l=>subjCounts[l]);
            setChartVisibility('subjectsChart', subjLabels.length>0, 'ê³¼ëª© ë¶„í¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            if (subjLabels.length>0){
              const sctx = document.getElementById('subjectsChart').getContext('2d');
              try { if (window._subjectsChart && typeof window._subjectsChart.destroy === 'function') window._subjectsChart.destroy(); } catch(e){}
              const subjTotal = subjData.reduce((a,b)=>a+(b||0),0) || 1;
              const subjLabelsPct = subjLabels.map((l,i)=> `${l} ${Math.round(((subjData[i]||0)/subjTotal)*100)}%`);
              window._subjectsChart = new Chart(sctx, {
                type: 'doughnut', data: { labels: subjLabelsPct, datasets:[{ data: subjData, backgroundColor: ['#6b8bff','#8ec3ff','#a7bfff','#f6c07b','#c7d8ff','#b0e0d3','#ffd1e0','#d9c8ff'] }] },
                options: { responsive:true, maintainAspectRatio:false, cutout: '40%', plugins:{ legend:{ display:true, position:'right', align:'start', labels:{ boxWidth:12, padding:6 } }, tooltip:{ callbacks:{ label: function(ctx){ const v = ctx.parsed; const pct = Math.round((v/subjTotal)*100); return ctx.label + ': ' + v + ' (' + pct + '%)'; } } } }, layout: { padding: { right: 8 } } }
              });
            }

            // monthly timeline
            const monthCounts = {}; const pad = n => n<10? '0'+n : ''+n;
            rows.forEach(v=>{ const d = v.visitDate ? new Date(v.visitDate) : null; if (!d || isNaN(d.getTime())) return; const key = d.getFullYear() + '-' + pad(d.getMonth()+1); monthCounts[key] = (monthCounts[key]||0) + 1; });
            const now = new Date(); const months = []; for (let i=11;i>=0;i--){ const dt = new Date(now.getFullYear(), now.getMonth()-i, 1); months.push(dt.getFullYear()+'-'+pad(dt.getMonth()+1)); }
            const monthData = months.map(m => monthCounts[m]||0);
            setChartVisibility('monthlyChart', monthData.some(n=>n>0), 'ì›”ë³„ ë°©ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            if (monthData.some(n=>n>0)){
              const mctx = document.getElementById('monthlyChart').getContext('2d');
              try { if (window._monthlyChart && typeof window._monthlyChart.destroy === 'function') window._monthlyChart.destroy(); } catch(e){}
              window._monthlyChart = new Chart(mctx, {
                type: 'line',
                data: {
                  labels: months,
                  datasets: [{ label: 'ë°©ë¬¸ìˆ˜', data: monthData, fill: true, backgroundColor: 'rgba(107,139,255,0.18)', borderColor: '#6b8bff', tension: 0.3 }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false },
                    tooltip: { titleFont: { size: 14 }, bodyFont: { size: 13 } }
                  },
                  scales: {
                    x: { ticks: { color: '#334', font: { size: 13 } }, grid: { display: false } },
                    y: { ticks: { color: '#334', font: { size: 13 }, beginAtZero: true }, grid: { color: 'rgba(200,210,230,0.6)' } }
                  },
                  elements: { point: { radius: 4 } }
                }
              });
            }

            // actions distribution
            const actionCounts = {};
            rows.forEach(v => { (v.meetings||[]).forEach(m => { const key = (m||'').trim(); if (!key) return; actionCounts[key] = (actionCounts[key]||0)+1; }); });
            const labels = Object.keys(actionCounts).sort((a,b)=>actionCounts[b]-actionCounts[a]);
            const data = labels.map(l=>actionCounts[l]);
            setChartVisibility('actionsChart', labels.length>0, 'í–‰ë™ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            if (labels.length>0){ const actCtx = document.getElementById('actionsChart').getContext('2d'); try { if (window._actionsChart && typeof window._actionsChart.destroy === 'function') window._actionsChart.destroy(); } catch(e){} window._actionsChart = new Chart(actCtx, { type:'bar', data:{ labels, datasets:[{ label:'í–‰ë™ìˆ˜', data, backgroundColor:'#8ec3ff' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } }); }

            // small pie for actions (positive-only)
            try{
              const positiveLabels = []; const positiveData = []; const positiveBg = []; const bgPalette = ['#6b8bff','#8ec3ff','#a7bfff','#f6c07b','#c7d8ff','#b0e0d3','#ffd1e0','#d9c8ff'];
              for (let i=0;i<labels.length;i++){ if ((data[i]||0) > 0){ positiveLabels.push(labels[i]); positiveData.push(data[i]); positiveBg.push(bgPalette[i%bgPalette.length]); } }
              setChartVisibility('actionsPieChart', positiveLabels.length>0, 'ì˜ì—…í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
              if (positiveLabels.length>0){ const apCtx = document.getElementById('actionsPieChart').getContext('2d'); try{ if (window._actionsPieChart && typeof window._actionsPieChart.destroy === 'function') window._actionsPieChart.destroy(); }catch(e){}
                const actionTotal = positiveData.reduce((a,b)=>a+(b||0),0) || 1;
                const labelsPct = positiveLabels.map((l,i)=> `${l} ${Math.round(((positiveData[i]||0)/actionTotal)*100)}%`);
                window._actionsPieChart = new Chart(apCtx, { type: 'doughnut', data: { labels: labelsPct, datasets: [{ data: positiveData, backgroundColor: positiveBg }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '40%', plugins: { legend: { display:true, position:'right', align:'start', labels:{ boxWidth:12, padding:6 } }, tooltip: { callbacks: { label: function(ctx){ const v = ctx.parsed; const pct = Math.round((v/actionTotal)*100); return ctx.label + ': ' + v + ' (' + pct + '%)'; } } } }, layout: { padding: { right: 8 } } } });
              }
            }catch(e){ console.warn('renderActionsPie failed', e); }
          }

          // build date buttons (unique visit dates) with counts
          try{
            const dateBtnEl = document.getElementById('dateButtons');
            if (dateBtnEl){
              // collect dates (YYYY-MM-DD) and counts
              const dateCounts = {};
              visits.forEach(v => { const d = (v.visitDate || v.createdAt || '').toString().substring(0,10); if (!d) return; dateCounts[d] = (dateCounts[d]||0) + 1; });
              const dates = Object.keys(dateCounts).sort((a,b)=> (a<b?1:-1)); // descending
              dateBtnEl.innerHTML = '';
              const allD = document.createElement('button'); allD.className='alt-btn'; allD.textContent = 'ì „ì²´'; allD.dataset.date = ''; allD.onclick = ()=>{ currentDate = ''; renderSchoolVisits(currentSchool, currentSubject, currentDate); };
              dateBtnEl.appendChild(allD);
              dates.forEach(dt => { const btn = document.createElement('button'); btn.className='alt-btn'; btn.textContent = `${dt}(${dateCounts[dt]||0})`; btn.dataset.date = dt; btn.onclick = ()=>{ currentDate = dt; renderSchoolVisits(currentSchool, currentSubject, currentDate); }; dateBtnEl.appendChild(btn); });
            }
          }catch(e){ console.warn('date buttons render failed', e); }

          function renderSchoolVisits(school, subject, dateFilter){
            // highlight active school button
            try{
              if (buttonsEl){ Array.from(buttonsEl.querySelectorAll('button')).forEach(btn => {
                try{
                  const bs = btn.dataset && btn.dataset.school !== undefined ? btn.dataset.school : '';
                  if ((school === null && bs === '') || (school !== null && bs === school)) {
                    btn.style.background = '#dfeaff'; btn.style.border = '1px solid #a7c2ff'; btn.style.color = '#0b2b5a';
                  } else { btn.style.background = ''; btn.style.border = ''; btn.style.color = ''; }
                }catch(e){}
              }); }
            }catch(e){}
            // highlight active subject button
            try{
              if (subjectBtnsEl){ Array.from(subjectBtnsEl.querySelectorAll('button')).forEach(btn => {
                try{ const bs = btn.dataset && btn.dataset.subject !== undefined ? btn.dataset.subject : ''; if ((subject === '' && bs === '') || (subject !== '' && bs === subject)) { btn.style.background = '#dfeaff'; btn.style.border = '1px solid #a7c2ff'; btn.style.color = '#0b2b5a'; } else { btn.style.background = ''; btn.style.border = ''; btn.style.color = ''; } }catch(e){}
              }); }
            }catch(e){}
            // highlight active date button
            try{
              const dateEl = document.getElementById('dateButtons');
              if (dateEl){ Array.from(dateEl.querySelectorAll('button')).forEach(btn => { try{ const d = btn.dataset && btn.dataset.date !== undefined ? btn.dataset.date : ''; if ((dateFilter === '' && d === '') || (dateFilter && d === dateFilter)) { btn.style.background = '#dfeaff'; btn.style.border = '1px solid #a7c2ff'; btn.style.color = '#0b2b5a'; } else { btn.style.background=''; btn.style.border=''; btn.style.color=''; } }catch(e){} }); }
            }catch(e){}

            if (!tableCont) return;
            tableCont.innerHTML = '';
            let rows = school ? visits.filter(v=> (v.school||'').toString().trim() === school) : visits.slice();
            // apply date filter if provided (YYYY-MM-DD)
            if (dateFilter && dateFilter !== ''){
              rows = rows.filter(v => { const d = (v.visitDate || v.createdAt || '').toString().substring(0,10); return d === dateFilter; });
            }
            // apply subject filter if provided
            if (subject && subject !== ''){
              if (subject === 'ê¸°íƒ€'){
                rows = rows.filter(r => { const s = (r.subject||'').toString().trim(); return !standardSubjects.includes(s) || s === '' || s === 'ê¸°íƒ€'; });
              } else {
                rows = rows.filter(r => ((r.subject||'').toString().trim()) === subject);
              }
            }
            if (!rows.length){ tableCont.innerHTML = '<div class="small">í•´ë‹¹ ì¡°ê±´ì˜ ë°©ë¬¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            const t = document.createElement('table'); t.className = 'notes-table';
            const th = document.createElement('thead'); th.innerHTML = '<tr><th>ë°©ë¬¸ì¼</th><th>í•™êµ</th><th>ë°©ë¬¸ì‹œê°„</th><th>ì„ ìƒë‹˜ëª…</th><th>ê³¼ëª©ëª…</th><th>ì˜ì—…í™œë™</th><th>íŠ¹ì´ì‚¬í•­</th></tr>'; t.appendChild(th);
            const tb = document.createElement('tbody');
            rows.forEach(r=>{
              const date = r.visitDate ? (r.visitDate.substring(0,19).replace('T',' ')) : (r.createdAt && typeof r.createdAt === 'string' ? r.createdAt.substring(0,19).replace('T',' ') : '');
              const visitDateOnly = r.visitDate ? (r.visitDate.substring(0,10)) : (r.createdAt && typeof r.createdAt === 'string' ? r.createdAt.substring(0,10) : '');
              let timeDisplay = '-';
              if (r.durationMinutes) timeDisplay = String(r.durationMinutes) + 'ë¶„';
              else if (r.visitStart && r.visitEnd) timeDisplay = (r.visitStart||'') + ' - ' + (r.visitEnd||'');
              const teacher = r.teacher || '';
              const subjectVal = r.subject || '';
              const activity = Array.isArray(r.meetings) ? r.meetings.join(', ') : (r.meetings || r.activity || '');
              const note = (r.conversation || r.note || '').toString().replace(/</g,'&lt;');
              const tr = document.createElement('tr');
              const schoolCell = (r.school || '').toString().replace(/</g,'&lt;');
              tr.innerHTML = `<td>${visitDateOnly}</td><td>${schoolCell}</td><td>${timeDisplay}</td><td>${teacher}</td><td>${subjectVal}</td><td>${activity}</td><td>${note}</td>`;
              tb.appendChild(tr);
            });
            t.appendChild(tb);
            // place table directly; tableCont is the scroll container so sticky headers work relative to it
            const wrapper = document.createElement('div'); wrapper.style.width='100%'; wrapper.style.overflow='visible'; wrapper.appendChild(t);
            tableCont.appendChild(wrapper);
            // update charts to reflect the currently displayed rows (subjects/actions/monthly)
            try{ if (typeof updateCharts === 'function') updateCharts(rows); } catch(e){ console.warn('updateCharts failed', e); }
            // update keyword extraction for the currently displayed rows (per-school / per-subject)
            try{ if (typeof updateKeywords === 'function') updateKeywords(rows); } catch(e){ console.warn('updateKeywords failed', e); }
          }
          // show all by default
          try{ renderSchoolVisits(null, '', currentDate); }catch(e){}
          // initialize charts and keywords with full dataset
          try{ if (typeof updateCharts === 'function') updateCharts(visits); }catch(e){}
          try{ if (typeof updateKeywords === 'function') updateKeywords(visits); }catch(e){}

          // subjects distribution
          const subjCounts = {};
          visits.forEach(v => { const key = (v.subject || 'ë¯¸ì§€ì •').trim(); if (!key) return; subjCounts[key] = (subjCounts[key]||0) + 1; });
          const subjLabels = Object.keys(subjCounts).sort((a,b)=>subjCounts[b]-subjCounts[a]).slice(0,8);
          const subjData = subjLabels.map(l=>subjCounts[l]);
          setChartVisibility('subjectsChart', subjLabels.length>0, 'ê³¼ëª© ë¶„í¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          if (subjLabels.length>0){
            const sctx = document.getElementById('subjectsChart').getContext('2d');
            try { if (window._subjectsChart && typeof window._subjectsChart.destroy === 'function') window._subjectsChart.destroy(); } catch(e){}
            // compute percentage labels so they are visible alongside legend
            const subjTotal = subjData.reduce((a,b)=>a+(b||0),0) || 1;
            const subjLabelsPct = subjLabels.map((l,i)=> `${l} ${Math.round(((subjData[i]||0)/subjTotal)*100)}%`);
            window._subjectsChart = new Chart(sctx, {
              type: 'doughnut',
              data: { labels: subjLabelsPct, datasets:[{ data: subjData, backgroundColor: ['#6b8bff','#8ec3ff','#a7bfff','#f6c07b','#c7d8ff','#b0e0d3','#ffd1e0','#d9c8ff'] }] },
              options: {
                responsive:true,
                maintainAspectRatio:false,
                cutout: '40%',
                plugins:{
                  // place legend vertically on the right so entries read top->bottom
                  legend:{ display:true, position:'right', align:'start', labels:{ boxWidth:12, padding:6 } },
                  tooltip:{ callbacks:{ label: function(ctx){ const v = ctx.parsed; const pct = Math.round((v/subjTotal)*100); return ctx.label + ': ' + v + ' (' + pct + '%)'; } } }
                },
                layout: { padding: { right: 8 } }
              }
            });
          }

          // monthly timeline
          const monthCounts = {}; const pad = n => n<10? '0'+n : ''+n;
          visits.forEach(v=>{ const d = v.visitDate ? new Date(v.visitDate) : null; if (!d || isNaN(d.getTime())) return; const key = d.getFullYear() + '-' + pad(d.getMonth()+1); monthCounts[key] = (monthCounts[key]||0) + 1; });
          const now = new Date(); const months = []; for (let i=11;i>=0;i--){ const dt = new Date(now.getFullYear(), now.getMonth()-i, 1); months.push(dt.getFullYear()+'-'+pad(dt.getMonth()+1)); }
          const monthData = months.map(m => monthCounts[m]||0);
          setChartVisibility('monthlyChart', monthData.some(n=>n>0), 'ì›”ë³„ ë°©ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          if (monthData.some(n=>n>0)){
            const mctx = document.getElementById('monthlyChart').getContext('2d');
            try { if (window._monthlyChart && typeof window._monthlyChart.destroy === 'function') window._monthlyChart.destroy(); } catch(e){}
            window._monthlyChart = new Chart(mctx, {
              type: 'line',
              data: {
                labels: months,
                datasets: [{ label: 'ë°©ë¬¸ìˆ˜', data: monthData, fill: true, backgroundColor: 'rgba(107,139,255,0.18)', borderColor: '#6b8bff', tension: 0.3 }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: { titleFont: { size: 14 }, bodyFont: { size: 13 } }
                },
                scales: {
                  x: { ticks: { color: '#334', font: { size: 13 } }, grid: { display: false } },
                  y: { ticks: { color: '#334', font: { size: 13 }, beginAtZero: true }, grid: { color: 'rgba(200,210,230,0.6)' } }
                },
                elements: { point: { radius: 4 } }
              }
            });
          }

          // actions
          const actionCounts = {};
          visits.forEach(v => { (v.meetings||[]).forEach(m => { const key = (m||'').trim(); if (!key) return; actionCounts[key] = (actionCounts[key]||0)+1; }); });
          const likelyActions = ['ëª…í•¨ì¸ì‚¬','í‹°ì¹­ìƒ˜ì†Œê°œ','ì±„íŒ…ë°©ì†Œê°œ','ë‹¨í–‰ë³¸ì•ˆë‚´','ìº í”„ì•ˆë‚´','êµ¬ê¸€í´ë˜ìŠ¤ë£¸ ì‚¬ìš©','íŒ¨ë“¤ë › ì‚¬ìš©','í•˜ì´ëŸ¬ë‹ ì‚¬ìš©','ë¯¸íŒ…ë¶ˆê°€'];
          likelyActions.forEach(k => { if (!actionCounts[k]) actionCounts[k] = 0; });
          try{ const labels = Object.keys(actionCounts).sort((a,b)=>actionCounts[b]-actionCounts[a]); const data = labels.map(l=>actionCounts[l]);
            // existing bar chart (kept) for detailed action counts
            setChartVisibility('actionsChart', labels.length>0, 'í–‰ë™ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            if (labels.length>0){ const actCtx = document.getElementById('actionsChart').getContext('2d'); try { if (window._actionsChart && typeof window._actionsChart.destroy === 'function') window._actionsChart.destroy(); } catch(e){} window._actionsChart = new Chart(actCtx, { type:'bar', data:{ labels, datasets:[{ label:'í–‰ë™ìˆ˜', data, backgroundColor:'#8ec3ff' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } }); }

            // render a compact pie chart in the 'ê³¼ëª© ë¶„í¬' area for quick glance at ì˜ì—…í™œë™ ë¶„í¬
            try{
              // filter out zero-count items so 0% doesn't appear in the pie legend
              const positiveLabels = [];
              const positiveData = [];
              const positiveBg = [];
              const bgPalette = ['#6b8bff','#8ec3ff','#a7bfff','#f6c07b','#c7d8ff','#b0e0d3','#ffd1e0','#d9c8ff'];
              for (let i=0;i<labels.length;i++){
                if ((data[i]||0) > 0){ positiveLabels.push(labels[i]); positiveData.push(data[i]); positiveBg.push(bgPalette[i%bgPalette.length]); }
              }
              setChartVisibility('actionsPieChart', positiveLabels.length>0, 'ì˜ì—…í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
              if (positiveLabels.length>0){ const apCtx = document.getElementById('actionsPieChart').getContext('2d'); try{ if (window._actionsPieChart && typeof window._actionsPieChart.destroy === 'function') window._actionsPieChart.destroy(); }catch(e){}
                // compute label percentages for clearer display using only positive data
                const actionTotal = positiveData.reduce((a,b)=>a+(b||0),0) || 1;
                const labelsPct = positiveLabels.map((l,i)=> `${l} ${Math.round(((positiveData[i]||0)/actionTotal)*100)}%`);
                try{
                  window._actionsPieChart = new Chart(apCtx, {
                    type: 'doughnut',
                    data: {
                      labels: labelsPct,
                      datasets: [{ data: positiveData, backgroundColor: positiveBg }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      cutout: '40%',
                      plugins: {
                        // vertical legend on the right; data is already sorted desc so top shows highest percent
                        legend: { display:true, position:'right', align:'start', labels:{ boxWidth:12, padding:6 } },
                        tooltip: { callbacks: { label: function(ctx){ const v = ctx.parsed; const pct = Math.round((v/actionTotal)*100); return ctx.label + ': ' + v + ' (' + pct + '%)'; } } }
                      },
                      layout: { padding: { right: 8 } }
                    }
                  });
                }catch(e){ console.warn('actionsPieChart render failed', e); }
              }
            }catch(e){ console.warn('renderActionsPie failed', e); }
          }catch(e){ console.warn('renderActions failed', e); }

          // notes table + keywords (use server-side /api/keywords for better tokenization)
          // build notesRows from visits (full set). We'll expose a function updateKeywords(rows) to refresh keywords for a filtered subset.
          const notesRows = [];
          visits.forEach(v => { const date = v.visitDate || ''; const school = v.school || ''; const subj = v.subject || ''; const teacher = v.teacher || ''; const note = (v.conversation || v.note || '').toString().trim(); if (note) notesRows.push({ date, school, subject: subj, teacher, note }); });
          (function renderNotesTable(){ const cont = document.getElementById('notesTableContainer'); if (!cont) return; cont.innerHTML = ''; if (!notesRows.length){ cont.innerHTML = '<div class="small">íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } const tbl = document.createElement('table'); tbl.className = 'notes-table'; const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>ì¼ì</th><th>í•™êµ</th><th>ê³¼ëª©</th><th>ì„ ìƒë‹˜</th><th>íŠ¹ì´ì‚¬í•­</th></tr>'; tbl.appendChild(thead); const tbody = document.createElement('tbody'); notesRows.forEach(r => { const tr = document.createElement('tr'); const safeNote = (r.note||'').replace(/</g,'&lt;').replace(/\n/g,'\n'); tr.innerHTML = `<td>${r.date||''}</td><td>${r.school||''}</td><td>${r.subject||''}</td><td>${r.teacher||''}</td><td class="note-cell">${safeNote}</td>`; tbody.appendChild(tr); }); tbl.appendChild(tbody); // wrap table in a scrollable wrapper for better mobile handling
            const wrapper = document.createElement('div'); wrapper.style.width='100%'; wrapper.style.overflow='auto'; wrapper.appendChild(tbl); cont.appendChild(wrapper); })();

          // server-side keyword extraction helper for a given set of rows
          async function updateKeywords(rows){ try{ const texts = (rows || []).map(r=> (r.conversation||r.note||'')).filter(Boolean); const el = document.getElementById('noteKeywords'); if (!el) return; if (!texts.length){ el.innerHTML = '<div class="small">íŠ¹ì´ì‚¬í•­ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } const r = await fetch('/api/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ texts, topN: 30 }) }); const j = await r.json(); if (j && j.ok && Array.isArray(j.keywords) && j.keywords.length){ el.innerHTML = ''; j.keywords.slice(0,30).forEach(it => { const span = document.createElement('span'); span.textContent = it.token + ' Â· ' + it.count; span.style.display = 'inline-block'; span.style.margin = '4px 6px'; span.style.padding = '6px 8px'; span.style.borderRadius = '12px'; span.style.background = '#eef5ff'; span.style.fontSize = '13px'; el.appendChild(span); }); } else { el.innerHTML = '<div class="small">íŠ¹ì´ì‚¬í•­ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; } }catch(e){ console.warn('keyword fetch failed', e); } }

          // topTeachers section removed by request â€” no UI render for top teachers

          // follow-up summary
          const followCounts = {};
          visits.forEach(v=>{ const key = (v.followUp || '').trim() || 'ë¯¸ì§€ì •'; followCounts[key] = (followCounts[key]||0) + 1; });
          const fsum = document.getElementById('followUpSummary'); fsum.innerHTML=''; const fkeys = Object.keys(followCounts).sort((a,b)=>followCounts[b]-followCounts[a]); if (!fkeys.length) fsum.innerHTML = '<div class="small">í›„ì† ì¡°ì¹˜ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤ã€‚</div>'; else { const ul = document.createElement('div'); ul.style.display='grid'; ul.style.gap='.3rem'; fkeys.forEach(k=>{ const r = document.createElement('div'); r.textContent = k + ' Â· ' + followCounts[k]; r.style.padding='.25rem .3rem'; r.style.border='1px solid #eef2ff'; r.style.borderRadius='6px'; ul.appendChild(r); }); fsum.appendChild(ul); }

          // total duration and average per school (best-effort from entry-level duration fields)
          let totalDur = 0, durCount = 0;
          // helper to extract minutes from various possible formats
          function parseMinutes(v){
            if (v == null) return null;
            // numeric already
            if (typeof v === 'number' && !isNaN(v)) return Math.round(v);
            if (typeof v === 'string'){
              // common forms: "30", "30ë¶„", "30 min", "ì•½ 30ë¶„"
              const m = v.match(/(\d+)\s*(ë¶„|m|min)?/i);
              if (m && m[1]) return Number(m[1]);
              // fallback: remove non-digits
              const digits = v.replace(/[^0-9]/g,'');
              if (digits) return Number(digits);
            }
            return null;
          }
          visits.forEach(v=>{
            // try explicit minute fields first
            const candidates = [v.durationMinutes, v.visitDuration, v.duration, v.minutes, v.minute];
            let found = null;
            for (const c of candidates){ const m = parseMinutes(c); if (m != null){ found = m; break; } }
            if (found != null){ totalDur += found; durCount++; return; }

            // if no explicit duration, try deriving from start/end pairs
            let start = v.visitStart || v.start || v.visit_time_start || '';
            let end = v.visitEnd || v.end || v.visit_time_end || '';
            // some records use a combined "09:00 - 09:30" in a single field
            if ((!start || !end) && v.visitTime && typeof v.visitTime === 'string'){
              const parts = v.visitTime.split(/[-~â€“â€”]/).map(s=>s.trim()); if (parts.length>=2){ start = parts[0]; end = parts[1]; }
            }
            if (start && end){
              try{
                // normalize ISO datetimes to HH:MM by extracting time portion
                const norm = s => { if (!s) return ''; if (/\d{4}-\d{2}-\d{2}T/.test(s)) return s.substring(11,16); const p = s.match(/(\d{1,2}:\d{2})/); return p ? p[1] : s; };
                const sStr = norm(String(start)); const eStr = norm(String(end));
                const [sh, sm] = sStr.split(':').map(x=>parseInt(x,10)||0);
                const [eh, em] = eStr.split(':').map(x=>parseInt(x,10)||0);
                const sMin = sh*60 + sm; const eMin = eh*60 + em; let diff = eMin - sMin; if (diff < 0) diff += 24*60; if (!isNaN(diff) && diff > 0){ totalDur += diff; durCount++; }
              }catch(_){ }
            }
          });
          // total time spent at schools (minutes)
          const totalTimeDisplay = totalDur ? String(Math.round(totalDur)) : '-';
          const totalTimeEl = document.getElementById('totalTime'); if (totalTimeEl) totalTimeEl.textContent = totalTimeDisplay;
          // average per-school = total time divided by unique school count
          const avgPerSchool = (uniq.length && totalDur) ? Math.round(totalDur / uniq.length) : '-';
          document.getElementById('avgDuration').textContent = avgPerSchool;

          // contacts
          const contacts = new Set(); visits.forEach(v=>{ const c = (v.contact||'').replace(/\D+/g,''); if (c) contacts.add(c); }); document.getElementById('contactsCount').textContent = contacts.size;
          document.getElementById('followUpsCount').textContent = Object.values(followCounts).reduce((a,b)=>a+b,0) || 0;
          // update personal map with current visits (if geocodes available)
          try{ if (window.updateMapFromVisits) window.updateMapFromVisits(visits); }catch(e){ /* ignore */ }
        }catch(e){ console.warn('renderFromVisitEntries failed', e); }
      }
    }

    window.addEventListener('DOMContentLoaded', loadPersonalVisits);
  </script>


</body>