<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e3c72">
  <title>영업일지 입력</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* Reset & layout */
    body {
      background: #f5f6fa;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #111;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      -webkit-font-smoothing:antialiased;
      font-size: 16px; /* base size increased for readability */
    }
    h2 { font-size: 2.2rem; margin: 2rem 0 1rem 0; font-weight: 800; color:#0b2b5a }

    form {
      width: 95vw;
      border-radius: 1.2rem;
      box-shadow: 0 10px 30px rgba(14,30,80,0.08);
      padding: 1.6rem 1.8rem;
      margin-bottom: 2rem;
    }

    label { display:block; font-weight:700; margin-top:1rem; color:#333; }

  input, select, textarea { width:100%; padding:0.95rem; border-radius:0.9rem; border:1px solid #d6dbe8; box-sizing:border-box; font-size:1rem; }

    /* subject/activity buttons */
    .subjects { display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem; }
  .subject-btn { flex:1 1 45%; min-width:130px; padding:1.05rem; font-size:1.08rem; border-radius:1rem; border:none; background:#e9eefc; color:#12325a; font-weight:800; cursor:pointer }
  .subject-btn.selected { background:#12325a; color:#fff; box-shadow:0 6px 18px rgba(18,50,90,0.14); }

    /* region / school button grid: desktop 3 cols, medium 2, small 1 */
  .btn-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:0.7rem; margin-top:0.6rem; margin-bottom:1rem; }
  .grid-button { padding:1.05rem 1rem; font-size:1.05rem; border-radius:1rem; border:1px solid #cfd9ff; background:#fff; color:#133257; cursor:pointer; text-align:center; white-space:normal; overflow-wrap:anywhere; word-break:keep-all; min-height:56px; line-height:1.3 }
  .grid-button:hover { background:#f5f7ff; transform:translateY(-2px); box-shadow:0 8px 22px rgba(20,40,80,0.06); }
  .grid-button.selected { background:#0b2b5a; color:#fff; border-color:#071a36; box-shadow:0 12px 30px rgba(11,43,90,0.18); font-weight:900 }

    .btn-submit, .btn-report { width:100%; padding:1.2rem; font-size:1.2rem; border-radius:1rem; border:none; background:#1e3c72; color:#fff; font-weight:700; cursor:pointer }
    .btn-report { background:#ff9800; margin-top:0.5rem }

    /* school metadata card styles (inline and step2) - more prominent */
    #schoolMetaInline, #schoolMeta {
      display:none;
      padding:22px 20px;
      border-radius:14px;
      background:linear-gradient(180deg,#ffffff 0%, #f7f8ff 100%);
      border:1px solid #e2e8ff;
      box-shadow:0 18px 48px rgba(10,28,64,0.12);
      color:#071a2e;
      font-size:16.5px;
      line-height:1.6;
      margin-top:1rem;
      position:relative;
      overflow:visible;
    }
    /* accent stripe on the left (wider for better affordance) */
    #schoolMetaInline::before, #schoolMeta::before {
      content: '';
      position: absolute;
      left: 0;
      top: 8px;
      bottom: 8px;
      width: 10px;
      border-radius: 8px;
      background: linear-gradient(180deg,#556ee8,#6b4bb0);
      box-shadow: 0 4px 14px rgba(80,90,160,0.08);
    }
  #schoolMetaInline h4, #schoolMeta h4 { margin:0 0 .6rem 18px; font-size:19px; color:#06203f; font-weight:900 }
  .grade-rows { display:block; margin-top:12px; }
  /* turn each grade row into two columns: label / values -- values emphasized */
  .grade-row { display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center; margin:8px 0; }
  .grade-row .grade-label { font-weight:900; color:#0d304f; font-size:15px }
  .grade-row .grade-value { color:#072042; font-size:15px; display:flex; gap:8px; align-items:baseline }
  /* highlight numeric values much larger */
  .grade-row .grade-value span { font-weight:900; color:#0b2b5a; font-size:17px }
  .meta-key { font-weight:900; font-size:15px; color:#092b4a; }
  /* small explanatory text to the right of numbers (학급 / 학생) */
  .grade-row .small-note { color:#4e5b73; font-size:13px; margin-left:6px }
  /* add a compact summary bar at the top of the card for quick scanning */
  .meta-summary { display:flex; gap:14px; margin:8px 12px 6px 12px; }
  .meta-summary .meta-pill { background:#f3f6ff; padding:.45rem .7rem; border-radius:10px; border:1px solid #e0e8ff; color:#082044; font-weight:800; font-size:14px }

  @media (max-width:1000px) { .btn-grid { grid-template-columns: repeat(2,1fr); } }
  /* Keep 3 columns even on narrow screens when used inside APK/webview per request */
  @media (max-width:600px) { h2 { font-size:1.6rem } .btn-grid { grid-template-columns: repeat(3,1fr); } form { padding:1rem } .grid-button { font-size:1.03rem; min-height:64px } }
  /* meeting button styles */
  .meeting-btn { padding:.6rem .8rem; border-radius:.8rem; border:1px solid #d6dbe8; background:#fff; color:#12325a; cursor:pointer; font-weight:800; min-width:110px }
  .meeting-btn.selected { background: linear-gradient(90deg,#6b8bff,#9e60f0); color:#fff; border-color:rgba(0,0,0,0.08); box-shadow:0 10px 26px rgba(60,70,120,0.12); }
  /* subject block index badge */
  .subject-index { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:50%; background:#eef3ff; color:#12325a; font-weight:800; margin-bottom:8px; border:1px solid #d6dbe8; margin-right:8px }
  .subject-block { position:relative; padding:12px 12px 6px 12px; border-radius:10px; border:1px solid #eef2ff; background:#fff; margin-bottom:10px }
  /* timetable responsiveness */
  .timetable-wrapper { overflow:auto; -webkit-overflow-scrolling:touch; position:relative; }
  table.timetable { border-collapse:collapse; width:100%; font-size:11px; line-height:1.12; }
  /* compact cells to reduce wrapping in timetable; use !important to override inline JS styles */
  .timetable-wrapper table.timetable th,
  .timetable-wrapper table.timetable td { border:1px solid #e6eefc; padding:4px 6px !important; font-size:11px !important; vertical-align:top; }
  /* Force single-line cells: prevent wrapping, show ellipsis when truncated, allow horizontal scroll */
  .timetable-wrapper table.timetable th,
  .timetable-wrapper table.timetable td {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    max-width: 260px; /* reasonable cap to help ellipsis; adjust as needed */
  }
  /* For narrow mobile screens, cap width tighter */
  @media (max-width:600px) {
    .timetable-wrapper table.timetable th,
    .timetable-wrapper table.timetable td { max-width: 140px; }
  }
  /* sticky header row and sticky first column (반/학급 or 교시) within the scroll wrapper */
  .timetable-wrapper table.timetable thead th { position:sticky; top:0; background:#f7fbff; z-index:3; }
  .timetable-wrapper table.timetable th:first-child,
  .timetable-wrapper table.timetable td:first-child { position:sticky; left:0; background:#f7fbff; z-index:2; }
  /* ensure the top-left corner cell stays above both header and first column */
  .timetable-wrapper table.timetable thead th:first-child { z-index:4; }
  /* Mobile tweaks: slightly smaller font and tighter padding for narrow screens */
  @media (max-width:600px) {
    .timetable-wrapper table.timetable { font-size:10px; }
    .timetable-wrapper table.timetable th,
    .timetable-wrapper table.timetable td { padding:3px 5px !important; font-size:10px !important; }
    .timetable-wrapper { max-height:60vh; }
  }
  .current-period { background:#ffeaa7 !important; border:1px solid #f1c40f !important; }
  </style>
  <!-- Portrait-lock overlay styles and element -->
  <style id="cmass-landscape-style">
    #cmass-landscape-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(8,12,30,0.92); color:#fff; z-index:99999; text-align:center; padding:2rem; -webkit-user-select:none; user-select:none; }
    #cmass-landscape-overlay .card { max-width:420px; background:transparent; }
    #cmass-landscape-overlay h3 { font-size:1.4rem; margin-bottom:0.6rem }
    #cmass-landscape-overlay p { opacity:0.95; line-height:1.4 }
  </style>
  <div id="cmass-landscape-overlay" aria-hidden="true"><div class="card"><h3>세로 모드에서만 사용하세요</h3><p>기기를 세로로 돌려주세요. 화면을 가로로 돌리는 동안 입력이 사라지는 문제를 막기 위해 잠시 사용을 제한합니다。</p>
      <div style="margin-top:12px;text-align:center">
        <button id="cmass-overlay-lock-btn" class="alt-btn" style="padding:10px 14px;border-radius:10px;margin-right:8px">세로로 전환</button>
        <button id="cmass-overlay-retry-btn" class="alt-btn" style="padding:10px 14px;border-radius:10px">다시 시도</button>
        <div style="margin-top:8px;font-size:12px;opacity:0.95;color:#eef">(버튼을 누르면 가능하면 화면을 세로로 고정합니다)</div>
        <div id="cmass-overlay-ios-help" style="margin-top:8px;font-size:13px;opacity:0.95;color:#eef;display:none">
          iOS/Safari에서는 자동 고정이 지원되지 않을 수 있습니다。 기기를 직접 세로로 돌려주시거나、 아래 '다시 시도'를 눌러보세요。
        </div>
      </div>
    </div></div>
    <script>
      (function(){
        // Only show the portrait-lock overlay on mobile-like devices.
        // Desktop users (large screens / non-mobile UA) should not see this overlay.
        function isMobileDevice(){
          try{
            const ua = navigator.userAgent || '';
            const mobileUA = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i;
            const hasTouch = (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) || ('ontouchstart' in window);
            const narrowScreen = (typeof screen !== 'undefined' && screen.width) ? screen.width <= 1024 : false;
            return mobileUA.test(ua) || (hasTouch && narrowScreen);
          }catch(e){ return false; }
        }
        function updatePortraitOverlay(){ try{
    const overlay = document.getElementById('cmass-landscape-overlay');
    try{ if (sessionStorage && sessionStorage.getItem && sessionStorage.getItem('cmass_overlay_dismissed')){ if (overlay) overlay.style.display = 'none'; return; } }catch(e){}
          const mobile = isMobileDevice();
          // Determine landscape using reliable sources (prefer matchMedia / screen.orientation)
          let isLandscape = false;
          try{
            if (window.matchMedia && window.matchMedia('(orientation: landscape)').matches) isLandscape = true;
            else if (screen && screen.orientation && typeof screen.orientation.type === 'string') isLandscape = screen.orientation.type.indexOf('landscape') === 0;
            else if (typeof screen !== 'undefined' && screen.width && screen.height) isLandscape = screen.width > screen.height;
          }catch(e){ /* fallback below */ }

          // If virtual keyboard is open (visualViewport height much smaller than screen height), avoid showing the overlay
          let keyboardOpen = false;
          try{
            if (window.visualViewport && screen && screen.height){
              const vh = window.visualViewport.height; const sh = screen.height;
              if (vh && sh && (vh < (sh * 0.6))) keyboardOpen = true;
            }
          }catch(e){}

          // show overlay only when device appears to be mobile/touch AND is in landscape AND keyboard is not open
          if (mobile && isLandscape && !keyboardOpen){
            if (overlay) overlay.style.display = 'flex';
            try{ document.documentElement.style.overflow = 'hidden'; }catch(e){}
            try{ if (screen.orientation && screen.orientation.lock) screen.orientation.lock('portrait').catch(()=>{}); }catch(e){}
          }
          else {
            if (overlay) overlay.style.display = 'none';
            try{ document.documentElement.style.overflow = 'auto'; }catch(e){}
          }
        }catch(e){/* ignore */} }
        window.addEventListener('resize', updatePortraitOverlay);
        window.addEventListener('orientationchange', updatePortraitOverlay);
        document.addEventListener('DOMContentLoaded', function(){
            updatePortraitOverlay();
            // show iOS help text when appropriate
            try{
              const isiOS = /iP(hone|od|ad)/i.test(navigator.userAgent || '');
              const help = document.getElementById('cmass-overlay-ios-help');
              if (isiOS && help) help.style.display = '';
            }catch(e){}
          // wire up the manual lock/dismiss button
      // wire up the manual lock/dismiss button
      // wire up the manual lock/dismiss button
          try{
            const btn = document.getElementById('cmass-overlay-lock-btn');
            if (btn) btn.addEventListener('click', async function(){
              const overlay = document.getElementById('cmass-landscape-overlay');
              try{
                if (screen && screen.orientation && typeof screen.orientation.lock === 'function'){
                  await screen.orientation.lock('portrait');
                }
              }catch(e){ /* locking may fail in some browsers, ignore */ }
              try{ if (overlay) overlay.style.display = 'none'; }catch(e){}
              try{ document.documentElement.style.overflow = 'auto'; }catch(e){}
              try{ sessionStorage.setItem('cmass_overlay_dismissed','1'); }catch(e){}
            });
            // retry button: useful for iOS/Safari where lock may fail; hide overlay and prompt user
            const retryBtn = document.getElementById('cmass-overlay-retry-btn');
            if (retryBtn) retryBtn.addEventListener('click', async function(){
              const overlay = document.getElementById('cmass-landscape-overlay');
              try{
                if (screen && screen.orientation && typeof screen.orientation.lock === 'function'){
                  await screen.orientation.lock('portrait');
                } else {
                  // show a brief guidance toast/alert for iOS users
                  try{ alert('이 브라우저에서는 자동 고정이 지원되지 않을 수 있습니다. 기기를 직접 세로로 돌려주세요.'); }catch(e){}
                }
              }catch(e){ try{ alert('세로 고정 시도에 실패했습니다. 기기를 직접 세로로 돌려주세요.'); }catch(er){} }
              try{ if (overlay) overlay.style.display = 'none'; }catch(e){}
              try{ document.documentElement.style.overflow = 'auto'; }catch(e){}
              try{ sessionStorage.setItem('cmass_overlay_dismissed','1'); }catch(e){}
            });
            // hide overlay automatically while typing: when any focusable text input is focused, hide overlay
            document.addEventListener('focusin', function(ev){
              try{
                const t = ev.target;
                if (!t) return;
                const tag = (t.tagName || '').toLowerCase();
                const type = (t.type || '').toLowerCase();
                const isTextInput = tag === 'input' && (type === 'text' || type === 'search' || type === 'tel' || type === 'email' || type === 'number' || type === 'password') || tag === 'textarea' || (t.isContentEditable);
                if (isTextInput){ const overlay = document.getElementById('cmass-landscape-overlay'); if (overlay) overlay.style.display = 'none'; }
              }catch(e){}
            });
            // when input blur, re-evaluate overlay after short delay
            document.addEventListener('focusout', function(){ setTimeout(updatePortraitOverlay, 300); });
          }catch(e){}
        });
      })();
    </script>