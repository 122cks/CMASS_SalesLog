<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>?곸뾽?쇱? ?낅젰</title>
  <!-- papaparse loader: prefer local bundled copy under assets/libs/, fallback to CDN -->
  <script src="libs/papaparse-loader.js"></script>
  <style>
    /* Minimal styles copied from canonical source for consistent layout */
    body{font-family: 'Segoe UI', Arial, sans-serif; background:#f5f6fa;margin:0;padding:16px;color:#10213a}
    h1{font-size:1.6rem;color:#0b2b5a}
    form{background:#fff;padding:16px;border-radius:12px;max-width:820px;margin:8px auto;box-shadow:0 10px 30px rgba(14,30,80,0.06)}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input, select, textarea, button{font-size:1rem}
    input, select, textarea{width:100%;padding:10px;border:1px solid #d6dbe8;border-radius:8px;box-sizing:border-box}
    .btn-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .grid-button{padding:12px;border-radius:10px;border:1px solid #dfe7ff;background:#fff;cursor:pointer}
    .grid-button.selected{background:#0b2b5a;color:#fff;border-color:#071a36}
    .subjects{display:flex;flex-wrap:wrap;gap:8px}
    .subject-btn{padding:10px 12px;border-radius:10px;border:1px solid #d6dbe8;background:#eef3ff;cursor:pointer}
    #generatedSummary{width:100%;padding:12px;border-radius:8px;border:1px solid #d6dbe8;min-height:140px}
  </style>
</head>
<body>
  <h1>?곸뾽?쇱? ?낅젰 (?깆슜 ?섑띁)</h1>
  <!-- PIN overlay logic: matches canonical behavior -->
  <div id="pinOverlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:9999">
    <div style="background:#fff;padding:20px;border-radius:10px;max-width:360px;width:90%">
      <div style="font-weight:900;font-size:1.05rem;margin-bottom:8px">PIN ?낅젰</div>
      <input id="pinInput" placeholder="4-digit PIN" maxlength="4" style="width:100%;padding:10px;font-size:1.05rem;border-radius:8px;border:1px solid #d6dbe8">
      <div style="display:flex;gap:8px;margin-top:10px"><button id="pinProceed" style="flex:1;padding:10px;background:#1e3c72;color:#fff;border:none;border-radius:8px">?낆옣</button><button id="pinCancel" style="flex:1;padding:10px;background:#f2f3f8;border:none;border-radius:8px">痍⑥냼</button></div>
    </div>
  </div>

  <form id="mainForm">
  <label for="visitDate">諛⑸Ц??/label>
  <input type="date" id="visitDate">

    <label>吏??/label>
    <div id="regionButtons" class="btn-grid"></div>

    <label>?숆탳</label>
    <div id="schoolButtons" class="btn-grid"></div>

    <label>諛⑸Ц 怨쇰ぉ/?좎깮??/label>
    <div id="subjectsContainer"></div>
    <button type="button" id="addSubjectBtn" style="margin-top:8px;padding:10px;border-radius:8px;border:1px solid #d6dbe8;background:#eef3ff;">怨쇰ぉ異붽?</button>

    <div style="margin-top:12px;display:flex;gap:8px">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="optHumanLine" checked>?쒓? ?쇱씤</label>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="optHashtags">?댁떆?쒓렇 ?ы븿</label>
      <label style="display:flex;align-items:center;gap:8px">理쒕??쒓렇??<input id="optMaxTags" type="number" value="8" min="1" max="20" style="width:60px;margin-left:6px"></label>
    </div>

    <div style="margin-top:12px">
      <button type="button" id="copyKakaoBtn" style="padding:10px;border-radius:8px;background:#ffd39f;border:none;color:#7a3f00">移댁뭅??蹂듭궗</button>
      <button type="button" id="saveToServerBtn" style="margin-left:8px;padding:10px;border-radius:8px;background:#e9f4ff;border:none;color:#0b3a72">?쒕쾭???/button>
    </div>

    <label style="margin-top:12px">?앹꽦 ?붿빟</label>
    <textarea id="generatedSummary" readonly></textarea>
  </form>

  <script>
    // Minimal canonical JS features: PIN flow, manualSummaryEdited protection, Jamo-aware search stubs, auto-tagging stub.

    // PIN handling: client validates with server via /api/pin-check; session stored in sessionStorage
    const pinOverlay = document.getElementById('pinOverlay');
    const pinInput = document.getElementById('pinInput');
    const pinProceed = document.getElementById('pinProceed');
    const pinCancel = document.getElementById('pinCancel');

    function hidePin() { pinOverlay.style.display='none'; sessionStorage.cmass_pin_authenticated = '1'; }
    function showPin() { pinOverlay.style.display='flex'; }
    if (sessionStorage.cmass_pin_authenticated === '1') hidePin(); else showPin();

    pinProceed.addEventListener('click', async ()=>{
      const pin = pinInput.value.trim();
      // very small client POST to /api/pin-check; fallback URL list may be handled by canonical
      try{
        const resp = await fetch('/api/pin-check',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({staff:'unknown',pin})});
        const j = await resp.json();
        if (j && j.ok) { hidePin(); } else { alert('PIN???щ컮瑜댁? ?딆뒿?덈떎.'); }
      }catch(e){ alert('?쒕쾭 ?뺤씤 ?ㅽ뙣: '+e.message); }
    });

    pinCancel.addEventListener('click', ()=>{ alert('???ъ슜???꾪빐 PIN???꾩슂?⑸땲??'); });

    // manualSummaryEdited protection: if user edits summary, future regenerations should append instead of overwrite
    const generatedSummary = document.getElementById('generatedSummary');
    let manualSummaryEdited = false; let _suppressSummaryInputHandler = false;
    generatedSummary.addEventListener('input', ()=>{ if (_suppressSummaryInputHandler) return; manualSummaryEdited = true; });

    function writeGeneratedSummary(text, opts = { replace:false }){
      if (manualSummaryEdited && !opts.replace){
        // append instead of replace
        _suppressSummaryInputHandler = true;
        generatedSummary.value = generatedSummary.value + '\n\n' + text;
        _suppressSummaryInputHandler = false;
      } else {
        _suppressSummaryInputHandler = true;
        generatedSummary.value = text;
        _suppressSummaryInputHandler = false;
        manualSummaryEdited = false;
      }
    }

    // simplified Jamo-aware search helpers (placeholders matching canonical API)
    function hangulToJamoKey(s){
      // real implementation exists in canonical file; this is a stub for wrapper
      return s.normalize('NFD').replace(/\p{M}/gu,'');
    }

    // auto-tag generation stub; canonical buildAutoTags is more advanced
    function buildAutoTags(visits, maxTags){
      const tags = new Map();
      visits.forEach(v=>{ (v.teacher||'').split(/\s+/).forEach(t=>{ if(!t) return; tags.set('#'+t, (tags.get('#'+t)||0)+1); }); });
      return Array.from(tags.entries()).sort((a,b)=>b[1]-a[1]).slice(0,maxTags).map(x=>x[0]);
    }

    // sample: regenerate summary from hypothetical visits list
    document.getElementById('copyKakaoBtn').addEventListener('click', ()=>{
      const visits = [{region:'吏?쵡', school:'?숆탳A', teacher:'源?좎깮', subject:'?뺣낫', minutes:60}];
      const tags = buildAutoTags(visits, parseInt(document.getElementById('optMaxTags').value||8,10));
      const humanLine = document.getElementById('optHumanLine').checked;
      const hashtags = document.getElementById('optHashtags').checked;
      let text = visits.map(v=> (humanLine?`${v.school} ${v.teacher} ${v.subject} ${v.minutes}遺?:`${v.school} ${v.subject}`)).join('\n');
      if (hashtags && tags.length) text += '\n\n' + tags.join(' ');
      writeGeneratedSummary(text, {replace: false});
      navigator.clipboard.writeText(generatedSummary.value).then(()=>alert('?댁슜???대┰蹂대뱶??蹂듭궗?섏뿀?듬땲??'));
    });

    // saving to server (POST /api/visits) ??canonical does more robust error handling
    document.getElementById('saveToServerBtn').addEventListener('click', async ()=>{
      const payload = { date: document.getElementById('visitDate').value, summary: generatedSummary.value };
      try{
        const r = await fetch('/api/visits',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const j = await r.json(); if (j && j.ok) alert('?쒕쾭 ????꾨즺'); else alert('????ㅽ뙣');
      }catch(e){ alert('???以??ㅻ쪟: '+e.message); }
    });

    // Populate region and school grids using sample CSV (canonical reads sales_staff.csv)
    (function buildSampleGrids(){
      const regions = ['?쒖슱','寃쎄린','?몄쿇','???,'遺??,'?援?];
      const regionButtons = document.getElementById('regionButtons');
      regions.forEach(r=>{ const b=document.createElement('button'); b.className='grid-button'; b.textContent=r; b.addEventListener('click',()=>{ document.querySelectorAll('#regionButtons .grid-button').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }); regionButtons.appendChild(b); });
      const schools = ['媛?뚯큹?깊븰援?,'?ㅼ넄以묓븰援?,'?⑤늻由ш퀬?깊븰援?,'?섑뫖瑜멸퀬?깊븰援?,'臾댁?媛쒖큹'];
      const schoolButtons = document.getElementById('schoolButtons');
      schools.forEach(s=>{ const b=document.createElement('button'); b.className='grid-button'; b.textContent=s; b.addEventListener('click',()=>{ document.querySelectorAll('#schoolButtons .grid-button').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }); schoolButtons.appendChild(b); });
    })();

  </script>
</body>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>영업일지 입력</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* Consolidated CSS (keep only one <style> in head) */
    /* PIN overlay */
    #pinOverlay{position:fixed;inset:0;background:rgba(4,12,34,0.56);display:flex;align-items:center;justify-content:center;z-index:9999}
    #pinBox{background:#fff;padding:20px;border-radius:12px;max-width:420px;width:94%;box-shadow:0 18px 48px rgba(2,6,23,0.5);text-align:center}
    #pinBox h3{margin:0 0 8px 0;font-size:1.2rem;color:#072042}
    #pinBox p{margin:0 0 12px 0;color:#40537a}
    #pinInput{font-size:1.4rem;padding:.6rem .8rem;border-radius:8px;border:1px solid #d6dbe8;width:140px;text-align:center;letter-spacing:6px}
    #pinError{color:#c33;margin-top:8px;min-height:20px}
    #pinProceed{margin-top:12px;padding:.7rem 1rem;border-radius:.8rem;border:none;background:#1e3c72;color:#fff;font-weight:800;cursor:pointer}

    /* Small utility */
    .contact-invalid { border-color:#e05252 !important; box-shadow:0 4px 12px rgba(224,82,82,0.08); }

    /* page layout helpers (most page styles are inline to keep this patch minimal) */
    .grid-button{padding:.5rem .6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;cursor:pointer}
    .meeting-btn{padding:.45rem .7rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#eef7ff;cursor:pointer}
    .meta-card{background:#fff;padding:.8rem;border-radius:.8px;border:1px solid #e6eefc}
  </style>
  <!-- Load Papaparse early so `Papa` is available to page scripts (used for CSV parsing/unparsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- page elements: scripts consolidated and placed at the end -->
  <div id="cmass-landscape-overlay" aria-hidden="true"><div class="card"><h3>세로 모드에서만 사용하세요</h3><p>기기를 세로로 돌려주세요. 화면을 가로로 돌리는 동안 입력이 사라지는 문제를 막기 위해 잠시 사용을 제한합니다.</p>
    <div style="margin-top:12px;text-align:center">
      <button id="cmass-overlay-lock-btn" class="alt-btn" style="padding:10px 14px;border-radius:10px;margin-right:8px">세로로 전환</button>
      <button id="cmass-overlay-retry-btn" class="alt-btn" style="padding:10px 14px;border-radius:10px">다시 시도</button>
      <div style="margin-top:8px;font-size:12px;opacity:0.95;color:#eef">(버튼을 누르면 가능하면 화면을 세로로 고정합니다)</div>
      <div id="cmass-overlay-ios-help" style="margin-top:8px;font-size:13px;opacity:0.95;color:#eef;display:none">
        iOS/Safari에서는 자동 고정이 지원되지 않을 수 있습니다. 기기를 직접 세로로 돌려주시거나, 아래 '다시 시도'를 눌러보세요.
      </div>
    </div>
  </div></div>
  <!-- small inline scripts consolidated into single script at end of file -->
  <!-- PIN overlay: requires 4-digit PIN for selected staff to proceed -->
  <div id="pinOverlay" style="display:none;">
    <div id="pinBox" role="dialog" aria-labelledby="pinTitle" aria-modal="true">
      <h3 id="pinTitle">영업일지 접근 인증</h3>
      <p id="pinDesc">본인 영업일지에 접근하려면 4자리 PIN을 입력하세요.</p>
      <div>
        <label for="pinInput" style="position:absolute;left:-9999px;">PIN 입력</label>
        <input id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="●●●●" aria-label="4자리 PIN 입력" />
      </div>
      <div id="pinError"></div>
      <button id="pinProceed">입력</button>
    </div>
  </div>
  <!-- canonical user param logic moved to consolidated script -->
      max-width: 640px; /* allow more room for longer names */
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 10px 30px rgba(14,30,80,0.08);
      padding: 1.6rem 1.8rem;
      margin-bottom: 2rem;
    }

    label { display:block; font-weight:700; margin-top:1rem; color:#333; }

  input, select, textarea { width:100%; padding:0.95rem; border-radius:0.9rem; border:1px solid #d6dbe8; box-sizing:border-box; font-size:1rem; }

    /* subject/activity buttons */
    .subjects { display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem; }
  .subject-btn { flex:1 1 45%; min-width:130px; padding:1.05rem; font-size:1.08rem; border-radius:1rem; border:none; background:#e9eefc; color:#12325a; font-weight:800; cursor:pointer }
  .subject-btn.selected { background:#12325a; color:#fff; box-shadow:0 6px 18px rgba(18,50,90,0.14); }

    /* region / school button grid: desktop 3 cols, medium 2, small 1 */
  .btn-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:0.7rem; margin-top:0.6rem; margin-bottom:1rem; }
  .grid-button { padding:1.05rem 1rem; font-size:1.05rem; border-radius:1rem; border:1px solid #cfd9ff; background:#fff; color:#133257; cursor:pointer; text-align:center; white-space:normal; overflow-wrap:anywhere; word-break:keep-all; min-height:56px; line-height:1.3 }
  .grid-button:hover { background:#f5f7ff; transform:translateY(-2px); box-shadow:0 8px 22px rgba(20,40,80,0.06); }
  .grid-button.selected { background:#0b2b5a; color:#fff; border-color:#071a36; box-shadow:0 12px 30px rgba(11,43,90,0.18); font-weight:900 }

    .btn-submit, .btn-report { width:100%; padding:1.2rem; font-size:1.2rem; border-radius:1rem; border:none; background:#1e3c72; color:#fff; font-weight:700; cursor:pointer }
    .btn-report { background:#ff9800; margin-top:0.5rem }

    /* school metadata card styles (inline and step2) - more prominent */
    #schoolMetaInline, #schoolMeta {
      display:none;
      padding:22px 20px;
      border-radius:14px;
      background:linear-gradient(180deg,#ffffff 0%, #f7f8ff 100%);
      border:1px solid #e2e8ff;
      box-shadow:0 18px 48px rgba(10,28,64,0.12);
      color:#071a2e;
      font-size:16.5px;
      line-height:1.6;
      margin-top:1rem;
      position:relative;
      overflow:visible;
    }
    /* accent stripe on the left (wider for better affordance) */
    #schoolMetaInline::before, #schoolMeta::before {
      content: '';
      position: absolute;
      left: 0;
      top: 8px;
      bottom: 8px;
      width: 10px;
      border-radius: 8px;
      background: linear-gradient(180deg,#556ee8,#6b4bb0);
      box-shadow: 0 4px 14px rgba(80,90,160,0.08);
    }
  #schoolMetaInline h4, #schoolMeta h4 { margin:0 0 .6rem 18px; font-size:19px; color:#06203f; font-weight:900 }
  .grade-rows { display:block; margin-top:12px; }
  /* turn each grade row into two columns: label / values -- values emphasized */
  .grade-row { display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center; margin:8px 0; }
  .grade-row .grade-label { font-weight:900; color:#0d304f; font-size:15px }
  .grade-row .grade-value { color:#072042; font-size:15px; display:flex; gap:8px; align-items:baseline }
  /* highlight numeric values much larger */
  .grade-row .grade-value span { font-weight:900; color:#0b2b5a; font-size:17px }
  .meta-key { font-weight:900; font-size:15px; color:#092b4a; }
  /* small explanatory text to the right of numbers (?숆툒 / ?숈깮) */
  .grade-row .small-note { color:#4e5b73; font-size:13px; margin-left:6px }
  /* add a compact summary bar at the top of the card for quick scanning */
  .meta-summary { display:flex; gap:14px; margin:8px 12px 6px 12px; }
  .meta-summary .meta-pill { background:#f3f6ff; padding:.45rem .7rem; border-radius:10px; border:1px solid #e0e8ff; color:#082044; font-weight:800; font-size:14px }

  @media (max-width:1000px) { .btn-grid { grid-template-columns: repeat(2,1fr); } }
  /* Keep 3 columns even on narrow screens when used inside APK/webview per request */
  @media (max-width:600px) { h2 { font-size:1.6rem } .btn-grid { grid-template-columns: repeat(3,1fr); } form { padding:1rem } .grid-button { font-size:1.03rem; min-height:64px } }
  /* meeting button styles */
  .meeting-btn { padding:.6rem .8rem; border-radius:.8rem; border:1px solid #d6dbe8; background:#fff; color:#12325a; cursor:pointer; font-weight:800; min-width:110px }
  .meeting-btn.selected { background: linear-gradient(90deg,#6b8bff,#9e60f0); color:#fff; border-color:rgba(0,0,0,0.08); box-shadow:0 10px 26px rgba(60,70,120,0.12); }
  /* subject block index badge */
  .subject-index { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:50%; background:#eef3ff; color:#12325a; font-weight:800; margin-bottom:8px; border:1px solid #d6dbe8; margin-right:8px }
  .subject-block { position:relative; padding:12px 12px 6px 12px; border-radius:10px; border:1px solid #eef2ff; background:#fff; margin-bottom:10px }
  </style>
</head>
<body>
  <script>
    // Register service worker for offline support and PWA install
    if ('serviceWorker' in navigator) {
      // register using relative path so it works from the hosting root
      navigator.serviceWorker.register('service-worker.js').then(() => console.log('SW registered')).catch(e=>console.warn('SW reg failed',e));
    }
  </script>
  <h2>?곸뾽?쇱? ?낅젰</h2>
  <div id="step1">
    <form>
  <label for="visitDate">諛⑸Ц??/label>
  <input type="date" id="visitDate" name="visitDate" required style="padding:.7rem;border-radius:.8rem;border:1px solid #d6dbe8;margin-bottom:.6rem;" />
      <div id="staffInfo" style="font-size:1.2rem;font-weight:bold;margin-bottom:1rem;">?대떦?? ?≫썕??遺??/div>
  <label>吏??/label>
  <div id="regionButtons" class="btn-grid" role="listbox" aria-label="吏???좏깮"></div>
    <label>?숆탳紐?/label>
    <div id="schoolButtons" class="btn-grid" role="listbox" aria-label="?숆탳紐??좏깮"></div>
    <!-- inline school metadata shown immediately after selecting a school -->
    <div id="schoolMetaInline" class="meta-card" style="display:none;">
      <h4>?숆탳 ?뺣낫</h4>
      <div class="meta-summary">
        <div class="meta-pill" id="inlinePillEstablish">?ㅻ┰: -</div>
        <div class="meta-pill" id="inlinePillLevel">湲? -</div>
        <div class="meta-pill" id="inlinePillStudents">珥앺븰?앹닔: -</div>
      </div>
      <div class="grade-rows">
        <div class="grade-row"><div class="grade-label">1?숇뀈:</div><div class="grade-value"><span id="inlineG1c"></span> ?숆툒 / <span id="inlineG1s"></span> ?숈깮</div></div>
        <div class="grade-row"><div class="grade-label">2?숇뀈:</div><div class="grade-value"><span id="inlineG2c"></span> ?숆툒 / <span id="inlineG2s"></span> ?숈깮</div></div>
        <div class="grade-row"><div class="grade-label">3?숇뀈:</div><div class="grade-value"><span id="inlineG3c"></span> ?숆툒 / <span id="inlineG3s"></span> ?숈깮</div></div>
      </div>
    </div>
      <button type="button" id="nextStepBtn" style="width:100%;margin:1rem 0 0 0;padding:1rem;font-size:1.1rem;border-radius:1rem;background:#1e3c72;color:#fff;font-weight:bold;border:none;cursor:pointer;">?ㅼ쓬</button>
    </form>
  </div>
  <div id="step2" style="display:none;">
  <form id="salesForm">
      <!-- show selected region/school -->
      <div id="selectedInfo" style="margin-bottom:1rem;font-weight:bold;font-size:1.1rem;display:none;">
        ?좏깮??吏?? <span id="displayRegion"></span> &nbsp; | &nbsp; ?숆탳: <span id="displaySchool"></span>
      </div>
      <!-- hidden fields to submit selected region/school -->
      <input type="hidden" id="selectedRegionInput" name="region">
      <input type="hidden" id="selectedSchoolInput" name="schoolName">
      <!-- school metadata panel (Step2) -->
      <div id="schoolMeta" class="meta-card">
        <h4>?숆탳 ?뺣낫</h4>
        <div class="meta-summary">
          <div class="meta-pill" id="metaPillEstablish">?ㅻ┰: -</div>
          <div class="meta-pill" id="metaPillLevel">湲? -</div>
          <div class="meta-pill" id="metaPillStudents">珥앺븰?앹닔: -</div>
        </div>
        <div class="grade-rows">
          <div class="grade-row"><div class="grade-label">1?숇뀈:</div><div class="grade-value"><span id="metaG1c"></span> ?숆툒 / <span id="metaG1s"></span> ?숈깮</div></div>
          <div class="grade-row"><div class="grade-label">2?숇뀈:</div><div class="grade-value"><span id="metaG2c"></span> ?숆툒 / <span id="metaG2s"></span> ?숈깮</div></div>
          <div class="grade-row"><div class="grade-label">3?숇뀈:</div><div class="grade-value"><span id="metaG3c"></span> ?숆툒 / <span id="metaG3s"></span> ?숈깮</div></div>
        </div>
      </div>
      <label for="visitStartHour">諛⑸Ц ?쒖옉 ?쒓컙</label>
        <select id="visitStartHour" name="visitStartHour" aria-label="諛⑸Ц ?쒖옉 ??></select>
        <select id="visitStartMinute" name="visitStartMinute" aria-label="諛⑸Ц ?쒖옉 遺?></select>
      <label for="visitDuration">珥?諛⑸Ц ?쒓컙(遺?</label>
      <div id="durationControls" style="margin-bottom:0.8rem;">
        <div id="durationButtons" class="btn-grid" style="grid-template-columns:repeat(5,1fr); gap:0.5rem;">
          <!-- buttons injected by JS -->
        </div>
        <div style="margin-top:0.6rem; display:flex; gap:0.6rem; align-items:center;">
          <input type="number" id="visitDuration" placeholder="?? 80" min="1" style="flex:1; padding:.8rem; border-radius:.8rem; border:1px solid #d6dbe8;" aria-label="珥?諛⑸Ц ?쒓컙(遺? ?섎룞 ?낅젰">
          <button type="button" id="clearDuration" style="padding:.7rem 1rem; border-radius:.8rem; background:#f2f3f8; border:1px solid #d6dbe8; cursor:pointer;">吏?곌린</button>
        </div>
      </div>
      <input type="hidden" id="selectedDurationInput" name="durationMinutes">
  <label for="visitEnd" style="margin-top:0.6rem;">諛⑸Ц 醫낅즺 ?쒓컙 <small style="font-weight:600;color:#40537a">(?먮룞 怨꾩궛??</small></label>
    <input type="text" id="visitEnd" name="visitEnd" readonly>
      <div id="subjectsBlock">
        <label>怨쇰ぉ/?좎깮?섎퀎 ?곸뾽湲곕줉</label>
        <div class="subject-block">
              <input type="hidden" class="subject-name" required>
              <div class="subjects" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px;">
                <button type="button" class="grid-button subject-choice" data-subject="?뺣낫">?뺣낫</button>
                <button type="button" class="grid-button subject-choice" data-subject="吏꾨줈">吏꾨줈</button>
                <button type="button" class="grid-button subject-choice" data-subject="蹂닿굔">蹂닿굔</button>
                <button type="button" class="grid-button subject-choice" data-subject="誘몄닠">誘몄닠</button>
                <button type="button" class="grid-button subject-choice" data-subject="泥댁쑁">泥댁쑁</button>
                <button type="button" class="grid-button subject-choice" data-subject="?뱀꽦??>?뱀꽦??/button>
                <button type="button" class="grid-button subject-choice" data-subject="湲고?">湲고?</button>
              </div>
      <input type="text" class="teacher-name" placeholder="?좎깮???대쫫" required>
      <input type="text" class="teacher-location" placeholder="?좎깮???꾩튂 (?? 1痢?蹂멸탳臾댁떎)" style="margin-top:8px;">
        <select class="publisher">
                <option value="">異쒗뙋???좏깮</option>
                <option>泥쒖옱</option><option>鍮꾩긽</option><option>?숈븘</option><option>?쇱뼇</option><option>湲고?</option>
              </select>
              <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
                <label style="font-weight:700;min-width:38px;">?곕씫泥?/label>
                    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
                      <span style="display:inline-block;padding:.55rem .7rem;border-radius:.6rem;background:#f2f4ff;border:1px solid #d6dbe8;color:#12325a;font-weight:700;">010</span>
                      <input type="text" class="contact-suffix" placeholder="12345678" maxlength="8" inputmode="numeric" pattern="[0-9]*" style="width:120px;padding:.55rem .6rem;border-radius:.6rem;border:1px solid #d6dbe8;">
                      <span class="contact-formatted" style="margin-left:8px;color:#103254;font-weight:700;"></span>
                      <button type="button" class="copy-contact" style="margin-left:6px;padding:.4rem .6rem;border-radius:.5rem;border:1px solid #d6dbe8;background:#fff;cursor:pointer;">蹂듭궗</button>
                    </div>
              </div>
          <div style="margin-top:16px;"></div>
          <div class="meeting-buttons main-meeting-buttons">
            <button class="meeting-btn" type="button">紐낇븿?몄궗</button>
            <button class="meeting-btn" type="button">?곗묶?섏냼媛?/button>
            <button class="meeting-btn" type="button">梨꾪똿諛⑹냼媛?/button>
            <button class="meeting-btn" type="button">?먮즺嫄곕?</button>
            <button class="meeting-btn" type="button">誘명똿遺덇?</button>
          </div>
              <button class="meeting-btn" type="button">釉뚮줈?덉뼱</button>
              <button class="meeting-btn" type="button">媛?대뱶遺?/button>
              <button class="meeting-btn" type="button">?먮즺嫄곕?</button>
              <button class="meeting-btn" type="button">誘명똿遺덇?</button>
          </div>
          <textarea class="conversation-detail" rows="2" placeholder="?뱀씠?ы빆"></textarea>
          <div style="margin-top:0.6rem;">
            <label style="font-weight:700;display:block;margin-bottom:6px;">?꾩냽議곗튂</label>
            <select class="followUpSelect" style="width:100%;padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;">
              <option value="">?좏깮?섏꽭??/option>
              <option>梨꾪똿諛?吏??愿由?/option>
              <option>異붽? ?먮즺 諛쒖넚 ?덉젙</option>
              <option>?щ갑臾??덉젙</option>
              <option>?좎젙 ?쒓린 ?곕씫 ?湲?/option>
              <option>?뚰겕遺?臾댁긽吏???쒖븞</option>
              <option>?꾨즺 (異붽? 議곗튂 ?놁쓬)</option>
            </select>
          </div>
        </div>
        <div style="margin-top:16px;"></div>
      </div>
      <button type="button" id="addSubjectBtn" style="width:100%;margin:0.5rem 0 1rem 0;padding:1rem;font-size:1.1rem;border-radius:1rem;background:#e3eafc;color:#1e3c72;font-weight:bold;border:none;cursor:pointer;">怨쇰ぉ/?좎깮??異붽?</button>
      <!-- follow-up select is now per subject-block -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-top:0.6rem;">
        <button type="button" id="backBtn" style="padding:1rem;border-radius:1rem;border:1px solid #d6dbe8;background:#fff;color:#1e3c72;font-weight:700;cursor:pointer;">?ㅻ줈 ?뚯븘媛湲?/button>
        <button type="submit" class="btn-submit">?낅젰 ?꾨즺</button>
      </div>
      <div style="margin-top:1rem;">
        <div style="display:flex;gap:.5rem;margin-bottom:.5rem;align-items:center;">
          <div style="display:flex;gap:.5rem;align-items:center;">
            <label style="font-size:13px;display:flex;align-items:center;gap:.4rem;"><input type="checkbox" id="optHumanLine" checked>?쒓? ?쇱씤</label>
            <label style="font-size:13px;display:flex;align-items:center;gap:.4rem;"><input type="checkbox" id="optHashtags">?댁떆?쒓렇 ?ы븿</label>
            <label style="font-size:13px;display:flex;align-items:center;gap:.4rem;">理쒕??쒓렇??<input id="optMaxTags" type="number" min="1" max="20" value="8" style="width:56px;padding:.2rem .4rem;border-radius:.4rem;border:1px solid #d6dbe8;margin-left:.4rem;"></label>
          </div>
          <button type="button" id="copyKakaoBtn" style="flex:1;padding:.75rem;border-radius:1rem;border:1px solid #ffd9b3;background:#fff;color:#b25700;font-weight:800;">移댄넚?쇰줈 蹂듭궗</button>
        </div>
        <div style="display:flex;gap:.5rem;margin-bottom:.5rem;">
          <button type="button" id="saveToServerBtn" style="flex:1;padding:.75rem;border-radius:1rem;border:1px solid #cfe8ff;background:#e9f4ff;color:#0b3a72;font-weight:800;">?쒕쾭?????/button>
        </div>
        <div>
          <textarea id="generatedSummary" rows="10" readonly style="width:100%;margin-top:.6rem;padding:.8rem;border-radius:.8rem;border:1px solid #d6dbe8;display:block;">?붿빟???ш린???앹꽦?⑸땲??</textarea>
        </div>
      </div>
    </form>
  </div>
  <style>
    .contact-invalid { border-color:#e05252 !important; box-shadow:0 4px 12px rgba(224,82,82,0.08); }
  </style>
  <script>
    // If the page is opened via file:// the browser will block fetch requests (origin=null).
    // Show a clear on-page message to the user instead of failing silently with CORS errors.
    // --- Multi-visit (dayVisits) support and summary templates ---
    const dayVisits = [];

  // Feature flag: prevent automatic advancement to step2 on page load.
  // Set to true only if you intentionally want pages to auto-advance.
  const ALLOW_AUTO_ADVANCE = false;

  // small utility: pad numbers to 2 digits. Defined early so other functions can use it.
    function pad2(n){
      const num = parseInt(n,10);
      if (isNaN(num)) return '00';
      return (num < 10 ? '0' : '') + String(num);
    }

    function buildCurrentVisitObject() {
      // capture top-level visit info
      const visitDate = (document.getElementById('visitDate') || {}).value || '';
      const staff = (document.getElementById('staffName') || {}).value || '';
      const region = (document.querySelector('#regionButtons .grid-button[aria-selected="true"]') || {}).dataset?.value || '';
      const schoolBtn = document.querySelector('#schoolButtons .grid-button[aria-selected="true"]');
      const school = schoolBtn ? (schoolBtn.dataset.value || schoolBtn.textContent.trim()) : '';
      const meta = {};
      const est = document.getElementById('metaPillEstablish'); if (est) meta.establish = est.textContent || '';
      const level = document.getElementById('metaPillLevel'); if (level) meta.level = level.textContent || '';
      const g1 = document.getElementById('metaG1c'); if (g1) meta.g1 = g1.textContent || '';

      const startHour = (document.getElementById('visitStartHour')||{}).value || '08';
      const startMinute = (document.getElementById('visitStartMinute')||{}).value || '00';
      const visitStart = `${pad2(startHour)}:${pad2(startMinute)}`;
      const visitEnd = (document.getElementById('visitEnd')||{}).value || '';

      // subjects
      const subjectBlocks = Array.from(document.querySelectorAll('#subjectsBlock .subject-block'));
      const subjects = subjectBlocks.map((blk)=>{
        const subj = (blk.querySelector('.subject-name')||{}).value || '';
        const teacher = (blk.querySelector('.teacher-name')||{}).value || '';
        const teacherLocation = (blk.querySelector('.teacher-location')||{}).value || '';
        const publisher = (blk.querySelector('.publisher')||{}).value || '';
        const conv = (blk.querySelector('.conversation-detail')||{}).value || '';
        const followUp = (blk.querySelector('.followUpSelect')||{}).value || '';
        const contactSuffix = (blk.querySelector('.contact-suffix')||{}).value || '';
        const contact = contactSuffix ? `010-${contactSuffix.slice(0,4)}-${contactSuffix.slice(4)}` : '';
        const meetings = Array.from(blk.querySelectorAll('.meeting-btn.selected')).map(b=>b.dataset.value||b.textContent.trim());
        return { subject:subj, teacher, teacherLocation, publisher, conversation:conv, followUp, contact, meetings };
      });

      return { visitDate, staff, region, school, meta, visitStart, visitEnd, subjects };
    }

    function renderVisitsList() {
      const el = document.getElementById('visitsList');
      if (!el) return;
      el.innerHTML = '';
      if (dayVisits.length === 0) { el.innerHTML = '<div style="color:#666;padding:.6rem;">異붽???諛⑸Ц???놁뒿?덈떎.</div>'; return; }
      // render stacked cards (chronological)
      dayVisits.forEach((v, idx) => {
        const card = document.createElement('div');
        card.className = 'visit-card';
        card.style = 'border-radius:8px;border:1px solid #e6eefc;background:#fff;padding:.8rem;margin-bottom:8px;';
        const header = document.createElement('div');
        header.style = 'display:flex;justify-content:space-between;align-items:center;gap:.6rem;';
        const title = document.createElement('div');
        title.innerHTML = `<strong>${idx+1}. ${v.school || '?숆탳 誘몄꽑??}</strong><div style="font-size:12px;color:#556">${v.visitDate || ''} ${v.visitStart || ''} ~ ${v.visitEnd || ''}</div>`;
        const actions = document.createElement('div');
        const editBtn = document.createElement('button'); editBtn.textContent='?몄쭛'; editBtn.style='margin-right:6px;padding:.3rem .6rem;border-radius:.5rem;'; editBtn.addEventListener('click',()=>loadVisitToForm(idx));
        const removeBtn = document.createElement('button'); removeBtn.textContent='?쒓굅'; removeBtn.style='padding:.3rem .6rem;border-radius:.5rem;color:#c33;'; removeBtn.addEventListener('click',()=>{ if(editingVisitIndex===idx) resetEditState(); dayVisits.splice(idx,1); renderVisitsList(); });
        actions.appendChild(editBtn); actions.appendChild(removeBtn);
        header.appendChild(title); header.appendChild(actions);
        card.appendChild(header);
        // brief subjects summary
        if (v.subjects && v.subjects.length) {
          const ul = document.createElement('div'); ul.style='margin-top:.6rem;font-size:13px;color:#233';
          v.subjects.forEach(s=>{
            const line = document.createElement('div'); line.textContent = `${s.subject || '-'} ${s.teacher? '('+s.teacher+')':''} ${s.contact? '쨌 '+s.contact : ''}`;
            ul.appendChild(line);
          });
          card.appendChild(ul);
        }
        el.appendChild(card);
      });
      // auto-scroll to bottom so latest added visit is visible
      el.scrollTop = el.scrollHeight;
    }

    function resetFormForNextVisit() {
      // keep visitDate and staffInfo, clear region/school selection and subject blocks (leave one blank block)
      // clear region/school UI selection
      document.querySelectorAll('#regionButtons .grid-button.selected').forEach(b=>b.classList.remove('selected'));
      document.querySelectorAll('#schoolButtons .grid-button.selected').forEach(b=>b.classList.remove('selected'));
      document.getElementById('selectedRegionInput').value = '';
      document.getElementById('selectedSchoolInput').value = '';
      document.getElementById('displayRegion').textContent = '';
      document.getElementById('displaySchool').textContent = '';
      document.getElementById('selectedInfo').style.display = 'none';
      // reset subject blocks: keep single blank block
  const container = document.getElementById('subjectsBlock');
  container.innerHTML = `\n        <label>怨쇰ぉ/?좎깮?섎퀎 ?곸뾽湲곕줉</label>\n        <div class="subject-block">\n              <input type="hidden" class="subject-name">\n              <div class="subjects" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:8px;">\n                <button type="button" class="grid-button subject-choice" data-subject="?뺣낫">?뺣낫</button>\n                <button type="button" class="grid-button subject-choice" data-subject="吏꾨줈">吏꾨줈</button>\n                <button type="button" class="grid-button subject-choice" data-subject="蹂닿굔">蹂닿굔</button>\n                <button type="button" class="grid-button subject-choice" data-subject="誘몄닠">誘몄닠</button>\n                <button type="button" class="grid-button subject-choice" data-subject="?뱀꽦??>?뱀꽦??/button>\n                <button type="button" class="grid-button subject-choice" data-subject="湲고?">湲고?</button>\n              </div>\n          <input type="text" class="teacher-name" placeholder="?좎깮???대쫫">\n              <select class="publisher">\n                <option value="">異쒗뙋???좏깮</option>\n                <option>泥쒖옱</option><option>鍮꾩긽</option><option>?숈븘</option><option>?쇱뼇</option><option>湲고?</option>\n              </select>\n              <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">\n                <label style="font-weight:700;min-width:38px;">?곕씫泥?/label>\n                    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">\n                      <span style="display:inline-block;padding:.55rem .7rem;border-radius:.6rem;background:#f2f4ff;border:1px solid #d6dbe8;color:#12325a;font-weight:700;">010</span>\n                      <input type="text" class="contact-suffix" placeholder="12345678" maxlength="8" inputmode="numeric" pattern="[0-9]*" style="width:120px;padding:.55rem .6rem;border-radius:.6rem;border:1px solid #d6dbe8;">\n                      <span class="contact-formatted" style="margin-left:8px;color:#103254;font-weight:700;"></span>\n                      <button type="button" class="copy-contact" style="margin-left:6px;padding:.4rem .6rem;border-radius:.5rem;border:1px solid #d6dbe8;background:#fff;cursor:pointer;">蹂듭궗</button>\n                    </div>\n              </div>\n          <div style="margin-top:16px;"></div>\n          <div class="meeting-buttons main-meeting-buttons">\n            <button class="meeting-btn" type="button">紐낇븿?몄궗</button>\n            <button class="meeting-btn" type="button">?곗묶?섏냼媛?/button>\n            <button class="meeting-btn" type="button">梨꾪똿諛⑹냼媛?/button>\n            <button class="meeting-btn" type="button">誘명똿遺덇?</button>\n          </div>\n          <div class="meeting-buttons info-extra-buttons" style="display:none;">\n            <button class="meeting-btn" type="button">援ш??대옒?ㅻ８ ?ъ슜</button>\n            <button class="meeting-btn" type="button">?⑤뱾???ъ슜</button>\n            <button class="meeting-btn" type="button">?섏씠?щ떇 ?ъ슜</button>\n          </div>\n          <textarea class="conversation-detail" rows="2" placeholder="?뱀씠?ы빆"></textarea>\n          <div style="margin-top:0.6rem;">\n            <label style="font-weight:700;display:block;margin-bottom:6px;">?꾩냽議곗튂</label>\n            <select class="followUpSelect" style="width:100%;padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;">\n              <option value="">?좏깮?섏꽭??/option>\n              <option>梨꾪똿諛?吏??愿由?/option>\n              <option>異붽? ?먮즺 諛쒖넚 ?덉젙</option>\n              <option>?щ갑臾??덉젙</option>\n              <option>?좎젙 ?쒓린 ?곕씫 ?湲?/option>\n              <option>?뚰겕遺?臾댁긽吏???쒖븞</option>\n              <option>?꾨즺 (異붽? 議곗튂 ?놁쓬)</option>\n            </select>\n          </div>\n        </div>\n        <div style="margin-top:16px;"></div>\n      `;
      if (typeof renumberSubjectBlocks === 'function') renumberSubjectBlocks();
      // if user enabled auto-focus, focus the first region button (or school if region already selected)
      setTimeout(()=>{
        try{
          const auto = document.getElementById('autoFocusNext');
          if (auto && auto.checked) {
            const regionFirst = document.querySelector('#regionButtons .grid-button');
            const schoolFirst = document.querySelector('#schoolButtons .grid-button');
            if (regionFirst) { regionFirst.focus(); }
            else if (schoolFirst) { schoolFirst.focus(); }
          }
        }catch(e){/* ignore focus errors */}
      },60);
    }

    let editingVisitIndex = -1; // -1 means not editing

    function resetEditState() {
      editingVisitIndex = -1;
      const addBtn = document.getElementById('addVisitBtn'); if (addBtn) addBtn.textContent = '?ㅻ뒛 諛⑸Ц??異붽?';
      renderVisitsList();
    }

  async function loadVisitToForm(idx) {
      const v = dayVisits[idx];
      if (!v) return;
      // populate top-level (defensive date normalization)
      if (v.visitDate) {
        const vdEl = document.getElementById('visitDate') || null;
        try{
          const s = String(v.visitDate || '').trim();
          let norm = '';
          if (/^\d{4}-\d{2}-\d{2}$/.test(s)) norm = s;
          else {
            const m = s.match(/^(\d{4}-\d{2}-\d{2})T/);
            if (m && m[1]) norm = m[1];
            else {
              const d = new Date(s);
              if (!isNaN(d.getTime())) norm = d.toISOString().slice(0,10);
            }
          }
          if (vdEl) vdEl.value = norm || '';
        }catch(e){}
      }
      if (v.visitStart) {
        const [hh, mm] = v.visitStart.split(':');
        if (document.getElementById('visitStartHour')) document.getElementById('visitStartHour').value = hh;
        if (document.getElementById('visitStartMinute')) document.getElementById('visitStartMinute').value = mm;
      }
      if (v.visitEnd) (document.getElementById('visitEnd')||{}).value = v.visitEnd;
      // select region and school buttons if possible
      if (v.region) {
        const regionBtn = Array.from(document.querySelectorAll('#regionButtons .grid-button')).find(b=>b.textContent.trim()===v.region || b.dataset.region===v.region);
        if (regionBtn) regionBtn.click();
      }
      if (v.school) {
        // small delay to allow schools populated after region click
        setTimeout(()=>{
          const schoolBtn = Array.from(document.querySelectorAll('#schoolButtons .grid-button')).find(b=>b.textContent.trim()===v.school || b.dataset.school===v.school);
          if (schoolBtn) schoolBtn.click();
        }, 120);
      }
      // clear existing subject blocks and rebuild from v.subjects
      const container = document.getElementById('subjectsBlock');
      container.innerHTML = '<label>怨쇰ぉ/?좎깮?섎퀎 ?곸뾽湲곕줉</label>';
      v.subjects.forEach(s => {
        const block = document.createElement('div'); block.className = 'subject-block';
        block.innerHTML = `
          <input type="hidden" class="subject-name" required>
          <div class="subjects" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:8px;">
            <button type="button" class="grid-button subject-choice" data-subject="?뺣낫">?뺣낫</button>
            <button type="button" class="grid-button subject-choice" data-subject="吏꾨줈">吏꾨줈</button>
            <button type="button" class="grid-button subject-choice" data-subject="蹂닿굔">蹂닿굔</button>
            <button type="button" class="grid-button subject-choice" data-subject="誘몄닠">誘몄닠</button>
            <button type="button" class="grid-button subject-choice" data-subject="?뱀꽦??>?뱀꽦??/button>
            <button type="button" class="grid-button subject-choice" data-subject="湲고?">湲고?</button>
          </div>
          <input type="text" class="teacher-name" placeholder="?좎깮???대쫫" required>
          <select class="publisher">
            <option value="">異쒗뙋???좏깮</option>
            <option>泥쒖옱</option><option>鍮꾩긽</option><option>?숈븘</option><option>?쇱뼇</option><option>湲고?</option>
          </select>
          <div style="margin-top:0.6rem;">
            <label style="font-weight:700;display:block;margin-bottom:6px;">?꾩냽議곗튂</label>
            <select class="followUpSelect" style="width:100%;padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;">
              <option value="">?좏깮?섏꽭??/option>
              <option>梨꾪똿諛?吏??愿由?/option>
              <option>異붽? ?먮즺 諛쒖넚 ?덉젙</option>
              <option>?щ갑臾??덉젙</option>
              <option>?좎젙 ?쒓린 ?곕씫 ?湲?/option>
              <option>?뚰겕遺?臾댁긽吏???쒖븞</option>
              <option>?꾨즺 (異붽? 議곗튂 ?놁쓬)</option>
            </select>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
            <label style="font-weight:700;min-width:38px;">?곕씫泥?/label>
            <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
              <span style="display:inline-block;padding:.55rem .7rem;border-radius:.6rem;background:#f2f4ff;border:1px solid #d6dbe8;color:#12325a;font-weight:700;">010</span>
              <input type="text" class="contact-suffix" placeholder="12345678" maxlength="8" inputmode="numeric" pattern="[0-9]*" style="width:120px;padding:.55rem .6rem;border-radius:.6rem;border:1px solid #d6dbe8;">
              <span class="contact-formatted" style="margin-left:8px;color:#103254;font-weight:700;"></span>
              <button type="button" class="copy-contact" style="margin-left:6px;padding:.4rem .6rem;border-radius:.5rem;border:1px solid #d6dbe8;background:#fff;cursor:pointer;">蹂듭궗</button>
            </div>
          </div>
          <div style="margin-top:16px;"></div>
          <div class="meeting-buttons main-meeting-buttons">
            <button class="meeting-btn" type="button">紐낇븿?몄궗</button>
            <button class="meeting-btn" type="button">?곗묶?섏냼媛?/button>
            <button class="meeting-btn" type="button">梨꾪똿諛⑹냼媛?/button>
            <button class="meeting-btn" type="button">誘명똿遺덇?</button>
          </div>
          <div class="meeting-buttons info-extra-buttons" style="display:none;">
            <button class="meeting-btn" type="button">援ш??대옒?ㅻ８ ?ъ슜</button>
            <button class="meeting-btn" type="button">?⑤뱾???ъ슜</button>
            <button class="meeting-btn" type="button">?섏씠?щ떇 ?ъ슜</button>
          </div>
          <textarea class="conversation-detail" rows="2" placeholder="?뱀씠?ы빆"></textarea>
        `;
        // populate values
        if (s.subject) {
          block.querySelector('.subject-name').value = s.subject;
          const subjectBtn = Array.from(block.querySelectorAll('.subject-choice')).find(b=>b.dataset.subject===s.subject || b.textContent.trim()===s.subject);
          if (subjectBtn) subjectBtn.classList.add('selected');
        }
        if (s.teacher) block.querySelector('.teacher-name').value = s.teacher;
        if (s.publisher) block.querySelector('.publisher').value = s.publisher;
        if (s.followUp) block.querySelector('.followUpSelect').value = s.followUp;
        if (s.contact) {
          // extract suffix digits from format like 010-1234-5678
          const digits = (s.contact || '').replace(/\D+/g,'');
          if (digits.length === 11) block.querySelector('.contact-suffix').value = digits.slice(3);
        }
        if (s.conversation) block.querySelector('.conversation-detail').value = s.conversation;
        // meetings selection
        setTimeout(()=>{
          if (s.meetings && s.meetings.length) {
            Array.from(block.querySelectorAll('.meeting-btn')).forEach(btn=>{
              if (s.meetings.includes(btn.textContent.trim())) btn.classList.add('selected');
            });
          }
        }, 10);
        block.querySelector('.removeSubjectBtn').onclick = function(){ block.remove(); if(typeof renumberSubjectBlocks==='function') renumberSubjectBlocks(); };
        container.appendChild(block);
      });
      // renumber and show edit UI
      if (typeof renumberSubjectBlocks === 'function') renumberSubjectBlocks();
      editingVisitIndex = idx;
      const addBtn = document.getElementById('addVisitBtn'); if (addBtn) addBtn.textContent = '?몄쭛?ы빆 ???;
      renderVisitsList();
    }

    document.getElementById('addVisitBtn')?.addEventListener('click',()=>{
      const v = buildCurrentVisitObject();
      // 諛⑸Ц???꾩닔
      if (!v.visitDate) { alert('諛⑸Ц?쇱쓣 ?좏깮????諛⑸Ц??異붽??섏꽭??'); const vd = document.getElementById('visitDate'); vd && vd.focus(); return; }
      // basic validation: must have school
      if (!v.school) { alert('?숆탳瑜??좏깮????異붽??섏꽭??'); return; }
      if (editingVisitIndex >= 0) {
        dayVisits[editingVisitIndex] = v;
        resetEditState();
        renderVisitsList();
      } else {
        dayVisits.push(v);
        renderVisitsList();
        // prepare form for next visit
        resetFormForNextVisit();
      }
    });

    // copy to clipboard helper
    async function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try { await navigator.clipboard.writeText(text); return true; } catch(e){ /* fallthrough */ }
      }
      // fallback
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); document.body.removeChild(ta); return true; } catch(e){ document.body.removeChild(ta); return false; }
    }

    document.getElementById('copySummaryBtn')?.addEventListener('click', async ()=>{
      const txt = (document.getElementById('generatedSummary')||{}).value || '';
      if (!txt) { alert('蹂듭궗???붿빟???놁뒿?덈떎. 癒쇱? ?붿빟???앹꽦?섏꽭??'); return; }
      const ok = await copyToClipboard(txt);
      if (ok) { alert('?붿빟???대┰蹂대뱶??蹂듭궗?섏뿀?듬땲??'); } else { alert('蹂듭궗???ㅽ뙣?덉뒿?덈떎. ?섎룞?쇰줈 蹂듭궗?댁＜?몄슂.'); }
    });

    // auto-tag generator
    function buildAutoTags(visits, maxTags=8){
      const tags=[]; if(!visits||!visits.length) return tags;
      const subjCount={}; const schoolCount={}; let contactCount=0; let chatInvite=false; let followUpNeeded=false; let trainingInterest=false;
  const trainingKeywords=/(?곗닔|?곗닔?덈궡|?곗닔臾몄쓽|?뚰겕???곗닔?щ쭩|?곗닔?щ쭩??援먯쑁|援먯쑁?덈궡|援먯쑁?ㅻ챸??援먯썝?곗닔|?곗닔李몄뿬|?곗닔?붿껌|援먯궗?곗닔|吏곷Т?곗닔|?곗닔?좎껌)/i;
      const chatKeywords=/(梨꾪똿|梨꾪똿諛?移댄넚|移댁뭅???붾젅洹몃옩|?쇱씤|硫붿떊?)/i;
      const followKeywords=/(?먮즺|諛쒖넚|異붽?|?щ갑臾??뚰겕遺??섑뵆|?덈궡?먮즺|?먮즺?붿껌)/i;
      visits.forEach(v=>{ if(v.school) schoolCount[v.school]=(schoolCount[v.school]||0)+1; (v.subjects||[]).forEach(s=>{ const name=(s.subject||'').trim(); if(name) subjCount[name]=(subjCount[name]||0)+1; if(s.contact) contactCount++; const meetings=(s.meetings||[]).join(' '); if(chatKeywords.test(meetings)) chatInvite=true; if(s.followUp && followKeywords.test(s.followUp)) followUpNeeded=true; if(s.conversation && trainingKeywords.test(s.conversation)) trainingInterest=true; }); });
  const subjEntries=Object.entries(subjCount).sort((a,b)=>b[1]-a[1]); if(subjEntries.length){ const top=subjEntries.slice(0,3).map(s=>s[0]+(s[1]>1?`(${s[1]}??`:'')); tags.push('二쇱슂怨쇰ぉ: '+top.join(', ')); subjEntries.forEach(([s,c])=>{ if(c>=3) tags.push(s+' ?ㅼ닔 諛⑸Ц'); }); }
      const schoolEntries=Object.entries(schoolCount).sort((a,b)=>b[1]-a[1]); if(schoolEntries.length){ const multi=schoolEntries.filter(e=>e[1]>=2).map(e=>e[0]); if(multi.length) tags.push('?щ갑臾? '+multi.join(', ')); }
      if(contactCount>0) tags.push('?곕씫泥??뺣낫 '+contactCount+'嫄?); if(chatInvite) tags.push('梨꾪똿諛??덈궡'); if(followUpNeeded) tags.push('?먮즺 諛쒖넚 ?꾩슂'); if(trainingInterest) tags.push('?곗닔 愿??);
      const seen=new Set(); const out=[]; for(const t of tags){ if(!seen.has(t)){ seen.add(t); out.push(t); } if(out.length>=Math.max(1,Math.min(50,Math.floor(maxTags)||8))) break; }
      return out;
    }

    document.getElementById('copyKakaoBtn')?.addEventListener('click', async ()=>{
      if (!dayVisits || !dayVisits.length) { alert('癒쇱? 諛⑸Ц??異붽??섏꽭?? (?섎（移?諛⑸Ц???볦뿬 ?덉뼱???⑸땲??'); return; }
      let summary = buildAggregateSummary(dayVisits, 'kakao');
      try{
        const maxTags = parseInt(document.getElementById('optMaxTags')?.value) || 8;
        const includeHuman = document.getElementById('optHumanLine')?.checked !== false;
        const includeHash = document.getElementById('optHashtags')?.checked !== false;
        const tags = buildAutoTags(dayVisits, maxTags);
        if(tags && tags.length){ if(includeHuman) summary += '\n\n?먮룞 ?쒓렇: ' + tags.join(', '); if(includeHash) summary += '\n\n#' + tags.map(t=>t.replace(/[^\p{L}\p{N}]+/gu,'_')).join(' #'); }
      }catch(e){ console.warn('autotag failed', e); }
      const ok = await copyToClipboard(summary);
      if (ok) { alert('移댁뭅?ㅼ슜 ?붿빟???대┰蹂대뱶??蹂듭궗?섏뿀?듬땲?? 移댄넚??遺숈뿬?ｊ린 ?댁＜?몄슂.'); }
      else { alert('蹂듭궗???ㅽ뙣?덉뒿?덈떎. ?앹꽦???붿빟???섎룞?쇰줈 蹂듭궗?댁＜?몄슂.'); }
    });

    // POST dayVisits to backend
    document.getElementById('saveToServerBtn')?.addEventListener('click', async ()=>{
      if (!dayVisits || !dayVisits.length) { alert('??ν븷 諛⑸Ц 湲곕줉???놁뒿?덈떎. 癒쇱? 諛⑸Ц??異붽??섏꽭??'); return; }
      const staff = getStaffFromQuery() || (document.getElementById('staffInfo')||{}).textContent.replace(/^?대떦??\s*/,'').trim();
      const payload = { staff, visits: dayVisits };
      try {
        const res = await fetch('/api/visits', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (res.ok && j && j.ok) { alert('?쒕쾭????λ릺?덉뒿?덈떎. ID: ' + j.id); }
        else { alert('????ㅽ뙣: ' + (j && j.msg ? j.msg : res.statusText)); }
      } catch(e){ alert('?쒕쾭 ???以??ㅻ쪟: ' + e.message); }
    });

    // register service worker for PWA (if available)
    if ('serviceWorker' in navigator) {
      try { navigator.serviceWorker.register('/sw.js'); } catch(e) { /* ignore */ }
    }

    // enhanced generateSummary: uses dayVisits if exists, otherwise single current form
    document.getElementById('genSummaryBtn')?.addEventListener('click', ()=>{
      const template = (document.getElementById('summaryTemplate')||{}).value || 'detailed';
      let visits = dayVisits.length ? dayVisits : [ buildCurrentVisitObject() ];
      const summary = buildAggregateSummary(visits, template);
      const out = document.getElementById('generatedSummary'); if (out) writeGeneratedSummary(reportIntro() + '\n' + summary, { replace: true });
    });

    // report intro/header block to prepend to generated summaries
    function reportIntro() {
      // dynamic header: use URL ?user= parameter when present, otherwise fallback to staffInfo text
      let staffName = '';
      try {
        staffName = getStaffFromQuery() || '';
      } catch(e) { staffName = ''; }
      if (!staffName) {
        const infoEl = document.getElementById('staffInfo');
        if (infoEl && infoEl.textContent) {
          staffName = infoEl.textContent.replace(/^?대떦??\s*/,'').trim();
        }
      }
      if (!staffName) staffName = '?대떦??;
      // normalize base name (remove common title suffixes if present)
      let base = staffName.replace(/\s*(遺??李⑥옣|怨쇱옣|?由??ъ썝)\s*$/,'').trim();
      // mapping to titled names
      const titleMap = {
        '?≫썕??: '?≫썕??遺??,
        '?꾩???: '?꾩???李⑥옣',
        '議곗쁺??: '議곗쁺??遺??
      };
      const displayName = titleMap[base] || staffName;
      const lines = [];
      lines.push(`(${displayName} ?닿렐蹂닿퀬)`);
      lines.push('');
      return lines.join('\n');
    }

    function buildAggregateSummary(visits, template) {
      // aggregate stats
      const totalSchools = visits.length;
      let contactCount = 0;
      let additionalConfirmCount = 0;
      visits.forEach(v => {
        v.subjects.forEach(s => { if (s.contact) contactCount++; if (s.followUp && s.followUp.indexOf('異붽??좎젙')!==-1) additionalConfirmCount++; });
      });

      // helper: Korean ordinal labels 媛, ?? ?? ... fallback to numeric if out of range
      const korLetters = ['媛','??,'??,'??,'留?,'諛?,'??,'??,'??,'李?,'移?,'?','??,'??];
      const getKorLabel = (i) => (korLetters[i] ? korLetters[i] + '.' : (i+1) + '.');

      // treat first visit start as 異쒓렐, last visit end as ?닿렐 (use insertion order)
      const firstStart = (visits && visits.length && visits[0].visitStart) ? visits[0].visitStart : '';
      const lastEnd = (visits && visits.length && visits[visits.length-1].visitEnd) ? visits[visits.length-1].visitEnd : '';

      if (template === 'compact') {
        // one-line per school
        const lines = visits.map((v,i)=>{
          const subjCount = v.subjects.length;
          return `${getKorLabel(i)} ${v.school} ${v.visitStart || ''}-${v.visitEnd || ''} (${subjCount}怨쇰ぉ)`;
        });
        lines.push(`珥?諛⑸Ц ?숆탳: ${totalSchools}媛? ?곕씫泥??뺣낫: ${contactCount}嫄? 異붽??좎젙 ?뺤씤: ${additionalConfirmCount}嫄?);
        return lines.join('\n');
      }

      if (template === 'paragraph') {
        // natural paragraph
        const parts = [];
        parts.push(`${visits[0].visitDate || ''} 諛⑸Ц 蹂닿퀬?낅땲??`.trim());
        visits.forEach((v,i)=>{
          parts.push(`${getKorLabel(i)} ${v.school} (${v.region || ''}) ?먯꽌 ${v.visitStart || ''}遺??${v.visitEnd || ''}源뚯? 諛⑸Ц?섏뿬 ${v.subjects.length}怨쇰ぉ??吏?꾪뻽?듬땲??`);
          v.subjects.forEach(s=>{
            const m = s.meetings && s.meetings.length ? `誘명똿: ${s.meetings.join(', ')}.` : '';
            parts.push(`- ${s.subject} ${s.teacher ? '('+s.teacher+')':''} ${m} ${s.conversation? '?뱀씠?ы빆: '+s.conversation : ''}`);
          });
        });
        parts.push(`珥?${totalSchools}媛??숆탳 諛⑸Ц, ?곕씫泥??뺣낫 ${contactCount}嫄? 異붽??좎젙 ?뺤씤 ${additionalConfirmCount}嫄?`);
        return parts.join('\n');
      }

      if (template === 'kakao') {
        // Group visits by school and format Kakao report
        const parts = [];
        parts.push(reportIntro().trim());
        const rawDate = (visits && visits[0] && visits[0].visitDate) ? String(visits[0].visitDate) : '';
        let displayDate = rawDate;
        try { if (/^\d{4}-\d{2}-\d{2}T/.test(rawDate)) displayDate = rawDate.slice(0,10); else if (/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) displayDate = rawDate; else { const d=new Date(rawDate); if(!isNaN(d.getTime())) displayDate = d.toISOString().slice(0,10); } } catch(e){}
        parts.push(`諛⑸Ц?? ${displayDate}`);
        // count distinct schools
        const schoolGroups = {};
        (visits||[]).forEach(v => { const k = v.school || '-'; schoolGroups[k] = schoolGroups[k] || []; schoolGroups[k].push(v); });
        const distinctSchools = Object.keys(schoolGroups).length;
        let contactCnt = 0; (visits||[]).forEach(v => { (v.subjects||[]).forEach(s => { if (s.contact) contactCnt++; }); });
        parts.push(`珥?諛⑸Ц ?숆탳: ${distinctSchools}媛?쨌 ?곕씫泥??뺣낫: ${contactCnt}嫄?쨌 異붽??좎젙 ?뺤씤: ${additionalConfirmCount}嫄?);
        parts.push('');
        // 異쒓렐/?닿렐
        const firstStart = (visits && visits.length && visits[0].visitStart) ? visits[0].visitStart : '';
        const lastEndTime = (visits && visits.length && visits[visits.length-1].visitEnd) ? visits[visits.length-1].visitEnd : '';
        let workDurationText = '';
        if (firstStart && lastEndTime) { try { const totalMin = calcMinutesInterval(firstStart, lastEndTime); const hrs=Math.floor(totalMin/60); const mins=totalMin%60; workDurationText = ` (洹쇰Т?쒓컙 ${hrs}h ${mins}m)`; } catch(e){} }
        parts.push(`1. 異쒓렐: ${firstStart || '-'} 쨌 ?닿렐: ${lastEndTime || '-'}${workDurationText}`);
        parts.push('');
        // 2. ?몃??낅Т grouped by school
        parts.push('2. ?몃??낅Т');
        parts.push('');
        const korLetters = ['媛','??,'??,'??,'留?,'諛?,'??,'??,'??,'李?,'移?,'?','??,'??];
        Object.keys(schoolGroups).forEach((schoolName, sIdx) => {
          const label = korLetters[sIdx] || String(sIdx+1);
          parts.push(`${label}. ${schoolName}`);
          const arr = schoolGroups[schoolName];
          arr.forEach((entry, eIdx) => {
            const subjects = entry.subjects || [];
            if (subjects.length === 0) {
              parts.push(`${label}${eIdx+1} : ${entry.visitStart||''}~${entry.visitEnd||''}`);
            } else {
              subjects.forEach(s => {
                const teacher = s.teacher ? `(${s.teacher})` : '';
                const follow = s.followUp ? ` 쨌 ?꾩냽:${s.followUp}` : '';
                const conv = s.conversation ? ` 쨌 ?뱀씠?ы빆:${s.conversation}` : '';
                parts.push(`${label}${eIdx+1} : ${s.subject || '-'} ${teacher}${follow}${conv}`.trim());
              });
            }
          });
          parts.push('');
        });
        return parts.join('\n');
      }

      // detailed (default): header + per-visit block with per-subject rows
      const lines = [];
      lines.push(`諛⑸Ц?? ${visits[0].visitDate || ''}`);
      lines.push(`珥?諛⑸Ц ?숆탳: ${totalSchools}媛?);
      lines.push(`異쒓렐: ${firstStart || '-'} | ?닿렐: ${lastEnd || '-'}`);
      lines.push(`?곕씫泥??뺣낫: ${contactCount}嫄?| 異붽??좎젙 ?뺤씤: ${additionalConfirmCount}嫄?);
      lines.push('');
      visits.forEach((v, idx)=>{
        lines.push(`${getKorLabel(idx)} ${v.school} ??${v.region || ''} (${v.visitStart || ''} ~ ${v.visitEnd || ''})`);
        lines.push('?몃??낅Т:');
        v.subjects.forEach(s=>{
          const meetings = s.meetings && s.meetings.length ? `[${s.meetings.join(', ')}] ` : '';
          const follow = s.followUp ? `?붾줈??${s.followUp} ` : '';
          const conv = s.conversation ? `?뱀씠?ы빆:${s.conversation}` : '';
          lines.push(` - ${s.subject} / ${s.teacher || '-'} / ${s.publisher || '-'} ${meetings}${follow}${conv}`.trim());
        });
        lines.push('');
      });
      return lines.join('\n');
    }

    // format a single visit into a readable paragraph (used for appending to the textarea)
    function formatVisitText(v, idx) {
      const lines = [];
      // plain structured per-visit representation (no emojis)
      const timeRange = (v.visitStart || '') && (v.visitEnd || '') ? `${v.visitStart}~${v.visitEnd}` : '';
      const duration = (v.visitStart && v.visitEnd) ? ` (${calcMinutesInterval(v.visitStart,v.visitEnd)}遺?` : '';
      lines.push(`${idx+1}. ${v.school || '-'} (${v.region || '-'}) ${timeRange}${duration}`);
      v.subjects.forEach(s=>{
        const segs = [];
        segs.push(s.subject || '-');
        if (s.teacher) segs.push(s.teacher);
        if (s.publisher) segs.push(s.publisher);
        if (s.meetings && s.meetings.length) segs.push(s.meetings.join('/'));
  // do not include contact value in generated text (kept for backend only)
        if (s.followUp) segs.push(`?꾩냽:${s.followUp}`);
        if (s.conversation) segs.push(`?뱀씠:${s.conversation}`);
        lines.push(' - ' + segs.join(' 쨌 '));
      });
      lines.push('');
      return lines.join('\n');
    }

    // add minutes to time string 'HH:MM' and return 'HH:MM' (24-hour wrap)
    function addMinutesToTime(timeStr, minutesToAdd) {
      if (!timeStr || typeof timeStr !== 'string') return '';
      const parts = timeStr.split(':');
      if (parts.length < 2) return '';
      const hh = parseInt(parts[0],10); const mm = parseInt(parts[1],10);
      if (isNaN(hh) || isNaN(mm)) return '';
      const total = hh * 60 + mm + parseInt(minutesToAdd,10);
      const wrapped = (total + 24*60) % (24*60);
      const newH = Math.floor(wrapped/60);
      const newM = wrapped % 60;
      return pad2(newH) + ':' + pad2(newM);
    }

    // robust writer for #generatedSummary: temporarily clear readonly, write (append or replace)
    function writeGeneratedSummary(text, opts) {
      // opts: { replace: boolean }
      opts = opts || {};
      const ta = document.getElementById('generatedSummary');
      if (!ta) { console.warn('writeGeneratedSummary: textarea not found'); return; }
      // perform write on next tick to avoid interference with other DOM updates
      setTimeout(() => {
        const wasReadOnly = ta.hasAttribute('readonly');
        try {
          if (wasReadOnly) ta.removeAttribute('readonly');
          if (opts.replace) {
            ta.value = text || '';
          } else {
            // append ensuring a trailing newline separator
            const cur = ta.value || '';
            ta.value = (cur && cur.trim() && !cur.endsWith('\n') ? cur + '\n' : cur) + (text || '');
          }
          // dispatch input event so any listeners notice the change
          try { ta.dispatchEvent(new Event('input', { bubbles: true })); } catch(e){}
          // scroll to bottom so new content is visible
          ta.scrollTop = ta.scrollHeight;
        } finally {
          // restore readonly state if it existed
          if (wasReadOnly) ta.setAttribute('readonly','');
        }
      }, 40);
    }

    (function checkProtocolAndWarn(){
      if (window.location.protocol === 'file:') {
        const container = document.getElementById('step1');
        container.innerHTML = `
          <div style="padding:1.2rem;border:2px solid #ffdcdc;background:#fff5f5;border-radius:0.8rem;">
            <h3 style="margin:0 0 .5rem 0;color:#a33;">?뚯씪?먯꽌 吏곸젒 ?대젮 ?덉뒿?덈떎 ??CSV瑜?遺덈윭?????놁뒿?덈떎</h3>
            <div style="color:#333;margin-bottom:.6rem;">???섏씠吏??CSV ?뚯씪??釉뚮씪?곗??먯꽌 遺덈윭?ㅺ린 ?꾪빐 HTTP濡??쒕튃?섏뼱???⑸땲?? ?꾩옱 ?뚯씪 ?꾨줈?좎퐳(file://)濡??대젮 ?덉뼱 釉뚮씪?곗?媛 ?몃? 由ъ냼??fetch)瑜?李⑤떒?⑸땲??</div>
            <div style="font-size:0.95rem;color:#333;margin-bottom:.6rem;">沅뚯옣: ?대떦 ?대뜑?먯꽌 媛꾨떒??HTTP ?쒕쾭瑜?耳쒓퀬 ?꾨옒 URL濡??묒냽?섏꽭??</div>
            <pre style="background:#f6f8ff;border-radius:6px;padding:.6rem;color:#0b2b5a">python -m http.server 8000</pre>
            <div style="margin-top:.6rem;display:flex;gap:.5rem;">
              <button id="copyCmd" style="padding:.5rem 1rem;border-radius:.5rem;border:none;background:#1e3c72;color:#fff;cursor:pointer;">紐낅졊??蹂듭궗</button>
              <button id="openGuide" style="padding:.5rem 1rem;border-radius:.5rem;border:1px solid #ddd;background:#fff;cursor:pointer;">?쒕쾭 ?ㅽ뻾 媛?대뱶 蹂닿린</button>
            </div>
            <div style="margin-top:.6rem;color:#666;font-size:.9rem;">李멸퀬: ?쒕쾭 ?ㅽ뻾 ??釉뚮씪?곗??먯꽌 <code>http://localhost:8000/sales-input.html?user=?≫썕??/code> 濡??묒냽?섏꽭??</div>
          </div>`;
        document.getElementById('copyCmd').addEventListener('click', () => {
          navigator.clipboard && navigator.clipboard.writeText('python -m http.server 8000');
          alert('紐낅졊?닿? ?대┰蹂대뱶??蹂듭궗?섏뿀?듬땲?? PowerShell?먯꽌 遺숈뿬?ｊ린 ?섏뿬 ?ㅽ뻾?섏꽭??');
        });
        document.getElementById('openGuide').addEventListener('click', () => {
          alert('PowerShell ?먮뒗 ?곕??먯뿉???꾨줈?앺듃 猷⑦듃 ?대뜑濡??대룞????\ncd "C:\\Users\\PC\\Desktop\\議곌꼍???낅Т\\flask-web-app\\cmass-sales-system"; python -m http.server 8000\n洹??ㅼ쓬 釉뚮씪?곗??먯꽌 http://localhost:8000/sales-input.html?user=?≫썕??濡??쎈땲??');
        });
        // Prevent the rest of the script from running (skip fetch)
        return;
      }
    })();

    // sales_staff.csv 湲곕컲 ?대떦?먮퀎 吏???숆탳紐?2???쒕∼?ㅼ슫 (PapaParse ?ъ슜)
    function getStaffFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get('user') || '';
    }
    let staffData = [];
    document.addEventListener('DOMContentLoaded', function() {
      // utility to normalize strings: remove BOM, collapse newlines and excessive spaces but keep internal spaces
      const clean = s => {
        if (s === null || s === undefined) return '';
        let str = String(s);
        // remove leading BOM
        str = str.replace(/^\uFEFF/, '');
        // replace newlines/carriage returns with a single space
        str = str.replace(/[\r\n]+/g, ' ');
        // collapse multiple spaces/tabs into one
        str = str.replace(/\s+/g, ' ').trim();
        return str;
      };
      let staffParam = '';
      let staff = getStaffFromQuery();
      if (!staff) {
        staff = '?≫썕??遺??;
      }
      document.getElementById('staffInfo').textContent = '?대떦?? ' + staff;
      // step1(泥??붾㈃) ?④린怨?step2(?낅젰 ?붾㈃) 蹂댁씠湲?
          var step1 = document.getElementById('step1');
          var step2 = document.getElementById('step2');
          // Do NOT auto-advance to step2 on page load. Require the user to click '?ㅼ쓬'.
          // if (step1 && step2) {
          //   step1.style.display = 'none';
          //   step2.style.display = 'block';
          // }
      fetch('sales_staff.csv')
        .then(res => res.text())
        .then(csv => {
          // 而щ읆紐낆뿉 怨듬갚/以꾨컮轅?BOM ???뱀닔臾몄옄 ?덉뼱???몃뜳??湲곕컲 ?묎렐
          const parsed = Papa.parse(csv, {header: true, skipEmptyLines: true});
          staffData = parsed.data.map(row => {
            const keys = Object.keys(row);
            const staffVal = clean(row['?대떦??] || row[keys[keys.length-1]]);
            const region = clean(row['吏??] || row[keys[2]]);
            const school = clean(row['?숆탳紐?] || row[keys[4]]);
            const establish = clean(row['?ㅻ┰援щ텇'] || row['?ㅻ┰援щ텇'] || row[keys.indexOf('?ㅻ┰援щ텇')>-1? '?ㅻ┰援щ텇' : keys[6]] || '');
            const level = clean(row['?숆탳湲?] || row['?숆탳湲?] || row[keys.indexOf('?숆탳湲?)>-1? '?숆탳湲? : keys[keys.length-2]] || '');
            const g1_class = clean(row['1?숇뀈?숆툒??] || row[keys.indexOf('1?숇뀈?숆툒??)>-1? '1?숇뀈?숆툒?? : keys[10]] || '');
            const g1_students = clean(row['1?숇뀈?숈깮??] || row[keys.indexOf('1?숇뀈?숈깮??)>-1? '1?숇뀈?숈깮?? : keys[11]] || '');
            const g2_class = clean(row['2?숇뀈?숆툒??] || row[keys.indexOf('2?숇뀈?숆툒??)>-1? '2?숇뀈?숆툒?? : keys[13]] || '');
            const g2_students = clean(row['2?숇뀈?숈깮??] || row[keys.indexOf('2?숇뀈?숈깮??)>-1? '2?숇뀈?숈깮?? : keys[14]] || '');
            const g3_class = clean(row['3?숇뀈?숆툒??] || row[keys.indexOf('3?숇뀈?숆툒??)>-1? '3?숇뀈?숆툒?? : keys[16]] || '');
            const g3_students = clean(row['3?숇뀈?숈깮??] || row[keys.indexOf('3?숇뀈?숈깮??)>-1? '3?숇뀈?숈깮?? : keys[17]] || '');
            return { staff: staffVal, region, school, establish, level, g1_class, g1_students, g2_class, g2_students, g3_class, g3_students };
          });
          console.log('parsed rows count:', parsed.data.length);
          console.log('staffData (sample 5):', staffData.slice(0,5));
          console.log('staffData length:', staffData.length);
          const regionButtons = document.getElementById('regionButtons');
          regionButtons.innerHTML = '';
          // staff 蹂?섎룄 ?숈씪?섍쾶 ?뺤젣?댁꽌 鍮꾧탳
          // normalize early so defaults like '?≫썕??遺?? match CSV '?≫썕??
          const normalizeStaffImmediate = s => (s||'').toString().replace(/\s*(遺??怨쇱옣|????좎깮???좎깮)/g,'').trim();
          staffParam = normalizeStaffImmediate(clean(staff));
          console.log('staffParam:', staffParam);
          // initialize generatedSummary textarea with report intro header
          const gen = document.getElementById('generatedSummary');
          if (gen) {
            // if textarea contains the placeholder text, replace with intro
            const cur = (gen.value || '').trim();
            if (!cur || cur === '?붿빟???ш린???앹꽦?⑸땲??') {
              // use writeGeneratedSummary replace to ensure readonly handling is consistent
              writeGeneratedSummary(reportIntro(), { replace: true });
            }
          }
          const matchedRowsExact = staffData.filter(d => d.staff === staffParam);
          let matchedRows = matchedRowsExact.slice();
          // normalize staff names (remove common titles like '遺??) for tolerant matching
          const normalizeStaff = s => (s||'').toString().replace(/\s*(遺??怨쇱옣|????좎깮???좎깮)/g, '').trim();
          // tolerant mappings for common latin usernames -> Korean names
          const staffMap = {
            'Songhoonjae': '?≫썕??,
            'ChoYounghwan': '議곗쁺??,
            'LimJunho': '?꾩???
          };
          // canonicalization: if a legacy lowercase token is present in URL, replace it with the canonical token
          (function(){
            try {
              const params = new URLSearchParams(window.location.search);
              const u = params.get('user');
              if (!u) return;
              const lower = u.toLowerCase();
              const map = { songhunje: 'Songhoonjae', songhoonjae: 'Songhoonjae', imjunho: 'LimJunho', limjunho: 'LimJunho', joyounghwan: 'ChoYounghwan', choyounghwan: 'ChoYounghwan' };
              const c = map[lower];
              if (c && c !== u) {
                history.replaceState(null, '', window.location.pathname + '?user=' + c + (window.location.hash || ''));
              }
            } catch(e){}
          })();
          // if no exact matches, try mapping or partial contains matches
          if (!matchedRows.length) {
            const lowerParam = staffParam.toLowerCase();
            if (staffMap[lowerParam]) {
              const mapped = staffMap[lowerParam];
              matchedRows = staffData.filter(d => d.staff === mapped);
              if (matchedRows.length) {
                console.log('Mapped user param', staffParam, '->', mapped);
                staffParam = mapped;
              }
            }
          }
          if (!matchedRows.length) {
            // partial contains match: staff names that include param or vice versa
            matchedRows = staffData.filter(d => {
              const a = (d.staff||'').toString();
              const b = (staffParam||'').toString();
              return (a && a.indexOf(b) > -1) || (b && b.indexOf(a) > -1) || (normalizeStaff(a) && normalizeStaff(a).indexOf(normalizeStaff(b)) > -1) || (normalizeStaff(b) && normalizeStaff(b).indexOf(normalizeStaff(a)) > -1);
            });
            if (matchedRows.length) console.log('Partial-match rows found for', staffParam, matchedRows.length);
          }
          console.log('matchedRows count:', matchedRows.length);
          let regions = [...new Set(matchedRows.map(d => d.region))];
          // fallback: if this staff has no mapped regions, show all regions and mark as fallback
          let usedFallback = false;
          if (!regions.length) {
            regions = [...new Set(staffData.map(d => d.region))];
            usedFallback = true;
            console.warn('No regions found for', staffParam, '- falling back to full region list');
          }
          console.log('regions:', regions);
          // create region buttons
          regions.forEach(region => {
            if (region) {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'grid-button';
              btn.dataset.region = region;
              btn.setAttribute('role','option');
              btn.setAttribute('aria-selected','false');
              btn.tabIndex = 0;
              btn.textContent = region;
              btn.title = region;
              regionButtons.appendChild(btn);
            }
          });
          if (usedFallback) {
            const note = document.createElement('div');
            note.style.fontSize = '0.9rem';
            note.style.color = '#666';
            note.style.marginTop = '0.4rem';
            note.textContent = '???대떦 ?대떦?먯뿉 留ㅽ븨???숆탳媛 ?놁뼱 ?꾩껜 紐⑸줉???쒖떆?⑸땲??';
            regionButtons.parentNode.insertBefore(note, regionButtons.nextSibling);
          }
          // selection state
          let selectedRegion = '';
          let selectedSchool = '';
          const schoolButtons = document.getElementById('schoolButtons');
          // delegate region clicks
          regionButtons.addEventListener('click', (ev) => {
            const b = ev.target.closest('.grid-button');
            if (!b) return;
            selectedRegion = b.dataset.region;
            // update selected style and aria
            regionButtons.querySelectorAll('.grid-button').forEach(x => { x.classList.remove('selected'); x.setAttribute('aria-selected','false'); });
            b.classList.add('selected'); b.setAttribute('aria-selected','true');
            // populate schools for selected region
            schoolButtons.innerHTML = '';
            selectedSchool = '';
            const schools = [...new Set(
  staffData.filter(d => 
    d.region === selectedRegion && (d.staff.includes(staffParam) || normalizeStaff(d.staff) === normalizeStaff(staffParam))
  ).map(d => d.school)
)];
            schools.forEach(school => {
              if (school) {
                const sb = document.createElement('button');
                sb.type = 'button';
                sb.className = 'grid-button';
                sb.dataset.school = school;
                sb.setAttribute('role','option');
                sb.setAttribute('aria-selected','false');
                sb.tabIndex = 0;
                sb.textContent = school;
                sb.title = school;
                schoolButtons.appendChild(sb);
              }
            });
          });
          // delegate school clicks - show metadata and set hidden inputs
          schoolButtons.addEventListener('click', (ev) => {
            const b = ev.target.closest('.grid-button');
            if (!b) return;
            selectedSchool = b.dataset.school;
            schoolButtons.querySelectorAll('.grid-button').forEach(x => { x.classList.remove('selected'); x.setAttribute('aria-selected','false'); });
            b.classList.add('selected'); b.setAttribute('aria-selected','true');
            // populate hidden inputs and visible display
            document.getElementById('selectedRegionInput').value = selectedRegion;
            document.getElementById('selectedSchoolInput').value = selectedSchool;
            document.getElementById('displayRegion').textContent = selectedRegion;
            document.getElementById('displaySchool').textContent = selectedSchool;
            document.getElementById('selectedInfo').style.display = 'block';
            // find metadata row (match by staff, region, school)
            const meta = staffData.find(d => d.staff === staffParam && d.region === selectedRegion && d.school === selectedSchool);
            if (meta) {
              // Step2 metadata panel
              document.getElementById('schoolMeta').style.display = 'block';
              (function(){ const el1 = document.getElementById('metaEstablish'); if(el1) el1.textContent = meta.establish || ''; const el2 = document.getElementById('metaLevel'); if(el2) el2.textContent = meta.level || ''; })();
              document.getElementById('metaG1c').textContent = meta.g1_class || '-';
              document.getElementById('metaG1s').textContent = meta.g1_students || '-';
              document.getElementById('metaG2c').textContent = meta.g2_class || '-';
              document.getElementById('metaG2s').textContent = meta.g2_students || '-';
              document.getElementById('metaG3c').textContent = meta.g3_class || '-';
              document.getElementById('metaG3s').textContent = meta.g3_students || '-';
              // update meta-summary pills
              document.getElementById('metaPillEstablish').textContent = (meta.establish || '-');
              document.getElementById('metaPillLevel').textContent = (meta.level || '-');
              // compute total students where numeric
              const toNum = v => { const n = parseInt((v||'').toString().replace(/[^0-9]/g,''),10); return isNaN(n)?0:n; };
              const totalStudents = toNum(meta.g1_students) + toNum(meta.g2_students) + toNum(meta.g3_students);
              document.getElementById('metaPillStudents').textContent = '珥앺븰?앹닔: ' + (totalStudents > 0 ? totalStudents : '-');
              // Inline immediate metadata
              document.getElementById('schoolMetaInline').style.display = 'block';
              (function(){ const i1 = document.getElementById('inlineEstablish'); if(i1) i1.textContent = meta.establish || ''; const i2 = document.getElementById('inlineLevel'); if(i2) i2.textContent = meta.level || ''; })();
              document.getElementById('inlineG1c').textContent = meta.g1_class || '-';
              document.getElementById('inlineG1s').textContent = meta.g1_students || '-';
              document.getElementById('inlineG2c').textContent = meta.g2_class || '-';
              document.getElementById('inlineG2s').textContent = meta.g2_students || '-';
              document.getElementById('inlineG3c').textContent = meta.g3_class || '-';
              document.getElementById('inlineG3s').textContent = meta.g3_students || '-';
              document.getElementById('inlinePillEstablish').textContent = (meta.establish || '-');
              document.getElementById('inlinePillLevel').textContent = (meta.level || '-');
              document.getElementById('inlinePillStudents').textContent = '珥앺븰?앹닔: ' + (totalStudents > 0 ? totalStudents : '-');
            } else {
              document.getElementById('schoolMeta').style.display = 'none';
              document.getElementById('schoolMetaInline').style.display = 'none';
            }
            // focus management: move focus to Next button
            document.getElementById('nextStepBtn').focus();
          });

          // keyboard navigation for grids (arrow keys)
          function makeGridKeyboardNav(container) {
            container.addEventListener('keydown', (ev) => {
              const keys = ['ArrowRight','ArrowLeft','ArrowDown','ArrowUp'];
              if (!keys.includes(ev.key)) return;
              ev.preventDefault();
              const buttons = Array.from(container.querySelectorAll('.grid-button'));
              if (!buttons.length) return;
              const idx = buttons.indexOf(document.activeElement);
              let next = 0;
              if (ev.key === 'ArrowRight' || ev.key === 'ArrowDown') next = (idx + 1) % buttons.length;
              if (ev.key === 'ArrowLeft' || ev.key === 'ArrowUp') next = (idx - 1 + buttons.length) % buttons.length;
              buttons[next].focus();
            });
          }
          makeGridKeyboardNav(regionButtons);
          makeGridKeyboardNav(schoolButtons);

          // next step button: read selected region/school from button state
          document.getElementById('nextStepBtn').addEventListener('click', function() {
            // 諛⑸Ц???꾩닔 寃??
            const vd = document.getElementById('visitDate');
            if (!vd || !vd.value) {
              alert('諛⑸Ц?쇱쓣 ?낅젰?섏꽭??');
              vd && vd.focus();
              return;
            }
            // `selectedRegion` and `selectedSchool` captured in closure above
            if (!selectedRegion || !selectedSchool) {
              alert('吏??낵 ?숆탳紐낆쓣 紐⑤몢 ?좏깮?섏꽭??');
              return;
            }
            // set visible fields in step2 if needed (e.g., fill a display or hidden inputs)
            const blocks = document.querySelectorAll('.subject-name');
            if (blocks && blocks.length) {
              // no-op now; could prefill schoolName into a hidden input if desired
            }
            // reset time fields each time we enter step2
            try { resetTimeFields(); } catch(e){}
            // hide step1 / show step2
            document.getElementById('step1').style.display = 'none';
            if (typeof ALLOW_AUTO_ADVANCE !== 'undefined' && ALLOW_AUTO_ADVANCE) document.getElementById('step2').style.display = 'block';
            try { if (typeof window.scrollTo === 'function') window.scrollTo({ top: 0, behavior: 'auto' }); if (document.body) document.body.scrollTop = 0; if (document.documentElement) document.documentElement.scrollTop = 0; } catch(e){}
          });
          // --- duration buttons and time calculation ---
          // create duration buttons 10,20,...,90
          const durationContainer = document.getElementById('durationButtons');
          const durationValues = [10,20,30,40,50,60,70,80,90];
          durationValues.forEach(v => {
            const db = document.createElement('button');
            db.type = 'button';
            db.className = 'grid-button';
            db.dataset.minutes = String(v);
            db.textContent = v + '遺?;
            db.title = v + '遺?;
            durationContainer.appendChild(db);
          });

          // support both old input (#visitStart) and new selects (#visitStartHour/#visitStartMinute)
          const visitStartInput = document.getElementById('visitStart');
          const visitStartHour = document.getElementById('visitStartHour');
          const visitStartMinute = document.getElementById('visitStartMinute');
          const visitEndInput = document.getElementById('visitEnd');
          const visitDurationInput = document.getElementById('visitDuration');
          const selectedDurationInput = document.getElementById('selectedDurationInput');
          const clearDurationBtn = document.getElementById('clearDuration');

          function pad2(n){ return (n<10? '0' : '') + n; }
          function computeEndFromStartAndMinutes(startValue, minutes){
            if (!startValue) return '';
            // startValue is 'HH:MM'
            const parts = startValue.split(':');
            if (parts.length < 2) return '';
            let hh = parseInt(parts[0],10);
            let mm = parseInt(parts[1],10);
            if (isNaN(hh) || isNaN(mm)) return '';
            const total = hh*60 + mm + Number(minutes);
            const endHH = Math.floor((total % (24*60)) / 60);
            const endMM = total % 60;
            return pad2(endHH) + ':' + pad2(endMM);
          }

          // reset time-related fields (start selects, duration buttons/inputs, end input)
          function resetTimeFields() {
            try {
              const vsh = document.getElementById('visitStartHour');
              const vsm = document.getElementById('visitStartMinute');
              const vdur = document.getElementById('visitDuration');
              const sdur = document.getElementById('selectedDurationInput');
              const durContainer = document.getElementById('durationButtons');
              const vend = document.getElementById('visitEnd');
              if (vsh) vsh.value = pad2(8);
              if (vsm) vsm.value = pad2(0);
              if (vdur) vdur.value = '';
              if (sdur) sdur.value = '';
              if (durContainer) durContainer.querySelectorAll('.grid-button').forEach(b=>b.classList.remove('selected'));
              if (vend) vend.value = '';
            } catch(e) { console.warn('resetTimeFields error', e); }
          }
          // initialize time fields on page load
          try { resetTimeFields(); } catch(e){}

          // populate hour/minute selects (00-23, 00-59) and set default to current time
          if (visitStartHour && visitStartMinute) {
            // clear any existing options
            visitStartHour.innerHTML = '';
            visitStartMinute.innerHTML = '';
            // start hours at 08??(skip early-morning hours)
            for (let h = 8; h < 24; h++){
              const o = document.createElement('option'); o.value = pad2(h); o.textContent = pad2(h) + '??; visitStartHour.appendChild(o);
            }
            for (let m = 0; m < 60; m += 5){
              const o = document.createElement('option'); o.value = pad2(m); o.textContent = pad2(m) + '遺?; visitStartMinute.appendChild(o);
            }
            const now = new Date();
            // default hour set to 08 on landing
            visitStartHour.value = pad2(8);
            // round minutes to nearest 5-minute interval and clamp (e.g., 58 -> 55)
            let roundedMin = Math.round(now.getMinutes() / 5) * 5;
            if (roundedMin >= 60) roundedMin = 55;
            visitStartMinute.value = pad2(roundedMin);
          }

          // click handler for duration buttons
          durationContainer.addEventListener('click', (ev) => {
            const b = ev.target.closest('.grid-button');
            if (!b) return;
            const minutes = Number(b.dataset.minutes || 0);
            // style selected
            durationContainer.querySelectorAll('.grid-button').forEach(x => x.classList.remove('selected'));
            b.classList.add('selected');
            // set numeric input and hidden
            visitDurationInput.value = minutes;
            selectedDurationInput.value = minutes;
            // compute end time if start present (support old input or new selects)
            const startVal = visitStartInput ? visitStartInput.value : (visitStartHour && visitStartMinute ? (visitStartHour.value + ':' + visitStartMinute.value) : '');
            const endVal = computeEndFromStartAndMinutes(startVal, minutes);
            if (endVal) visitEndInput.value = endVal;
          });

          // when start time changes, recompute end if duration exists
          const onStartChange = () => {
            const minutes = Number(selectedDurationInput.value || visitDurationInput.value || 0);
            if (minutes > 0) {
              const startVal = visitStartInput ? visitStartInput.value : (visitStartHour && visitStartMinute ? (visitStartHour.value + ':' + visitStartMinute.value) : '');
              const endVal = computeEndFromStartAndMinutes(startVal, minutes);
              if (endVal) visitEndInput.value = endVal;
            }
          };
          if (visitStartInput) visitStartInput.addEventListener('change', onStartChange);
          if (visitStartHour) visitStartHour.addEventListener('change', onStartChange);
          if (visitStartMinute) visitStartMinute.addEventListener('change', onStartChange);

          // allow manual numeric input of duration (keeps buttons unselected)
          visitDurationInput.addEventListener('input', () => {
            const v = Number(visitDurationInput.value || 0);
            selectedDurationInput.value = v > 0 ? v : '';
            // clear selected button states if not equal to a button value
            durationContainer.querySelectorAll('.grid-button').forEach(x => x.classList.toggle('selected', Number(x.dataset.minutes) === v));
            if (v > 0) {
              const startVal = visitStartInput ? visitStartInput.value : (visitStartHour && visitStartMinute ? (visitStartHour.value + ':' + visitStartMinute.value) : '');
              const endVal = computeEndFromStartAndMinutes(startVal, v);
              if (endVal) visitEndInput.value = endVal;
            }
          });

          clearDurationBtn.addEventListener('click', () => {
            visitDurationInput.value = '';
            selectedDurationInput.value = '';
            visitEndInput.value = '';
            durationContainer.querySelectorAll('.grid-button').forEach(x => x.classList.remove('selected'));
          });
          
          // contact formatting helper: turn '12345678' -> '010-1234-5678'
          function formatContact(suffix) {
            const digits = (suffix || '').toString().replace(/\D+/g,'').slice(0,8);
            if (!digits) return '';
            if (digits.length <=4) return '010-' + digits;
            return '010-' + digits.slice(0,4) + '-' + digits.slice(4);
          }

          // when contact inputs change, update formatted span
          document.getElementById('subjectsBlock').addEventListener('input', function(e){
            if (e.target && e.target.classList && e.target.classList.contains('contact-suffix')){
              const cleaned = (e.target.value||'').replace(/\D+/g,'').slice(0,8);
              if (cleaned !== e.target.value) e.target.value = cleaned;
              const parent = e.target.closest('.subject-block') || e.target.parentNode;
              const fmt = parent.querySelector('.contact-formatted');
              if (fmt) fmt.textContent = formatContact(cleaned);
            }
          });

          // copy-to-clipboard for contact buttons
          document.getElementById('subjectsBlock').addEventListener('click', function(e){
            if (e.target && e.target.classList && e.target.classList.contains('copy-contact')){
              const sb = e.target.closest('.subject-block');
              if (!sb) return;
              const suffix = sb.querySelector('.contact-suffix') ? sb.querySelector('.contact-suffix').value : '';
              const formatted = formatContact(suffix);
              if (!formatted) { alert('?곕씫泥섍? ?낅젰?섏뼱 ?덉? ?딆뒿?덈떎.'); return; }
              navigator.clipboard && navigator.clipboard.writeText(formatted);
              // small feedback
              e.target.textContent = '蹂듭궗??;
              setTimeout(()=> e.target.textContent = '蹂듭궗', 1200);
            }
          });
          // subject choice buttons: set hidden .subject-name value and toggle selected style
          document.getElementById('subjectsBlock').addEventListener('click', function(e){
            const btn = e.target.closest('.subject-choice');
            if (!btn) return;
            const sb = btn.closest('.subject-block');
            if (!sb) return;
            // set hidden input value
            const hidden = sb.querySelector('.subject-name');
            if (hidden) hidden.value = btn.dataset.subject || '';
            // toggle selected styling among siblings
            const parent = sb.querySelector('.subjects');
            if (parent) parent.querySelectorAll('.subject-choice').forEach(x => x.classList.remove('selected'));
            btn.classList.add('selected');
            // also update info-extra-buttons visibility
            setTimeout(updateInfoButtons, 0);
          });
          // number subject blocks on initial load
          if (typeof renumberSubjectBlocks === 'function') renumberSubjectBlocks();
        });
    });
    // 怨쇰ぉ/?좎깮??異붽? 湲곕뒫
    document.getElementById('addSubjectBtn').addEventListener('click', function() {
      const block = document.createElement('div');
      block.className = 'subject-block';
      block.innerHTML = `
        <input type="hidden" class="subject-name" required>
  <div class="subjects" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:8px;">
          <button type="button" class="grid-button subject-choice" data-subject="?뺣낫">?뺣낫</button>
          <button type="button" class="grid-button subject-choice" data-subject="吏꾨줈">吏꾨줈</button>
          <button type="button" class="grid-button subject-choice" data-subject="湲곗닠媛??>湲곗닠媛??/button>
            <button type="button" class="grid-button subject-choice" data-subject="?쒕Ц">?쒕Ц</button>
        </div>
        <input type="text" class="teacher-name" placeholder="?좎깮???대쫫" required>
        <select class="publisher">
          <option value="">異쒗뙋???좏깮</option>
          <option>泥쒖옱</option><option>鍮꾩긽</option><option>?숈븘</option><option>?쇱뼇</option><option>湲고?</option>
        </select>
        <div style="margin-top:0.6rem;">
          <label style="font-weight:700;display:block;margin-bottom:6px;">?꾩냽議곗튂</label>
          <select class="followUpSelect" style="width:100%;padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;">
            <option value="">?좏깮?섏꽭??/option>
            <option>梨꾪똿諛?吏??愿由?/option>
            <option>異붽? ?먮즺 諛쒖넚 ?덉젙</option>
            <option>?щ갑臾??덉젙</option>
            <option>?좎젙 ?쒓린 ?곕씫 ?湲?/option>
            <option>?뚰겕遺?臾댁긽吏???쒖븞</option>
            <option>?꾨즺 (異붽? 議곗튂 ?놁쓬)</option>
          </select>
        </div>
        <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
          <label style="font-weight:700;min-width:38px;">?곕씫泥?/label>
          <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
            <span style="display:inline-block;padding:.55rem .7rem;border-radius:.6rem;background:#f2f4ff;border:1px solid #d6dbe8;color:#12325a;font-weight:700;">010</span>
            <input type="text" class="contact-suffix" placeholder="12345678" maxlength="8" inputmode="numeric" pattern="[0-9]*" style="width:120px;padding:.55rem .6rem;border-radius:.6rem;border:1px solid #d6dbe8;">
            <span class="contact-formatted" style="margin-left:8px;color:#103254;font-weight:700;"></span>
            <button type="button" class="copy-contact" style="margin-left:6px;padding:.4rem .6rem;border-radius:.5rem;border:1px solid #d6dbe8;background:#fff;cursor:pointer;">蹂듭궗</button>
          </div>
        </div>
          <div style="margin-top:16px;"></div>
          <div class="meeting-buttons main-meeting-buttons">
          <button class="meeting-btn" type="button">紐낇븿?몄궗</button>
          <button class="meeting-btn" type="button">?곗묶?섏냼媛?/button>
          <button class="meeting-btn" type="button">梨꾪똿諛⑹냼媛?/button>
          <button class="meeting-btn" type="button">誘명똿遺덇?</button>
        </div>
          <div class="meeting-buttons info-extra-buttons" style="display:none;">
          <button class="meeting-btn" type="button">援ш??대옒?ㅻ８ ?ъ슜</button>
          <button class="meeting-btn" type="button">?⑤뱾???ъ슜</button>
          <button class="meeting-btn" type="button">?섏씠?щ떇 ?ъ슜</button>
        </div>
  <textarea class="conversation-detail" rows="2" placeholder="?뱀씠?ы빆"></textarea>
  <button type="button" class="removeSubjectBtn" style="margin:0.5rem 0 1rem 0;padding:0.5rem 1rem;font-size:1rem;border-radius:0.7rem;background:#ff9800;color:#fff;border:none;cursor:pointer;">??젣</button>
      `;
      block.querySelector('.removeSubjectBtn').onclick = function() {
        block.remove();
        // renumber after removal
        if (typeof renumberSubjectBlocks === 'function') renumberSubjectBlocks();
      };
      document.getElementById('subjectsBlock').appendChild(block);
      // renumber after adding
      if (typeof renumberSubjectBlocks === 'function') renumberSubjectBlocks();
    });
    // sanitize contact input: only digits, max 8
    document.getElementById('subjectsBlock').addEventListener('input', function(e) {
      if (e.target && e.target.classList && e.target.classList.contains('contact-suffix')) {
        // remove non-digits and limit to 8
        const cleaned = (e.target.value || '').replace(/\D+/g, '').slice(0,8);
        if (cleaned !== e.target.value) e.target.value = cleaned;
      }
    });
    // ?뺣낫 怨쇰ぉ ?좏깮 ??異붽? 踰꾪듉 ?쒖떆 (?숈쟻 subject-block?먮룄 ?곸슜)
        function updateInfoButtons() {
            const selects = document.querySelectorAll('.subject-name');
            let show = false;
            selects.forEach(sel => {
                if (sel.value === '?뺣낫') show = true;
            });
            document.getElementById('info-extra-buttons').style.display = show ? 'flex' : 'none';
        }
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('subjectsBlock').addEventListener('change', function(e) {
                if (e.target.classList.contains('subject-name')) {
                    updateInfoButtons();
                }
            });
            // 怨쇰ぉ/?좎깮??異붽? ?쒖뿉???대깽???곸슜
            document.getElementById('addSubjectBtn').addEventListener('click', function() {
                setTimeout(updateInfoButtons, 100);
            });
        });
    // ?곸뾽?쇱? ?낅젰
    // delegated handler: toggle meeting button selection (visual only)
    document.getElementById('subjectsBlock').addEventListener('click', function(e){
      const mb = e.target.closest('.meeting-btn');
      if (!mb) return;
      const block = mb.closest('.subject-block');
      if (!block) return;
      // toggle selected state; multiple selections allowed
      mb.classList.toggle('selected');
      // do NOT write markers into the conversation textarea anymore (UI only)
      // keep visibility logic for info-extra-buttons in case a '?뺣낫' subject exists
    });

    // helper: send a visit payload to the backend API (/api/visits)
    function sendToServer(visit) {
      try {
        fetch('/api/visits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(visit)
        }).then(resp => resp.ok ? resp.json() : Promise.reject('HTTP '+resp.status))
        .then(data => { try{ console.log('Server saved visit:', data); }catch(e){} if (data && data.id) visit.server_id = data.id; })
        .catch(err => { try{ console.warn('Failed to send visit to server:', err); }catch(e){} });
      } catch(e) { try{console.warn('sendToServer error', e);}catch(_){} }
    }

    document.getElementById('salesForm').addEventListener('submit', function(e) {
      e.preventDefault();
      // 諛⑸Ц???꾩닔 (理쒖쥌 寃??
      const vd = document.getElementById('visitDate');
      if (!vd || !vd.value) { alert('諛⑸Ц?쇱쓣 ?낅젰?섏꽭??'); vd && vd.focus(); return; }
      // Build a visit object from current form and add to dayVisits
      const visitObj = buildCurrentVisitObject();
      // must have school
      if (!visitObj.school) { alert('?숆탳瑜??좏깮??????ν븯?몄슂.'); return; }
  const ta = document.getElementById('generatedSummary');
  const defaultHint = '?붿빟???ш린???앹꽦?⑸땲??';
  // debug logging
  try { console.log('submit: visitObj=', visitObj); console.log('submit: dayVisits length before=', dayVisits.length); } catch(e){}
      if (editingVisitIndex >= 0) {
        // update existing visit
        dayVisits[editingVisitIndex] = visitObj;
        resetEditState();
        renderVisitsList();
        // rebuild the textarea from all visits so the accumulated text stays consistent
        if (ta) {
          const rebuilt = dayVisits.map((v,i) => formatVisitText(v,i)).join('\n');
          writeGeneratedSummary(rebuilt, { replace: true });
        }
  alert('諛⑸Ц ?댁슜???섏젙?섏뼱 ??λ릺?덉뒿?덈떎.');
  try { sendToServer(visitObj); } catch(e){}
      } else {
        dayVisits.push(visitObj);
        renderVisitsList();
        // append this visit's formatted text to the generatedSummary textarea
        if (ta) {
          // debug log
          try { console.log('submit: textarea current value length=', (ta.value||'').length); } catch(e){}
          // prepare formatted text and append via robust writer
          const formatted = formatVisitText(visitObj, dayVisits.length - 1);
          try { console.log('submit: formatted text=', formatted); } catch(e){}
          // if default hint present, replace; otherwise append
          if ((ta.value||'').trim() === defaultHint) writeGeneratedSummary(formatted, { replace: true });
          else writeGeneratedSummary(formatted, { replace: false });
        } else {
          try { console.warn('submit: generatedSummary textarea not found'); } catch(e){}
        }
        // prepare the form for the next visit while keeping the date
        resetFormForNextVisit();
        alert('?꾩옱 諛⑸Ц????λ릺?덉뒿?덈떎. ?ㅼ쓬 諛⑸Ц???낅젰?섏꽭??');
        try { sendToServer(visitObj); } catch(e){}
      }
    });
    // add a small numeric badge to each subject-block so user can distinguish blocks
    function renumberSubjectBlocks(){
      const blocks = Array.from(document.querySelectorAll('.subject-block'));
      blocks.forEach((b,idx) => {
        let badge = b.querySelector('.subject-index');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'subject-index';
          b.insertBefore(badge, b.firstChild);
        }
        badge.textContent = String(idx+1);
      });
    }
    // ?ㅻ줈 踰꾪듉: Step2 ??Step1濡?蹂듦?
    const backBtnEl = document.getElementById('backBtn');
    if (backBtnEl) {
      backBtnEl.addEventListener('click', function(){
        const s2 = document.getElementById('step2'); if (s2) s2.style.display = 'none';
        const s1 = document.getElementById('step1'); if (s1) s1.style.display = 'block';
        // restore focus to Next button for quick navigation
        const next = document.getElementById('nextStepBtn'); if (next) next.focus();
      });
    }

    // Generate a human-friendly summary from current form state
    function generateSummary(){
      const date = document.getElementById('visitDate') ? document.getElementById('visitDate').value : '';
      const staff = document.getElementById('staffInfo') ? document.getElementById('staffInfo').textContent.replace('?대떦?? ','') : '';
      const region = document.getElementById('displayRegion') ? document.getElementById('displayRegion').textContent : '';
      const school = document.getElementById('displaySchool') ? document.getElementById('displaySchool').textContent : '';
      const start = (document.getElementById('visitStartHour') && document.getElementById('visitStartMinute')) ? (document.getElementById('visitStartHour').value + ':' + document.getElementById('visitStartMinute').value) : '';
      const end = document.getElementById('visitEnd') ? document.getElementById('visitEnd').value : '';
      const blocks = Array.from(document.querySelectorAll('.subject-block'));
      let out = '';
      out += (date ? `???쇱떆: ${date}\n\n` : '');
      out += (staff ? `?대떦?? ${staff}\n` : '');
      if (region || school) out += `??? ${region} / ${school}\n`;
      if (start || end) out += `諛⑸Ц: ${start} ~ ${end} (${start && end ? calcMinutesInterval(start,end) + '遺? : ''})\n\n`;
      out += '?몃??낅Т:\n\n';
      blocks.forEach((b, idx) => {
        const subj = b.querySelector('.subject-name') ? b.querySelector('.subject-name').value : '';
        const teacher = b.querySelector('.teacher-name') ? b.querySelector('.teacher-name').value : '';
        const pub = b.querySelector('.publisher') ? b.querySelector('.publisher').value : '';
        const meetings = Array.from(b.querySelectorAll('.meeting-btn.selected')).map(x => x.textContent.trim());
        const follow = b.querySelector('.followUpSelect') ? b.querySelector('.followUpSelect').value : '';
        const contact = b.querySelector('.contact-suffix') ? b.querySelector('.contact-suffix').value : '';
        const notes = b.querySelector('.conversation-detail') ? b.querySelector('.conversation-detail').value : '';
        out += `${idx+1}. ${subj} (${teacher}${pub? ' / '+pub : ''})\n`;
        if (meetings.length) out += `- 吏꾪뻾: ${meetings.join(', ')}\n`;
  // contact is intentionally omitted from the on-page summary; it's kept for backend only
        if (follow) out += `- ?꾩냽議곗튂: ${follow}\n`;
        if (notes) out += `- ?뱀씠?ы빆: ${notes}\n`;
        out += '\n';
      });
      // summary stats
      const totalSchools = document.querySelectorAll('#schoolButtons .grid-button.selected').length ? 1 : 0; // simple heuristic
      out += `???뱀씠?ы빆 ??n- 諛⑸Ц?숆탳 : ${totalSchools} 媛쒓탳\n`;
      // set into textarea
      const ta = document.getElementById('generatedSummary'); if (ta) ta.value = out;
    }
    function calcMinutesInterval(start, end){
      if (!start || !end) return '';
      const [sh, sm] = start.split(':').map(n=>parseInt(n,10));
      const [eh, em] = end.split(':').map(n=>parseInt(n,10));
      const s = sh*60 + sm; const e = eh*60 + em; let diff = e - s; if (diff < 0) diff += 24*60; return diff;
    }
  document.getElementById('genSummaryBtn')?.addEventListener('click', generateSummary);
  </script>
</body>
</html>
