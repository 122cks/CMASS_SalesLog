<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CMASS 영업일지 시스템</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <style>
    :root{
      --bg1:#0f2a4a;
      --bg2:#26529a;
      --card-grad:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));
      --white-90:rgba(255,255,255,0.9);
      --btn-bg:#fff;
      --btn-color:#123a62;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Segoe UI','Malgun Gothic',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:28px;color:var(--white-90)}
    .wrap{width:100%;max-width:460px}
    .card{background:var(--card-grad);padding:34px;border-radius:14px;box-shadow:0 18px 50px rgba(6,16,40,0.6);text-align:center}
    .logo-wrap{width:140px;height:84px;margin:0 auto 12px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 22px rgba(0,0,0,0.24)}
    .logo{max-width:100%;max-height:72px}
    h1{margin:8px 0 6px;font-size:24px;color:#fff}
    p.lead{margin:0 0 18px;color:rgba(255,255,255,0.88);font-weight:700}
    .btn{display:block;background:var(--btn-bg);color:var(--btn-color);padding:14px 18px;border-radius:12px;margin:10px auto;width:320px;max-width:94%;text-decoration:none;font-weight:700;font-size:16px;box-shadow:0 8px 28px rgba(10,30,70,0.18)}
    .btn:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(10,30,70,0.22)}
    .muted-note{margin-top:18px;color:rgba(255,255,255,0.78);font-size:14px}
    .version{position:fixed;right:12px;bottom:10px;color:rgba(255,255,255,0.65);font-size:12px}
    @media (max-width:420px){.logo-wrap{width:110px;height:64px}.btn{width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="logo-wrap">
  <!-- Use the user-provided CMASS_LOGO.png first; fall back to SVG, then to older PNG -->
  <img class="logo" src="/assets/CMASS_LOGO.png" alt="CMASS" onerror="(function(i){i.onerror=null;i.src='/assets/CMASS_sales_logo.svg';})(this);" />
      </div>
      <h1>CMASS 영업일지 시스템</h1>
      <p class="lead">간편한 영업일지 입력과 내보내기</p>

    <form id="entryForm" style="margin-top:6px;">
      <label for="userSelect" style="display:block;margin-bottom:8px;font-weight:700;text-align:left;color:var(--white-90)">이름 선택</label>
      <select id="userSelect" style="width:100%;padding:12px;border-radius:10px;border:none;margin-bottom:12px;font-weight:800">
        <option value="SongHoonjae">송훈재 부장</option>
        <option value="LimJunho">임준호 차장</option>
        <option value="ChoYounghwan">조영환 부장</option>
      </select>
      <label for="pinInput" style="display:block;margin-bottom:8px;font-weight:700;text-align:left;color:var(--white-90)">PIN 입력</label>
      <input id="pinInput" type="password" maxlength="4" placeholder="●●●●" style="display:block;width:100%;padding:12px;border-radius:10px;border:none;margin-bottom:12px;font-size:16px;text-align:center" />
      <button id="pinSubmit" class="btn" type="submit">확인</button>
      <div id="pinMsg" class="muted-note" style="margin-top:10px;color:#ffdcdc;display:none"></div>
    </form>

      <div class="muted-note">이름 선택 후 PIN을 입력하면 시작 페이지로 이동합니다.</div>
    </div>
  </div>
  <div class="version">build: 2025-10-22-06</div>
      <script>
        // Root PIN flow: submit name+PIN to /api/pin-check, store session marker, then redirect to front.html?user=<token>
        (function(){
          const form = document.getElementById('entryForm');
          const select = document.getElementById('userSelect');
          const pinInput = document.getElementById('pinInput');
          const pinMsg = document.getElementById('pinMsg');
          if (!form || !select || !pinInput) return;

          // map select value -> Korean display name with title (same mapping as sales-input.getStaffFromQuery)
          const displayMap = {
            'SongHoonjae': '송훈재 부장',
            'LimJunho': '임준호 차장',
            'ChoYounghwan': '조영환 부장'
          };

          function normalizeForPin(s){ return (s||'').toString().replace(/\s*(부장|차장|과장|대리|사원|팀장|선생님|선생)/g,'').trim(); }

          form.addEventListener('submit', async function(ev){
            ev.preventDefault();
            pinMsg.style.display = 'none';
            const token = select.value;
            const display = displayMap[token] || select.options[select.selectedIndex].text || token;
            const baseForPin = normalizeForPin(display);
            const pin = (pinInput.value || '').toString().trim();
            if (!/^\d{4}$/.test(pin)) {
              pinMsg.style.display = '';
              pinMsg.textContent = '4자리 PIN을 입력하세요.';
              return;
            }
            try {
              const resp = await fetch('/api/pin-check', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ staff: baseForPin, pin }) });
              const ct = (resp.headers.get('content-type')||'').toLowerCase();
              let j = null;
              if (ct.indexOf('application/json') !== -1) j = await resp.json();
              if (resp.ok && j && j.ok) {
                try { sessionStorage.setItem('cmass_pin_authenticated', JSON.stringify({ staff: baseForPin, ts: Date.now() })); } catch(e){}
                // redirect to front with canonical token
                const target = '/front.html?user=' + encodeURIComponent(token);
                window.location.href = target;
                return;
              } else {
                pinMsg.style.display = '';
                pinMsg.textContent = (j && j.msg) ? j.msg : 'PIN이 일치하지 않습니다.';
                return;
              }
            } catch(err) {
              pinMsg.style.display = '';
              pinMsg.textContent = '서버에 연결할 수 없습니다. 잠시 후 다시 시도하세요.';
              console.error('pin submit error', err);
            }
          });
        })();
      </script>
</body>
</html>