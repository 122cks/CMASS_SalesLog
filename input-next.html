<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e3c72">
  <title>영업 활동 입력</title>
  <script src="/neis_grid.js" defer></script>
  <script src="/csv-helpers.js" defer></script>
  <style>
    /* 기존 스타일 유지 */
    #schoolMetaInline, #schoolMeta {
      display:block;
      padding:22px 20px;
      border-radius:14px;
      background:linear-gradient(180deg,#ffffff 0%, #f7f8ff 100%);
      border:1px solid #e2e8ff;
      box-shadow:0 18px 48px rgba(10,28,64,0.12);
      color:#071a2e;
      font-size:16.5px;
      line-height:1.6;
      margin-top:1rem;
      position:relative;
      overflow:visible;
    }
    .hidden { display:none !important; }
    #schoolMetaInline::before, #schoolMeta::before {
      content: '';
      position: absolute;
      left: 0;
      top: 8px;
      bottom: 8px;
      width: 10px;
      border-radius: 8px;
      background: linear-gradient(180deg,#556ee8,#6b4bb0);
      box-shadow: 0 4px 14px rgba(80,90,160,0.08);
    }
    #schoolMetaInline h4, #schoolMeta h4 { margin:0 0 .6rem 18px; font-size:19px; color:#06203f; font-weight:900 }
    .grade-rows { display:block; margin-top:12px; }
    .grade-row { display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center; margin:8px 0; }
    .grade-row .grade-label { font-weight:900; color:#0d304f; font-size:15px }
    .grade-row .grade-value { color:#072042; font-size:15px; display:flex; gap:8px; align-items:baseline }
    .grade-row .grade-value span { font-weight:900; color:#0b2b5a; font-size:17px }
    .meta-summary { display:flex; gap:14px; margin:8px 12px 6px 12px; }
    .meta-summary .meta-pill { background:#f3f6ff; padding:.45rem .7rem; border-radius:10px; border:1px solid #e0e8ff; color:#082044; font-weight:800; font-size:14px }
    
    .btn-grid { display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:.5rem; margin-bottom:.7rem; }
    .selector-btn { position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:.8rem 1rem; border-radius:.8rem; border:1px solid #d6dbe8; background:#fff; color:#12325a; font-weight:700; text-align:center; cursor:pointer; transition:background .2s ease, border-color .2s ease, box-shadow .2s ease; min-height:70px; min-width:0; }
    .selector-btn .selector-label { display:block; font-weight:800; font-size:1.2rem; line-height:1.18; white-space:nowrap; width:100%; text-align:center; overflow:hidden; }
    .selector-btn:hover { border-color:#92ace0; box-shadow:0 6px 18px rgba(30,60,114,0.18); }
    .selector-btn.is-active { border-color:#1e3c72; background:linear-gradient(135deg,#1e3c72,#274b9f); color:#fff; box-shadow:0 12px 28px rgba(30,60,114,0.32); }
    .empty-message { padding:.85rem; border-radius:.75rem; border:1px dashed #d6dbe8; background:#f7f9ff; color:#324156; font-size:.9rem; }
    
    .visit-start-row { display:flex; gap:0.6rem; align-items:center; }
    .friend-btn-row { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; align-items:center; }
    .friend-btn-row .friend-btn { width:100%; box-sizing:border-box; justify-self:stretch; }
  </style>
</head>
<body>

<!-- 1. 담당자-방문일-지역-학교 (Top Debug Banner) -->
<div id="topDebugBanner" style="display:none;padding:.6rem 1rem;background:linear-gradient(90deg,#e8f3ff,#f5fbff);border:1px solid #d6e9ff;border-radius:10px;margin:10px;align-items:center;display:flex;justify-content:space-between;gap:8px;">
  <div style="display:flex;gap:.7rem;align-items:center;">
    <div id="topDebugText" style="color:#06325a;font-weight:800;font-size:0.95rem;">파라미터: -</div>
    <div id="topMappingStatus" style="font-size:0.85rem;color:#075;opacity:0.9;padding:.2rem .5rem;border-radius:.5rem;background:#e9fef3;border:1px solid #d6f5df;display:none;">메타: -</div>
  </div>
  <div style="display:flex;gap:.5rem;align-items:center;">
    <button id="topNewReportBtn" type="button" style="padding:.45rem .7rem;border-radius:.6rem;border:1px solid #1e90ff;background:linear-gradient(90deg,#4ea8ff,#73b7ff);color:#fff;font-weight:800;">새 보고서</button>
    <button id="topBackBtn" type="button" style="padding:.45rem .7rem;border-radius:.6rem;border:1px solid #cfdff8;background:#fff;color:#0b3a72;font-weight:800;">뒤로</button>
  </div>
</div>

<!-- 2. 학교 정보 -->
<div id="schoolMetaInline" class="meta-card hidden">
  <h4>학교 정보</h4>
  <div class="meta-summary">
    <div class="meta-pill" id="inlinePillEstablish">설립: -</div>
    <div class="meta-pill" id="inlinePillLevel">급: -</div>
    <div class="meta-pill" id="inlinePillStudents">총학생수: -</div>
    <div class="meta-pill" id="inlinePillFeature" style="display:none;">특성: -</div>
  </div>
  <div class="grade-rows">
    <div class="grade-row"><div class="grade-label">1학년:</div><div class="grade-value"><span id="inlineG1c"></span> 학급 / <span id="inlineG1s"></span> 학생</div></div>
    <div class="grade-row"><div class="grade-label">2학년:</div><div class="grade-value"><span id="inlineG2c"></span> 학급 / <span id="inlineG2s"></span> 학생</div></div>
    <div class="grade-row"><div class="grade-label">3학년:</div><div class="grade-value"><span id="inlineG3c"></span> 학급 / <span id="inlineG3s"></span> 학생</div></div>
  </div>
</div>

<!-- 3. 방문 일정 -->
<section id="visitTimeSection" style="margin-top:1.2rem;padding:1rem;border:1px solid #e6eefc;border-radius:1rem;background:#f9fbff;">
  <h4 style="margin:0 0 0.8rem 0;font-size:1.05rem;font-weight:800;color:#12325a;">방문 일정</h4>
  <div style="display:flex;flex-direction:column;gap:0.8rem;">
    <div>
      <label for="visitStartHour" style="display:block;font-weight:700;margin-bottom:0.4rem;">방문 시작 시간</label>
      <div class="visit-start-row" style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;">
        <select id="visitStartHour" name="visitStartHour" style="padding:0.65rem;border-radius:0.8rem;border:1px solid #d6dbe8;min-width:100px;">
          <option value="">시 선택</option>
          <option value="08">08시</option>
          <option value="09">09시</option>
          <option value="10">10시</option>
          <option value="11">11시</option>
          <option value="12">12시</option>
          <option value="13">13시</option>
          <option value="14">14시</option>
          <option value="15">15시</option>
          <option value="16">16시</option>
          <option value="17">17시</option>
          <option value="18">18시</option>
        </select>
        <select id="visitStartMinute" name="visitStartMinute" style="padding:0.65rem;border-radius:0.8rem;border:1px solid #d6dbe8;min-width:100px;">
          <option value="">분 선택</option>
          <option value="00">00분</option>
          <option value="15">15분</option>
          <option value="30">30분</option>
          <option value="45">45분</option>
        </select>
      </div>
    </div>
    <div>
      <label style="display:block;font-weight:700;margin-bottom:0.4rem;">총 방문 시간(분)</label>
      <div id="visitDurationButtons" style="display:flex;flex-wrap:wrap;gap:0.6rem;margin-bottom:0.4rem;">
        <button type="button" class="duration-btn" data-duration="30" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">30분</button>
        <button type="button" class="duration-btn" data-duration="60" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">60분</button>
        <button type="button" class="duration-btn" data-duration="90" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">90분</button>
      </div>
      <input type="number" id="visitDurationInput" name="visitDurationMinutes" min="0" step="5" placeholder="직접 입력" style="width:110px;padding:0.6rem;border-radius:0.8rem;border:1px solid #d6dbe8;" />
    </div>
    <div>
      <label for="visitEndTime" style="display:block;font-weight:700;margin-bottom:0.4rem;">방문 종료 시간 (자동 계산)</label>
      <input type="text" id="visitEndTime" name="visitEndTime" readonly style="width:160px;padding:0.65rem;border-radius:0.8rem;border:1px solid #d6dbe8;background:#f6f9ff;font-weight:700;color:#12325a;" />
    </div>
  </div>
</section>

<!-- 4. 과목/선생님별 영업기록 -->
<section class="subject-section" style="margin-top:1.5rem;">
  <h4 style="margin:0 0 0.8rem 0;font-size:1.05rem;font-weight:800;color:#12325a;">과목/선생님별 영업기록</h4>
  <div id="subjectsBlock" class="subject-blocks" style="display:flex;flex-direction:column;gap:1rem;"></div>
</section>

<!-- 5. 과목/선생님 추가 버튼 -->
<button type="button" id="addSubjectBtn" style="width:100%;margin:0.8rem 0 1rem 0;padding:1rem;font-size:1.1rem;border-radius:1rem;background:#e3eafc;color:#1e3c72;font-weight:bold;border:none;cursor:pointer;">과목/선생님 추가</button>

<!-- 6. 뒤로 돌아가기 / 입력 완료 -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-top:0.6rem;">
  <button type="button" id="backBtn" style="padding:1rem;border-radius:1rem;border:1px solid #d6dbe8;background:#fff;color:#1e3c72;font-weight:700;cursor:pointer;">뒤로 돌아가기</button>
  <button type="button" class="btn-submit" style="padding:1rem;border-radius:1rem;border:1px solid #1e3c72;background:#1e3c72;color:#fff;font-weight:700;cursor:pointer;">입력 완료</button>
</div>

<!-- 7. 카톡으로 복사 / 서버에 저장 / 요약 -->
<div class="step2-only" style="margin-top:1.5rem;padding:1rem;border:1px solid #e6eefc;border-radius:1rem;background:#f9fbff;">
  <h4 style="margin:0 0 0.8rem 0;font-size:1.05rem;font-weight:800;color:#12325a;">보고서 생성</h4>
  
  <!-- 카톡으로 복사 / 서버에 저장 -->
  <div style="display:flex;gap:.5rem;margin-bottom:.8rem;">
    <button type="button" id="copyKakaoBtn" style="flex:1;padding:.75rem;border-radius:1rem;border:1px solid #ffd9b3;background:#fff;color:#b25700;font-weight:800;">카톡으로 복사</button>
    <button type="button" id="saveToServerBtn" style="flex:1;padding:.75rem;border-radius:1rem;border:1px solid #cfe8ff;background:#e9f4ff;color:#0b3a72;font-weight:800;">서버에 저장</button>
  </div>
  
  <!-- 퇴근보고 시간 설정 -->
  <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.8rem;">
    <button type="button" id="chooseCollectTimeBtn" style="padding:.5rem .8rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;color:#0b3a72;font-weight:700;">퇴근보고 시간 설정</button>
    <div id="collectTimeDisplay" style="font-size:13px;color:#3b4b63">기본: 퇴근 시각 기준 + 30분</div>
  </div>
  
  <!-- 요약 생성 / 내용 전체지우기 -->
  <div style="display:flex;gap:.5rem;margin-bottom:.8rem;">
    <button type="button" id="generateSummaryBtn" style="flex:1;padding:.6rem;border-radius:.6rem;border:1px solid #4CAF50;background:#4CAF50;color:#fff;font-weight:800;">요약 생성</button>
    <button type="button" id="summaryRegenerateBtn" style="flex:1;padding:.6rem;border-radius:.6rem;border:1px solid #e6eefc;background:#f8fbff;color:#0b3a72;font-weight:700;">내용 전체지우기</button>
  </div>
  
  <!-- 요약 내용 텍스트 영역 -->
  <textarea id="generatedSummary" rows="10" readonly style="width:100%;padding:.8rem;border-radius:.8rem;border:1px solid #d6dbe8;">요약이 여기에 생성됩니다.</textarea>
</div>

<!-- Subject Template -->
<template id="subject-template">
  <div class="subject-block" style="margin-bottom:1rem;padding:1.1rem;background:#f9fafd;border-radius:.95rem;border:1px solid #e0e8f5;">
    <div style="margin-bottom:.8rem;">
      <label style="font-weight:700;">과목</label>
      <input type="hidden" class="subject-name" name="subject" value="">
      <div class="subject-choice-group" style="display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-top:.5rem;">
        <button type="button" class="subject-choice-btn" data-subject="정보" style="padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">정보</button>
        <button type="button" class="subject-choice-btn" data-subject="진로" style="padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">진로</button>
        <button type="button" class="subject-choice-btn" data-subject="보건" style="padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">보건</button>
        <button type="button" class="subject-choice-btn" data-subject="미술" style="padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">미술</button>
        <button type="button" class="subject-choice-btn" data-subject="체육" style="padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">체육</button>
        <button type="button" class="subject-choice-btn" data-subject="기타" style="padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">기타</button>
      </div>
    </div>
    
    <div style="margin-bottom:.8rem;">
      <label style="font-weight:700;">선생님 이름</label>
      <input type="text" class="teacher-name" name="teacher" placeholder="선생님 이름" style="width:100%;padding:.65rem;border-radius:.65rem;border:1px solid #d6dbe8;margin-top:.4rem;" />
    </div>
    
    <div style="margin-bottom:.8rem;">
      <label style="font-weight:700;">연락처</label>
      <div style="display:flex;gap:.5rem;margin-top:.4rem;">
        <span style="padding:.55rem .7rem;border-radius:.6rem;background:#f2f4ff;border:1px solid #d6dbe8;color:#12325a;font-weight:700;">010</span>
        <input type="text" class="contact-suffix" placeholder="12345678" maxlength="8" style="flex:1;padding:.55rem;border-radius:.6rem;border:1px solid #d6dbe8;">
      </div>
    </div>
    
    <div style="margin-bottom:.8rem;">
      <label style="font-weight:700;">특이사항</label>
      <textarea class="conversation-detail" rows="2" placeholder="특이사항" style="width:100%;padding:.65rem;border-radius:.65rem;border:1px solid #d6dbe8;margin-top:.4rem;"></textarea>
    </div>
    
    <button type="button" class="removeSubjectBtn" style="padding:.55rem 1.2rem;border-radius:.7rem;background:#ff9800;color:#fff;border:none;cursor:pointer;">삭제</button>
  </div>
</template>

<script>
  // JavaScript implementations here
  // (기존 스크립트 유지)
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e3c72">
  <title>영업 활동 입력</title>
  <script src="/neis_grid.js" defer></script>
  <script src="/csv-helpers.js" defer></script>
  <style>
    /* moved inline CSS into a style block to avoid parser errors */
    /* default to visible in CSS and control visibility via the .hidden class
       This avoids JS needing to manipulate inline styles and reduces specificity bugs */
    #schoolMetaInline, #schoolMeta {
      display:block;
      padding:22px 20px;
      border-radius:14px;
      background:linear-gradient(180deg,#ffffff 0%, #f7f8ff 100%);
      border:1px solid #e2e8ff;
      box-shadow:0 18px 48px rgba(10,28,64,0.12);
      color:#071a2e;
      font-size:16.5px;
      line-height:1.6;
      margin-top:1rem;
      position:relative;
      overflow:visible;
    }
    /* utility class to hide elements regardless of other stylesheet rules */
    .hidden { display:none !important; }
    /* accent stripe on the left (wider for better affordance) */
    #schoolMetaInline::before, #schoolMeta::before {
      content: '';
      position: absolute;
      left: 0;
      top: 8px;
      bottom: 8px;
      width: 10px;
      border-radius: 8px;
      background: linear-gradient(180deg,#556ee8,#6b4bb0);
      box-shadow: 0 4px 14px rgba(80,90,160,0.08);
    }
    #schoolMetaInline h4, #schoolMeta h4 { margin:0 0 .6rem 18px; font-size:19px; color:#06203f; font-weight:900 }
    .grade-rows { display:block; margin-top:12px; }
    .grade-row { display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center; margin:8px 0; }
    .grade-row .grade-label { font-weight:900; color:#0d304f; font-size:15px }
    .grade-row .grade-value { color:#072042; font-size:15px; display:flex; gap:8px; align-items:baseline }
    .grade-row .grade-value span { font-weight:900; color:#0b2b5a; font-size:17px }
    .meta-key { font-weight:900; font-size:15px; color:#092b4a; }
    .grade-row .small-note { color:#4e5b73; font-size:13px; margin-left:6px }
    .meta-summary { display:flex; gap:14px; margin:8px 12px 6px 12px; }
    .meta-summary .meta-pill { background:#f3f6ff; padding:.45rem .7rem; border-radius:10px; border:1px solid #e0e8ff; color:#082044; font-weight:800; font-size:14px }
  </style>
  <style>
  table.timetable { border-collapse:collapse; width:100%; font-size:11px; line-height:1.12; }
  /* compact cells to reduce wrapping in timetable; use !important to override inline JS styles */
  .timetable-wrapper table.timetable th,
  .timetable-wrapper table.timetable td { border:1px solid #e6eefc; padding:4px 6px !important; font-size:11px !important; vertical-align:top; }
  /* Force single-line cells: prevent wrapping, show ellipsis when truncated, allow horizontal scroll */
  .timetable-wrapper table.timetable th,
  .timetable-wrapper table.timetable td {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    max-width: 260px; /* reasonable cap to help ellipsis; adjust as needed */
  }
  /* For narrow mobile screens, cap width tighter */
  @media (max-width:600px) {
    .timetable-wrapper table.timetable th,
    .timetable-wrapper table.timetable td { max-width: 140px; }
  }
  /* sticky header row and sticky first column (반/학급 or 교시) within the scroll wrapper */
  .timetable-wrapper table.timetable thead th { position:sticky; top:0; background:#f7fbff; z-index:3; }
  .timetable-wrapper table.timetable th:first-child,
  .timetable-wrapper table.timetable td:first-child { position:sticky; left:0; background:#f7fbff; z-index:2; }
  /* ensure the top-left corner cell stays above both header and first column */
  .timetable-wrapper table.timetable thead th:first-child { z-index:4; }
  /* Mobile tweaks: slightly smaller font and tighter padding for narrow screens */
  @media (max-width:600px) {
    .timetable-wrapper table.timetable { font-size:10px; }
    .timetable-wrapper table.timetable th,
    .timetable-wrapper table.timetable td { padding:3px 5px !important; font-size:10px !important; }
    .timetable-wrapper { max-height:60vh; }
  }
  .current-period { background:#ffeaa7 !important; border:1px solid #f1c40f !important; }
  </style>
  <style>
  /* Remove all step-related styles */
  .btn-grid { display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:.5rem; margin-bottom:.7rem; }
    .selector-btn { position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:.8rem 1rem; border-radius:.8rem; border:1px solid #d6dbe8; background:#fff; color:#12325a; font-weight:700; text-align:center; cursor:pointer; transition:background .2s ease, border-color .2s ease, box-shadow .2s ease; min-height:70px; min-width:0; }
  .selector-btn .selector-label { display:block; font-weight:800; font-size:1.2rem; line-height:1.18; white-space:nowrap; width:100%; text-align:center; overflow:hidden; }
    .selector-btn:hover { border-color:#92ace0; box-shadow:0 6px 18px rgba(30,60,114,0.18); }
    .selector-btn.is-active { border-color:#1e3c72; background:linear-gradient(135deg,#1e3c72,#274b9f); color:#fff; box-shadow:0 12px 28px rgba(30,60,114,0.32); }
    .empty-message { padding:.85rem; border-radius:.75rem; border:1px dashed #d6dbe8; background:#f7f9ff; color:#324156; font-size:.9rem; }
    @media (max-width:520px) {
      .btn-grid { grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); }
      .selector-btn { min-height:58px; padding:.6rem .8rem; }
    }
    @media (min-width:720px) {
      /* Larger viewports can safely scale button typography a bit more */
      .selector-btn .selector-label { font-size:1.3rem; }
    }
  /* Controls layout for visit start selects and friendliness buttons */
  .visit-start-row { display:flex; gap:0.6rem; align-items:center; }
  /* Use grid for friend buttons so we can force 3-up at our breakpoint like subjects */
  .friend-btn-row { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; align-items:center; }
  .friend-btn-row .friend-btn { width:100%; box-sizing:border-box; justify-self:stretch; }

  /* Make the start hour/minute selects and friendliness buttons align to a 530px width when space allows */
  @media (min-width:530px) {
      /* constrain parent width and let controls share the space */
      #visitTimeSection > div > .visit-start-row, #visitTimeSection .visit-start-row { max-width:530px; width:100%; }
      #visitTimeSection select#visitStartHour,
      #visitTimeSection select#visitStartMinute {
        box-sizing: border-box;
    }
  }
</style>
</head>
<body>

<!-- Top debug banner: shows passed params and provides a Back button -->
<div id="topDebugBanner" style="display:none;padding:.6rem 1rem;background:linear-gradient(90deg,#e8f3ff,#f5fbff);border:1px solid #d6e9ff;border-radius:10px;margin:10px;align-items:center;display:flex;justify-content:space-between;gap:8px;">
  <div style="display:flex;gap:.7rem;align-items:center;">
    <div id="topDebugText" style="color:#06325a;font-weight:800;font-size:0.95rem;">파라미터: -</div>
    <div id="topMappingStatus" style="font-size:0.85rem;color:#075;opacity:0.9;padding:.2rem .5rem;border-radius:.5rem;background:#e9fef3;border:1px solid #d6f5df;display:none;">메타: -</div>
  </div>
  <div style="display:flex;gap:.5rem;align-items:center;">
    <button id="topNewReportBtn" type="button" style="padding:.45rem .7rem;border-radius:.6rem;border:1px solid #1e90ff;background:linear-gradient(90deg,#4ea8ff,#73b7ff);color:#fff;font-weight:800;">새 보고서</button>
    <button id="topBackBtn" type="button" style="padding:.45rem .7rem;border-radius:.6rem;border:1px solid #cfdff8;background:#fff;color:#0b3a72;font-weight:800;">뒤로</button>
  </div>
</div>

<div id="schoolMetaInline" class="meta-card hidden">
      <h4>학교 정보</h4>
      <div class="meta-summary">
        <div class="meta-pill" id="inlinePillEstablish">설립: -</div>

        <div class="meta-pill" id="inlinePillLevel">급: -</div>
        <div class="meta-pill" id="inlinePillStudents">총학생수: -</div>
        <div class="meta-pill" id="inlinePillFeature" style="display:none;">특성: -</div>
      </div>
      <div class="grade-rows">
        <div class="grade-row"><div class="grade-label">1학년:</div><div class="grade-value"><span id="inlineG1c"></span> 학급 / <span id="inlineG1s"></span> 학생</div></div>
        <div class="grade-row"><div class="grade-label">2학년:</div><div class="grade-value"><span id="inlineG2c"></span> 학급 / <span id="inlineG2s"></span> 학생</div></div>
        <div class="grade-row"><div class="grade-label">3학년:</div><div class="grade-value"><span id="inlineG3c"></span> 학급 / <span id="inlineG3s"></span> 학생</div></div>
      </div>

      <!-- Inline NEIS timetable controls for quick lookup when selecting from the list -->
      <div style="margin-top:12px;padding-top:8px;border-top:1px dashed #e6eefc;">
        <label style="font-weight:900;display:block;margin-bottom:6px;">시간표 가져오기 (NEIS)</label>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
          <select id="inlineNeisYear" style="padding:.45rem;border-radius:.5rem;border:1px solid #d6dbe8;"> 
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
          </select>
          <select id="inlineNeisSemester" style="padding:.45rem;border-radius:.5rem;border:1px solid #d6dbe8;">
            <option value="1">1학기</option>
            <option value="2" selected>2학기</option>
          </select>

          <button type="button" id="btnFetchSelectedTimetableInline" class="meeting-btn" style="margin-left:6px;">선택 학교 시간표 보기</button>
          <button type="button" id="btnCloseTimetableInline" class="meeting-btn" style="margin-left:6px;background:#fff;color:#12325a;border:1px solid #d6dbe8;display:none;">시간표 닫기</button>
        </div>
        <div id="timetableProgressInline" style="margin-top:8px;color:#175;display:none;font-size:13px;"></div>
        <div id="timetableContainerInline" style="margin-top:10px;"></div>
      </div>
    </div>

<section id="visitTimeSection" style="margin-top:1.2rem;padding:1rem;border:1px solid #e6eefc;border-radius:1rem;background:#f9fbff;">
      <h4 style="margin:0 0 0.8rem 0;font-size:1.05rem;font-weight:800;color:#12325a;">방문 일정</h4>
      <div style="display:flex;flex-direction:column;gap:0.8rem;">
        <div>
          <label for="visitStartHour" style="display:block;font-weight:700;margin-bottom:0.4rem;">방문 시작 시간</label>
          <div class="visit-start-row" style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;">
            <select id="visitStartHour" name="visitStartHour" style="padding:0.65rem;border-radius:0.8rem;border:1px solid #d6dbe8;min-width:100px;">
              <option value="">시 선택</option>
              <option value="08">08시</option>
              <option value="09">09시</option>
              <option value="10">10시</option>
              <option value="11">11시</option>
              <option value="12">12시</option>
              <option value="13">13시</option>
              <option value="14">14시</option>
              <option value="15">15시</option>
              <option value="16">16시</option>
              <option value="17">17시</option>
              <option value="18">18시</option>
            </select>
            <select id="visitStartMinute" name="visitStartMinute" style="padding:0.65rem;border-radius:0.8rem;border:1px solid #d6dbe8;min-width:100px;">
              <option value="">분 선택</option>
              <option value="00">00분</option>
              <option value="05">05분</option>
              <option value="10">10분</option>
              <option value="15">15분</option>
              <option value="20">20분</option>
              <option value="25">25분</option>
              <option value="30">30분</option>
              <option value="35">35분</option>
              <option value="40">40분</option>
              <option value="45">45분</option>
              <option value="50">50분</option>
              <option value="55">55분</option>
            </select>
          </div>
        </div>
        <div>
          <label style="display:block;font-weight:700;margin-bottom:0.4rem;">총 방문 시간(분)</label>
          <div id="visitDurationButtons" style="display:flex;flex-wrap:wrap;gap:0.6rem;margin-bottom:0.4rem;">
            <button type="button" class="duration-btn" data-duration="10" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">10분</button>
            <button type="button" class="duration-btn" data-duration="20" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">20분</button>
            <button type="button" class="duration-btn" data-duration="30" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">30분</button>
            <button type="button" class="duration-btn" data-duration="40" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">40분</button>
            <button type="button" class="duration-btn" data-duration="50" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">50분</button>
            <button type="button" class="duration-btn" data-duration="60" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">60분</button>
            <button type="button" class="duration-btn" data-duration="70" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">70분</button>
            <button type="button" class="duration-btn" data-duration="80" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">80분</button>
            <button type="button" class="duration-btn" data-duration="90" style="flex:0 0 auto;padding:0.65rem 1rem;border-radius:0.85rem;border:1px solid #d6dbe8;background:#fff;font-weight:700;color:#1e3c72;">90분</button>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
            <input type="number" id="visitDurationInput" name="visitDurationMinutes" min="0" step="5" placeholder="직접 입력" style="width:110px;padding:0.6rem;border-radius:0.8rem;border:1px solid #d6dbe8;" />
            <button type="button" id="resetVisitTimeBtn" style="padding:0.55rem 0.9rem;border-radius:0.8rem;border:1px solid #d6dbe8;background:#fff;color:#1e3c72;">지우기</button>
          </div>
        </div>
        <div>
          <label for="visitEndTime" style="display:block;font-weight:700;margin-bottom:0.4rem;">방문 종료 시간 (자동 계산)</label>
          <input type="text" id="visitEndTime" name="visitEndTime" readonly style="width:160px;padding:0.65rem;border-radius:0.8rem;border:1px solid #d6dbe8;background:#f6f9ff;font-weight:700;color:#12325a;" />
        </div>
      </div>
    </section>

    <section class="subject-section" style="margin-top:1.5rem;">
      <h4 style="margin:0 0 0.8rem 0;font-size:1.05rem;font-weight:800;color:#12325a;">과목/선생님별 영업기록</h4>
      <div id="subjectsBlock" class="subject-blocks" style="display:flex;flex-direction:column;gap:1rem;"></div>
    </section>

      <button type="button" id="addSubjectBtn" style="width:100%;margin:0.8rem 0 1rem 0;padding:1rem;font-size:1.1rem;border-radius:1rem;background:#e3eafc;color:#1e3c72;font-weight:bold;border:none;cursor:pointer;">과목/선생님 추가</button>
      <!-- Back / Submit controls moved here so they appear between '과목/선생님 추가' and the step2-only panel -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-top:0.6rem;">
  <button type="button" id="backBtn" style="padding:1rem;border-radius:1rem;border:1px solid #d6dbe8;background:#fff;color:#1e3c72;font-weight:700;cursor:pointer;">뒤로 돌아가기</button>
  <button type="button" class="btn-submit" style="padding:1rem;border-radius:1rem;border:1px solid #1e3c72;background:#1e3c72;color:#fff;font-weight:700;cursor:pointer;">입력 완료</button>
    </div>

  <script>
    // Visit time and meeting buttons event handlers
    (function(){
      'use strict';
      
      document.addEventListener('DOMContentLoaded', function(){
        // Visit duration buttons
        const durationBtns = document.querySelectorAll('.duration-btn');
        const durationInput = document.getElementById('visitDurationInput');
        const visitStartHour = document.getElementById('visitStartHour');
        const visitStartMinute = document.getElementById('visitStartMinute');
        const visitEndTime = document.getElementById('visitEndTime');
        const resetBtn = document.getElementById('resetVisitTimeBtn');

        // Calculate end time
        function calculateEndTime(){
          const hour = visitStartHour?.value || '';
          const minute = visitStartMinute?.value || '';
          const duration = durationInput?.value || '';
          
          if (!hour || !minute || !duration) {
            if (visitEndTime) visitEndTime.value = '';
            return;
          }
          
          const startMinutes = parseInt(hour) * 60 + parseInt(minute);
          const endMinutes = startMinutes + parseInt(duration);
          const endHour = Math.floor(endMinutes / 60);
          const endMin = endMinutes % 60;
          
          if (visitEndTime) {
            visitEndTime.value = `${String(endHour).padStart(2,'0')}:${String(endMin).padStart(2,'0')}`;
          }
        }

        // Duration button clicks
        durationBtns.forEach(btn => {
          btn.addEventListener('click', function(){
            const value = this.dataset.duration || '';
            
            // Toggle selection
            const isActive = this.classList.contains('is-active');
            durationBtns.forEach(b => {
              b.classList.remove('is-active');
              b.style.background = '#fff';
              b.style.color = '#1e3c72';
              b.style.borderColor = '#d6dbe8';
            });
            
            if (!isActive) {
              this.classList.add('is-active');
              this.style.background = '#1e3c72';
              this.style.color = '#fff';
              this.style.borderColor = '#1e3c72';
              if (durationInput) durationInput.value = value;
            } else {
              if (durationInput) durationInput.value = '';
            }
            
            calculateEndTime();
          });
        });

        // Duration input change
        if (durationInput) {
          durationInput.addEventListener('input', function(){
            const value = this.value || '';
            
            // Clear button selection if manually typing
            durationBtns.forEach(b => {
              const btnValue = b.dataset.duration || '';
              if (btnValue === value) {
                b.classList.add('is-active');
                b.style.background = '#1e3c72';
                b.style.color = '#fff';
                b.style.borderColor = '#1e3c72';
              } else {
                b.classList.remove('is-active');
                b.style.background = '#fff';
                b.style.color = '#1e3c72';
                b.style.borderColor = '#d6dbe8';
              }
            });
            
            calculateEndTime();
          });
        }

        // Time selects change
        [visitStartHour, visitStartMinute].forEach(el => {
          if (el) el.addEventListener('change', calculateEndTime);
        });

        // Reset button
        if (resetBtn) {
          resetBtn.addEventListener('click', function(){
            if (visitStartHour) visitStartHour.value = '';
            if (visitStartMinute) visitStartMinute.value = '';
            if (durationInput) durationInput.value = '';
            if (visitEndTime) visitEndTime.value = '';
            
            durationBtns.forEach(b => {
              b.classList.remove('is-active');
              b.style.background = '#fff';
              b.style.color = '#1e3c72';
              b.style.borderColor = '#d6dbe8';
            });
          });
        }

        // Meeting buttons (영업활동) - setup for each subject block
        function setupMeetingButtons(block){
          if (!block) return;
          
          const meetingBtns = block.querySelectorAll('.meeting-btn');
          meetingBtns.forEach(btn => {
            // Remove old listeners by cloning
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(){
              const isActive = this.classList.contains('is-active');
              
              if (isActive) {
                this.classList.remove('is-active');
                this.style.background = '#fff';
                this.style.color = '#1e3c72';
                this.style.borderColor = '#d6dbe8';
              } else {
                this.classList.add('is-active');
                this.style.background = '#1e3c72';
                this.style.color = '#fff';
                this.style.borderColor = '#1e3c72';
              }
            });
          });
        }

        // Setup meeting buttons for all existing subject blocks
        const subjectBlocks = document.querySelectorAll('.subject-block');
        subjectBlocks.forEach(setupMeetingButtons);

        // Watch for new subject blocks
        const observer = new MutationObserver(function(mutations){
          mutations.forEach(function(mutation){
            mutation.addedNodes.forEach(function(node){
              if (node.nodeType === 1 && node.classList.contains('subject-block')){
                setupMeetingButtons(node);
              }
            });
          });
        });

        const subjectsBlock = document.getElementById('subjectsBlock');
        if (subjectsBlock) {
          observer.observe(subjectsBlock, { childList: true });
        }

        // Expose setup function globally for manual calls
        window.setupMeetingButtons = setupMeetingButtons;
      });
    })();
  </script>

  <script>
    // Populate and show the top debug banner with passed parameters
    (function(){
      function safeText(v){ try{ return (v||'').toString(); }catch(e){ return ''; } }
      document.addEventListener('DOMContentLoaded', function(){
        try{
          const banner = document.getElementById('topDebugBanner');
          const text = document.getElementById('topDebugText');
          const backBtn = document.getElementById('topBackBtn');
          const mappingStatusEl = document.getElementById('topMappingStatus');

          // Fallback: re-read URL params here to ensure values are captured even
          // if earlier initialization missed them. Accept common key names.
          try{
            const p = new URLSearchParams(window.location.search || '');
            if (!window._cmass_staffParam) {
              const u = p.get('user') || p.get('staff') || p.get('담당자');
              if (u) window._cmass_staffParam = decodeURIComponent(u);
            }
            if (!window._cmass_visitDateParam) {
              const d = p.get('date') || p.get('visitDate') || p.get('방문일');
              if (d) window._cmass_visitDateParam = decodeURIComponent(d);
            }
            if (!window.selectedRegion) {
              const r = p.get('region') || p.get('지역');
              if (r) window.selectedRegion = decodeURIComponent(r);
            }
            if (!window.selectedSchool) {
              const s = p.get('school') || p.get('학교');
              if (s) window.selectedSchool = decodeURIComponent(s);
            }
          }catch(e){ /* ignore URL parsing errors */ }

          // Prefer explicit URL params for display to avoid timing/order issues
          const p = new URLSearchParams(window.location.search || '');
          const staff = window._cmass_staffParam || p.get('user') || p.get('staff') || '';
          const date = window._cmass_visitDateParam || p.get('date') || p.get('visitDate') || '';
          const region = window.selectedRegion || p.get('region') || p.get('지역') || '';
          const school = window.selectedSchool || p.get('school') || p.get('학교') || '';

          if (text) text.textContent = `${safeText(staff)} - ${safeText(date)} - ${safeText(region)} - ${safeText(school)}`;
          if (banner && (staff || date || region || school)) banner.style.display = 'flex';
          if (backBtn) backBtn.addEventListener('click', function(){ try{ history.back(); }catch(e){ window.location.href = '/input.html'; } });
          if (mappingStatusEl) mappingStatusEl.style.display = 'none';

          // '새 보고서' button: clear current inputs and start a fresh report (keeps staff)
          try{
            const newBtn = document.getElementById('topNewReportBtn');
            if (newBtn) newBtn.addEventListener('click', function(){
              try{
                // keep staff, clear selection and inputs
                window.selectedRegion = '';
                window.selectedSchool = '';
                try{ window._cmass_lastFoundMeta = null; }catch(e){}
                try{ window._cmass_lastAppliedMappingKey = null; }catch(e){}

                const hideInline = document.getElementById('schoolMetaInline');
                if (hideInline) hideInline.classList.add('hidden');

                // clear region/school hidden inputs if present
                const selRegion = document.getElementById('selectedRegionInput'); if (selRegion) selRegion.value = '';
                const selSchool = document.getElementById('selectedSchoolInput'); if (selSchool) selSchool.value = '';

                // clear visit inputs
                const vd = document.getElementById('visitDate'); if (vd) vd.value = '';
                const sh = document.getElementById('visitStartHour'); if (sh) sh.value = '';
                const sm = document.getElementById('visitStartMinute'); if (sm) sm.value = '';
                const dur = document.getElementById('visitDurationInput'); if (dur) dur.value = '';
                const vend = document.getElementById('visitEndTime'); if (vend) vend.value = '';

                // clear accumulated visit list for this builder (keep global storage separate)
                try{ window._cmass_lastFoundMeta = null; }catch(e){}

                // reset subjects: remove existing and add one empty template block
                try{
                  const container = document.getElementById('subjectsBlock');
                  if (container){
                    container.innerHTML = '';
                    const tpl = document.getElementById('subject-template');
                    if (tpl && tpl.content){
                      const proto = tpl.content.querySelector('.subject-block');
                      if (proto){
                        const clone = proto.cloneNode(true);
                        container.appendChild(clone);
                        try{ if (typeof setupSubjectChoiceBlock === 'function') setupSubjectChoiceBlock(clone); }catch(e){}
                      }
                    }
                  }
                }catch(e){ console.warn('[topNewReport] subject reset failed', e); }

                // clear generated summary
                try{ const out = document.getElementById('generatedSummary'); if (out) out.value = '요약이 여기에 생성됩니다.'; }catch(e){}

                // update top banner text to reflect cleared state (keep staff)
                if (text) text.textContent = `${safeText(staff)} - - - -`;
                if (mappingStatusEl) { mappingStatusEl.textContent = '메타: -'; mappingStatusEl.style.display = 'none'; }

                // scroll to top of the form
                try{ window.scrollTo({ top: 0, behavior: 'smooth' }); }catch(e){}
              }catch(e){ console.warn('[topNewReport] handler failed', e); }
            });
          }catch(e){ /* ignore */ }
        }catch(e){ console.warn('[topDebugBanner] init failed', e); }
      });
    })();
    (function(){
      'use strict';
      let regionContainer;
      let schoolContainer;
      let searchInput;
      let searchClearBtn;
      let hiddenRegionInput;
      let hiddenSchoolInput;

      let allRegions = [];
      let staffScopedRegions = [];
      let visibleRegions = [];
  let staffToken = '';
  let resizeFitTimer = null;

      function fitSelectorLabels(){
        requestAnimationFrame(() => {
          const labels = document.querySelectorAll('.selector-btn .selector-label');
          labels.forEach((label) => {
            try {
              label.style.fontSize = '';
              const btn = label.closest('.selector-btn');
              if (!btn) return;
              const btnStyles = window.getComputedStyle(btn);
              const available = btn.clientWidth - ((parseFloat(btnStyles.paddingLeft) || 0) + (parseFloat(btnStyles.paddingRight) || 0));
              if (available <= 0) return;
              const computed = window.getComputedStyle(label);
              let size = parseFloat(computed.fontSize) || 15;
              const minSize = 10;
              label.style.fontSize = size + 'px';
              while (label.scrollWidth > available && size > minSize){
                size -= 0.5;
                label.style.fontSize = size + 'px';
              }
              if (label.scrollWidth > available) label.style.fontSize = minSize + 'px';
            } catch (err) {
              /* ignore measurement errors */
            }
          });
        });
      }

      const normalizeStaff = (name) => (name || '').replace(/\s+/g, '').toLowerCase();

      const cloneRegion = (region, overrideSchools) => {
        const sourceSchools = overrideSchools || region.schools || [];
        const schools = sourceSchools.map((s) => ({ name: s.name, staff: (s.staff || []).slice() }));
        const staff = dedupeStaff(schools.flatMap((s) => s.staff || []));
        return { name: region.name, schools, staff };
      };

      // Read incoming query parameters (from input.html Next button) and set
      // initial globals so init() and other code can use them.
      (function readIncomingParams(){
        try{
          const params = new URLSearchParams(window.location.search || '');
          const qSchool = params.get('school') || '';
          const qRegion = params.get('region') || '';
          const qDate = params.get('date') || '';
          const qUser = params.get('user') || '';

          // Store staff/user as provided. Keep both raw param and base name.
          if (qUser) {
            window._cmass_staffParam = decodeURIComponent(qUser);
            // _cmass_staffBase may be used elsewhere; keep it in sync if unset
            if (!window._cmass_staffBase) window._cmass_staffBase = window._cmass_staffParam;
          }

          if (qRegion) window.selectedRegion = decodeURIComponent(qRegion);
          if (qSchool) window.selectedSchool = decodeURIComponent(qSchool);
          // Keep date available for later (DOM might not be ready to set an input)
          if (qDate) window._cmass_visitDateParam = decodeURIComponent(qDate);
        }catch(e){ console.warn('[readIncomingParams] failed', e); }
      })();

      document.addEventListener('DOMContentLoaded', init);

      window.addEventListener('resize', () => {
        clearTimeout(resizeFitTimer);
        resizeFitTimer = setTimeout(fitSelectorLabels, 80);
      });

      async function init(){
        regionContainer = document.getElementById('regionButtons');
        schoolContainer = document.getElementById('schoolButtons');
        if (!regionContainer || !schoolContainer) return;

        searchInput = document.getElementById('searchInput');
        searchClearBtn = document.getElementById('searchClear');
        hiddenRegionInput = document.getElementById('selectedRegionInput');
        hiddenSchoolInput = document.getElementById('selectedSchoolInput');

        staffToken = determineStaffToken();
        allRegions = await loadRegionData();
        if (!allRegions.length){
          regionContainer.innerHTML = '<div class="empty-message">담당자 CSV를 불러오지 못했습니다.</div>';
          schoolContainer.innerHTML = '';
          return;
        }

  staffScopedRegions = filterRegionsByStaff(allRegions, staffToken);
  visibleRegions = staffScopedRegions.slice();
  // expose visibleRegions and staffScopedRegions to other global helpers for rendering/search fallbacks
  try{ window._cmass_visibleRegions = visibleRegions.slice(); window._cmass_staffScopedRegions = staffScopedRegions.slice(); }catch(e){}
  renderState();
        attachSearchHandlers();

        // If visit date was passed in the query params, populate the input (if present)
        try{
          if (window._cmass_visitDateParam) {
            const el = document.getElementById('visitDate');
            if (el) el.value = window._cmass_visitDateParam;
          }
        }catch(e){ /* ignore */ }

        // If both region and school were provided via params, attempt to auto-select
        // them so inline metadata and mapping logic run immediately.
        try{
          if (window.selectedRegion && window.selectedSchool) {
            // Give the UI a tiny moment to settle before invoking selection logic
            setTimeout(() => {
              try{ selectSchool(window.selectedRegion, window.selectedSchool); }catch(e){ console.warn('[init] auto selectSchool failed', e); }
            }, 40);
          }
        }catch(e){ /* ignore */ }
      }

      // Lightweight applyMeta for this page: populate inline pills and mapping status.
      if (typeof window.applyMeta !== 'function') {
        window.applyMeta = function(meta){
          try{
            console.log('[input-next] applyMeta called', meta);
            if (!meta) return;
            window._cmass_lastFoundMeta = meta;
            // show inline panel
            const inline = document.getElementById('schoolMetaInline');
            if (inline) { inline.classList.remove('hidden'); inline.style.display = 'block'; }

            // populate pills
            const tryGet = (obj, keys) => { for(const k of keys){ if(obj && typeof obj[k] !== 'undefined' && obj[k] !== null && String(obj[k]).trim() !== '') return obj[k]; } return null; };
            const est = tryGet(meta, ['설립','설립구분','establish','established']);
            const lvl = tryGet(meta, ['급','학교급','level']);
            const tot = tryGet(meta, ['총학생수','학생수계','studentsTotal']);
            const feat = tryGet(meta, ['특성','학교특성','feature']);
            const inlineEst = document.getElementById('inlinePillEstablish'); if (inlineEst) inlineEst.textContent = est ? ('설립: ' + String(est)) : '설립: -';
            const inlineLvl = document.getElementById('inlinePillLevel'); if (inlineLvl) inlineLvl.textContent = lvl ? ('급: ' + String(lvl)) : '급: -';
            const inlineTot = document.getElementById('inlinePillStudents'); if (inlineTot) inlineTot.textContent = tot ? ('총학생수: ' + String(tot)) : '총학생수: -';
            const inlineFeat = document.getElementById('inlinePillFeature'); if (inlineFeat) { inlineFeat.style.display = feat ? '' : 'none'; if(feat) inlineFeat.textContent = '특성: ' + String(feat); }

            // grades
            for (let g = 1; g <= 3; g++){
              const kc = `g${g}c`; const ks = `g${g}s`;
              let c = meta[kc]; let s = meta[ks];
              const elc = document.getElementById('inlineG'+g+'c'); if (elc) elc.textContent = (typeof c !== 'undefined' ? String(c) : '-');
              const els = document.getElementById('inlineG'+g+'s'); if (els) els.textContent = (typeof s !== 'undefined' ? String(s) : '-');
            }

            // mapping status in banner + quick 1학년 summary
            try{ 
              const mEl = document.getElementById('topMappingStatus'); 
              if (mEl) { 
                const g1c = (typeof meta.g1c !== 'undefined' && meta.g1c !== null) ? meta.g1c : (meta.g1c || '-');
                const g1s = (typeof meta.g1s !== 'undefined' && meta.g1s !== null) ? meta.g1s : (meta.g1s || '-');
                mEl.textContent = `메타: 찾음 · 1학년 ${g1c}학급 / ${g1s}명`;
                mEl.style.display = '';
              }
            }catch(e){}
          }catch(e){ console.warn('[input-next] applyMeta failed', e); }
        };
      }

      async function loadRegionData(){
        const regions = await fetchCsvRegions().catch(() => []);
        return Array.isArray(regions) ? regions : [];
      }


      function dedupeStaff(list){
        const seen = new Set();
        const out = [];
        (list || []).forEach((name) => {
          const trimmed = (name || '').trim();
          const key = normalizeStaff(trimmed);
          if (!trimmed || seen.has(key)) return;
          seen.add(key);
          out.push(trimmed);
        });
        return out;
      }

      function findHeaderIndex(header, candidates){
        if (!Array.isArray(header)) return -1;
        for (let i = 0; i < header.length; i += 1){
          const cell = (header[i] || '').trim();
          if (!cell) continue;
          if (candidates.some((name) => (name || '').trim() === cell)) return i;
        }
        return -1;
      }

      async function fetchCsvRegions(){
        const rows = await fetchCsvRows().catch(() => []);
        if (!rows || !rows.length) return [];
        const header = rows[0];
        const idxRegion = findHeaderIndex(header, ['region','지역']);
        const idxSchool = findHeaderIndex(header, ['school','학교','학교명']);
        let idxStaff = findHeaderIndex(header, ['staff','담당자']);
        if (idxStaff === -1) idxStaff = header.findIndex((h) => /staff/i.test((h || '').trim()));
        if (idxRegion === -1 || idxSchool === -1){
          console.warn('CSV header missing required columns', header);
          return [];
        }

        const regionMap = new Map();
        for (let i = 1; i < rows.length; i += 1){
          const row = rows[i];
          if (!row) continue;
          const regionName = (row[idxRegion] || '').trim();
          const schoolName = (row[idxSchool] || '').trim();
          if (!regionName || !schoolName) continue;
          const staffName = idxStaff >= 0 ? (row[idxStaff] || '').trim() : '';
          if (!regionMap.has(regionName)) regionMap.set(regionName, { name: regionName, schools: [], staffSet: new Set() });
          const region = regionMap.get(regionName);
          const staffList = staffName ? [staffName] : [];
          region.schools.push({ name: schoolName, staff: staffList });
          staffList.forEach((s) => region.staffSet.add(s));
        }

        const regions = Array.from(regionMap.values()).map((region) => {
          region.schools.sort((a, b) => a.name.localeCompare(b.name, 'ko', { sensitivity: 'base' }));
          return {
            name: region.name,
            schools: region.schools.map((s) => ({ name: s.name, staff: dedupeStaff(s.staff) })),
            staff: dedupeStaff(Array.from(region.staffSet))
          };
        });

        regions.sort((a, b) => a.name.localeCompare(b.name, 'ko', { sensitivity: 'base' }));
        return regions;
      }

      async function fetchCsvRows(){
        // Proxy to canonical implementation in /csv-helpers.js if present.
        if (typeof window.fetchCsvRows === 'function' && window.fetchCsvRows !== fetchCsvRows) {
          return window.fetchCsvRows.apply(this, arguments);
        }
        console.warn('[fetchCsvRows] canonical fetchCsvRows not available; no-op fallback returning null');
        return null;
      }

      function parseCsv(text){
        if (typeof window.parseCsv === 'function' && window.parseCsv !== parseCsv) {
          return window.parseCsv.apply(this, arguments);
        }
        console.warn('[parseCsv] canonical parseCsv not available; returning empty array');
        return [];
      }

      function determineStaffToken(){
        const base = (window._cmass_staffBase || '').trim();
        if (base) return base;
        const raw = (window._cmass_staffParam || '').replace(/\s*(부장|차장|과장|대리|팀장|선생님|선생)$/g, '').trim();
        return raw || '';
      }

      function filterRegionsByStaff(regions, staffName){
        if (!staffName) return regions.map((r) => cloneRegion(r));
        const norm = normalizeStaff(staffName);
        const filtered = [];
        regions.forEach((region) => {
          const matches = (region.schools || []).filter((school) =>
            (school.staff || []).some((s) => normalizeStaff(s) === norm)
          );
          if (matches.length) filtered.push(cloneRegion(region, matches));
        });
        return filtered;
      }

      function attachSearchHandlers(){
        if (!searchInput) return;
        let timer = null;
        searchInput.addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(() => applySearch(searchInput.value || ''), 140);
        });
        if (searchClearBtn){
          searchClearBtn.addEventListener('click', () => {
            searchInput.value = '';
            applySearch('');
            searchInput.focus();
          });
        }
      }

        // Initial update and safe wiring for basic buttons
        try{
          updateVisitAccumStatus();

          const copyBtn = document.getElementById('copyKakaoBtn');
          if (copyBtn) copyBtn.addEventListener('click', copyToKakao);

          const genBtn = document.getElementById('generateSummaryBtn');
          if (genBtn) genBtn.addEventListener('click', function(){ try{ const out = document.getElementById('generatedSummary'); if (out) out.value = generateSummary(); }catch(e){} });

          const saveBtn = document.getElementById('saveToServerBtn');
          if (saveBtn) saveBtn.addEventListener('click', function(){ alert('서버 저장 기능은 아직 활성화되어 있지 않습니다.'); });

          const backBtn = document.getElementById('backBtn');
          if (backBtn) backBtn.addEventListener('click', function(){ history.back(); });
        }catch(e){ console.warn('[init-wiring] failed', e); }

  </script>

  <!-- Insert simple region/school selector for this page (used by legacy scripts) -->
  <section id="schoolSelectSection" style="margin-top:1.2rem;padding:1rem;border:1px solid #e6eefc;border-radius:1rem;background:#f9fbff;">
    <h4 style="margin:0 0 0.8rem 0;font-size:1.05rem;font-weight:800;color:#12325a;">지역/학교 선택</h4>
    <input type="hidden" id="selectedRegionInput" name="region">
    <input type="hidden" id="selectedSchoolInput" name="school">
    <div style="margin-top:8px;margin-bottom:6px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:8px;">
        <label for="visitDate" style="display:inline-block;font-weight:700;">방문일</label>
        <input type="date" id="visitDate" name="visitDate" style="padding:.45rem;border-radius:.45rem;border:1px solid #d6dbe8;" />
      </div>
      <div id="visitAccumStatus" style="padding:.4rem .6rem;border-radius:.5rem;background:#f0f7ff;border:1px solid #e6eefc;color:#1e3c72;font-weight:700;">누적: 0개 학교</div>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.6rem;flex-wrap:wrap;">
      <input type="text" id="searchInput" placeholder="학교 검색..." style="flex:1;padding:.6rem;border-radius:.6rem;border:1px solid #d6dbe8;" />
      <button type="button" id="searchClear" style="padding:.5rem .7rem;border-radius:.6rem;border:1px solid #d6dbe8;background:#fff;">초기화</button>
    </div>
    <div style="display:flex;gap:12px;margin-top:.8rem;flex-wrap:wrap;">
      <div id="regionButtons" style="flex:1;min-width:220px;"></div>
      <div id="schoolButtons" style="flex:2;min-width:220px;"></div>
    </div>
  </section>

  <script>
  // Helper implementations to satisfy callers and provide a lightweight UX
  (function(){
    'use strict';

    function safeEl(id){ return document.getElementById(id); }

    window.renderState = function(){
      try{
        const regionContainer = safeEl('regionButtons');
        const schoolContainer = safeEl('schoolButtons');
        const regions = (window._cmass_visibleRegions && Array.isArray(window._cmass_visibleRegions)) ? window._cmass_visibleRegions : (window._cmass_staffScopedRegions || []);
        if (!regionContainer) return;
        regionContainer.innerHTML = '';
        if (schoolContainer) schoolContainer.innerHTML = '';
        if (!regions || regions.length === 0){
          regionContainer.innerHTML = '<div class="empty-message">표시할 지역이 없습니다.</div>';
          return;
        }

        regions.forEach((region) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'selector-btn';
          btn.textContent = region.name || '';
          btn.addEventListener('click', function(){
            // set hidden input
            const hid = safeEl('selectedRegionInput'); if (hid) hid.value = region.name || '';
            // render schools
            if (schoolContainer){
              schoolContainer.innerHTML = '';
              (region.schools || []).forEach((s) => {
                const sbtn = document.createElement('button');
                sbtn.type = 'button'; sbtn.className = 'selector-btn'; sbtn.textContent = s.name || '';
                sbtn.addEventListener('click', function(){
                  try{ if (typeof selectSchool === 'function') selectSchool(region.name, s.name); }catch(e){}
                });
                schoolContainer.appendChild(sbtn);
              });
            }
          });
          regionContainer.appendChild(btn);
        });
        try{ if (typeof fitSelectorLabels === 'function') fitSelectorLabels(); }catch(e){}
      }catch(e){ console.warn('[renderState] error', e); }
    };

    window.applySearch = function(query){
      try{
        const q = (query || '').toString().trim().toLowerCase();
        const base = Array.isArray(window._cmass_staffScopedRegions) ? window._cmass_staffScopedRegions : (Array.isArray(window._cmass_visibleRegions) ? window._cmass_visibleRegions : []);
        if (!q){
          window._cmass_visibleRegions = base.slice();
          return renderState();
        }
        const filtered = [];
        base.forEach((r) => {
          const matchedSchools = (r.schools || []).filter(s => (s.name || '').toLowerCase().includes(q));
          if (matchedSchools.length) filtered.push({ name: r.name, schools: matchedSchools });
        });
        window._cmass_visibleRegions = filtered;
        return renderState();
      }catch(e){ console.warn('[applySearch] failed', e); }
    };

    window.selectSchool = function(regionName, schoolName){
      try{
        window.selectedRegion = regionName || '';
        window.selectedSchool = schoolName || '';
        const hidR = safeEl('selectedRegionInput'); if (hidR) hidR.value = window.selectedRegion;
        const hidS = safeEl('selectedSchoolInput'); if (hidS) hidS.value = window.selectedSchool;
        try{ if (typeof applyMappingIfPresent === 'function') applyMappingIfPresent(window.selectedRegion, window.selectedSchool); }catch(e){}
      }catch(e){ console.warn('[selectSchool] failed', e); }
    };

    window.renumberSubjectBlocks = function(){ /* no-op for now */ };

    window.updateVisitAccumStatus = function(){
      try{
        const statusEl = safeEl('visitAccumStatus');
        if (!statusEl) return;
        const count = (window._cmass_visitList || []).length || 0;
        statusEl.textContent = `누적: ${count}개 학교`;
        statusEl.style.background = count > 0 ? '#e8f5e9' : '#f0f7ff';
        statusEl.style.color = count > 0 ? '#2e7d32' : '#1e3c72';
      }catch(e){ console.warn('[updateVisitAccumStatus] failed', e); }
    };

    window.copyToKakao = function(){
      try{
        const summary = (typeof window.generateSummary === 'function') ? window.generateSummary() : (typeof generateSummary === 'function' ? generateSummary() : '');
        if (!summary) { alert('입력된 데이터가 없습니다.'); return; }
        navigator.clipboard.writeText(summary).then(()=>{ alert('✅ 카카오톡에 붙여넣기 할 수 있습니다!'); }).catch(err=>{ console.error('복사 실패:', err); alert('❌ 복사 실패. 다시 시도해주세요.'); });
      }catch(e){ console.warn('[copyToKakao] failed', e); }
    };

    // lightweight wrapper: prefer existing generateSummary if already implemented elsewhere
    window.generateSummary = window.generateSummary || function(){ return '(요약 생성 기능이 준비되지 않았습니다.)'; };

  })();
</script>
</body>
</html>
