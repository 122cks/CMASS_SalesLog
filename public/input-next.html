<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e3c72">
  <title>ì˜ì—… í™œë™ ì…ë ¥</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f5f7fa; color:#12325a; padding:12px; line-height:1.5; }
    .container { max-width:640px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    h2 { margin-bottom:1rem; color:#1e3c72; }
    .info-box { background:#e8f4fd; padding:12px; border-radius:8px; margin-bottom:1rem; border-left:4px solid #1e88e5; }
    label { display:block; font-weight:700; margin-top:1rem; margin-bottom:0.4rem; color:#12325a; }
    input, select, textarea { width:100%; padding:0.7rem; border-radius:0.6rem; border:1px solid #d6dbe8; font-size:1rem; }
    button { padding:1rem; border-radius:0.8rem; border:none; font-weight:800; cursor:pointer; font-size:1.05rem; width:100%; margin-top:0.6rem; }
    .btn-primary { background:#1e3c72; color:#fff; }
    .btn-secondary { background:#e3eafc; color:#1e3c72; }
    .btn-back { background:#fff; color:#1e3c72; border:1px solid #d6dbe8; }
    .subject-block { background:#f9fafd; padding:1.2rem; border-radius:0.8rem; border:1px solid #e0e8f5; margin-bottom:1rem; }
    .subject-choice-group { display:grid; grid-template-columns:repeat(3,1fr); gap:0.6rem; margin-bottom:1rem; }
    .subject-choice-btn { padding:0.8rem; border-radius:0.6rem; border:1px solid #d6dbe8; background:#fff; font-weight:700; cursor:pointer; }
    .subject-choice-btn.is-active { background:#1e3c72; color:#fff; border-color:#1e3c72; }
    .meeting-buttons { display:grid; grid-template-columns:repeat(3,1fr); gap:0.6rem; margin-bottom:1rem; }
    .meeting-btn { padding:0.8rem; border-radius:0.6rem; border:1px solid #d6dbe8; background:#fff; font-weight:700; cursor:pointer; text-align:center; }
    .meeting-btn.is-active { background:#1e3c72; color:#fff; border-color:#1e3c72; }
    #subjectsBlock { display:flex; flex-direction:column; gap:1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ì˜ì—… í™œë™ ì…ë ¥</h2>
    
    <div class="info-box" id="schoolInfo">
      <strong>í•™êµ:</strong> <span id="schoolName">-</span><br>
      <strong>ì§€ì—­:</strong> <span id="regionName">-</span><br>
      <strong>ë°©ë¬¸ì¼:</strong> <span id="visitDateDisplay">-</span>
    </div>

    <form id="activityForm">
      <label>ë°©ë¬¸ ì‹œì‘ ì‹œê°</label>
      <div style="display:flex;gap:0.6rem;">
        <select id="visitStartHour" required>
          <option value="">ì‹œ</option>
          <option value="06">06</option>
          <option value="07">07</option>
          <option value="08">08</option>
          <option value="09">09</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
        </select>
        <select id="visitStartMinute" required>
          <option value="">ë¶„</option>
          <option value="00">00</option>
          <option value="05">05</option>
          <option value="10">10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="25">25</option>
          <option value="30">30</option>
          <option value="35">35</option>
          <option value="40">40</option>
          <option value="45">45</option>
          <option value="50">50</option>
          <option value="55">55</option>
        </select>
      </div>

      <label>ë°©ë¬¸ ì†Œìš” ì‹œê°„ (ë¶„)</label>
      <input type="number" id="visitDuration" placeholder="ì˜ˆ: 30" min="1" max="480" required>

      <h3 style="margin-top:1.5rem;margin-bottom:0.8rem;">ê³¼ëª©/ì„ ìƒë‹˜ë³„ ì˜ì—…ê¸°ë¡</h3>
      <div id="subjectsBlock"></div>

      <button type="button" id="addSubjectBtn" class="btn-secondary">ê³¼ëª©/ì„ ìƒë‹˜ ì¶”ê°€</button>

      <!-- Action buttons section -->
      <div style="background:#f8f9fa;padding:1rem;border-radius:0.8rem;margin-top:1.5rem;">
        <h4 style="margin:0 0 0.8rem 0;font-size:1rem;color:#1e3c72;">í‡´ê·¼ë³´ê³  ê´€ë¦¬</h4>
        
        <button type="button" id="copyKakaoBtn" style="width:100%;padding:0.8rem;border-radius:0.8rem;border:1px solid #ffd9b3;background:#fff;color:#b25700;font-weight:800;margin-bottom:0.6rem;">ì¹´í†¡ìœ¼ë¡œ ë³µì‚¬</button>
        
        <button type="button" id="saveToServerBtn" style="width:100%;padding:0.8rem;border-radius:0.8rem;border:1px solid #c8e6c9;background:#fff;color:#2e7d32;font-weight:800;margin-bottom:0.6rem;">ì„œë²„ì— ì €ì¥</button>
        
        <div style="display:flex;gap:0.6rem;">
          <button type="button" id="generateSummaryBtn" style="flex:1;padding:0.8rem;border-radius:0.8rem;border:1px solid #4CAF50;background:#4CAF50;color:#fff;font-weight:800;">ìš”ì•½ ìƒì„±</button>
          <button type="button" id="clearSummaryBtn" style="flex:1;padding:0.8rem;border-radius:0.8rem;border:1px solid #e0e0e0;background:#f5f5f5;color:#666;font-weight:700;">ë‚´ìš© ì „ì²´ì§€ìš°ê¸°</button>
        </div>
        
        <div style="margin-top:0.6rem;font-size:0.85rem;color:#666;">
          í‡´ê·¼ë³´ê³  ì‹œê°„ ì„¤ì •: í‡´ê·¼ ì‹œê° ê¸°ì¤€ + 30ë¶„
        </div>
        
        <textarea id="generatedSummary" readonly rows="8" style="width:100%;margin-top:0.8rem;padding:0.8rem;border-radius:0.6rem;border:1px solid #d6dbe8;background:#fafafa;font-size:0.9rem;color:#333;">ìš”ì•½ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤.</textarea>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-top:1.5rem;">
        <button type="button" id="backBtn" class="btn-back">ë’¤ë¡œ ëŒì•„ê°€ê¸°</button>
        <button type="submit" class="btn-primary">ì…ë ¥ ì™„ë£Œ</button>
      </div>
    </form>
  </div>

  <template id="subject-template">
    <div class="subject-block">
      <label>ê³¼ëª©</label>
      <input type="hidden" class="subject-name" value="">
      <div class="subject-choice-group">
        <button type="button" class="subject-choice-btn" data-subject="ì •ë³´">ì •ë³´</button>
        <button type="button" class="subject-choice-btn" data-subject="ì§„ë¡œ">ì§„ë¡œ</button>
        <button type="button" class="subject-choice-btn" data-subject="ë³´ê±´">ë³´ê±´</button>
        <button type="button" class="subject-choice-btn" data-subject="ë¯¸ìˆ ">ë¯¸ìˆ </button>
        <button type="button" class="subject-choice-btn" data-subject="ì²´ìœ¡">ì²´ìœ¡</button>
        <button type="button" class="subject-choice-btn" data-subject="ë„ì„œê´€ì‚¬ì„œ">ë„ì„œê´€ì‚¬ì„œ</button>
        <button type="button" class="subject-choice-btn" data-subject="íŠ¹ì„±í™”">íŠ¹ì„±í™”</button>
        <button type="button" class="subject-choice-btn" data-subject="ê¸°íƒ€">ê¸°íƒ€</button>
      </div>

      <label>ì„ ìƒë‹˜ ì„±í•¨</label>
      <input type="text" class="teacher-name" placeholder="ì˜ˆ: ê¹€ì˜í¬">

      <label>ì—°ë½ì²˜ (010-XXXX-XXXX)</label>
      <input type="text" class="contact-suffix" placeholder="ë’·ìë¦¬ 8ìë¦¬ë§Œ ì…ë ¥">

      <label>ë¯¸íŒ… ìœ í˜• (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label>
      <div class="meeting-buttons">
        <button type="button" class="meeting-btn" data-meeting="ëª…í•¨ì¸ì‚¬">ëª…í•¨ì¸ì‚¬</button>
        <button type="button" class="meeting-btn" data-meeting="ê°€ì´ë“œë¶">ê°€ì´ë“œë¶</button>
        <button type="button" class="meeting-btn" data-meeting="í‹°ì¹­ìƒ˜ì†Œê°œ">í‹°ì¹­ìƒ˜ì†Œê°œ</button>
        <button type="button" class="meeting-btn" data-meeting="êµêµ¬ì‹œì—°">êµêµ¬ì‹œì—°</button>
        <button type="button" class="meeting-btn" data-meeting="ìƒ˜í”Œì „ë‹¬">ìƒ˜í”Œì „ë‹¬</button>
        <button type="button" class="meeting-btn" data-meeting="ê¸°íƒ€ìƒë‹´">ê¸°íƒ€ìƒë‹´</button>
      </div>

      <label>ë‚©í’ˆ í•­ëª©</label>
      <input type="text" class="delivery-items" placeholder="ì˜ˆ: êµì¬ 10ê¶Œ">

      <label>íŠ¹ì´ì‚¬í•­/ëŒ€í™”ë‚´ìš©</label>
      <textarea class="conversation-detail" rows="3" placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ëŒ€í™” ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

      <button type="button" class="remove-subject-btn" style="background:#ff5252;color:#fff;margin-top:0.8rem;">ì´ ê³¼ëª© ì‚­ì œ</button>
    </div>
  </template>

  <script>
    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const school = params.get('school') || '';
    const region = params.get('region') || '';
    const visitDate = params.get('date') || '';
    const staff = params.get('user') || '';

    // Display school info
    document.getElementById('schoolName').textContent = school || '-';
    document.getElementById('regionName').textContent = region || '-';
    document.getElementById('visitDateDisplay').textContent = visitDate || '-';

    // Subject block management
    function setupSubjectBlock(block) {
      // Subject choice buttons
      const subjectBtns = block.querySelectorAll('.subject-choice-btn');
      const subjectHidden = block.querySelector('.subject-name');
      
      subjectBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          subjectBtns.forEach(b => b.classList.remove('is-active'));
          this.classList.add('is-active');
          if (subjectHidden) {
            subjectHidden.value = this.dataset.subject;
          }
        });
      });

      // Meeting buttons
      const meetingBtns = block.querySelectorAll('.meeting-btn');
      meetingBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('is-active');
        });
      });

      // Remove subject button
      const removeBtn = block.querySelector('.remove-subject-btn');
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          if (confirm('ì´ ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            block.remove();
          }
        });
      }
    }

    // Add initial subject block
    function addSubjectBlock() {
      const template = document.getElementById('subject-template');
      const container = document.getElementById('subjectsBlock');
      
      if (template && template.content) {
        const clone = template.content.cloneNode(true);
        // Append the cloned fragment first, then locate the newly-added .subject-block
        container.appendChild(clone);
        // Find the last appended subject-block reliably
        const blocks = container.querySelectorAll('.subject-block');
        const block = blocks[blocks.length - 1];
        if (block) setupSubjectBlock(block);
      }
    }

    // Add subject button
    document.getElementById('addSubjectBtn').addEventListener('click', addSubjectBlock);

    // Initialize with one subject block
    addSubjectBlock();

    // Collect form data
    function collectData() {
      const subjects = [];
      const blocks = document.querySelectorAll('.subject-block');
      
      blocks.forEach(block => {
        const subject = block.querySelector('.subject-name').value;
        const teacher = block.querySelector('.teacher-name').value;
        const contactSuffix = block.querySelector('.contact-suffix').value;
        const delivery = block.querySelector('.delivery-items').value;
        const conversation = block.querySelector('.conversation-detail').value;
        
        const meetings = [];
        block.querySelectorAll('.meeting-btn.is-active').forEach(btn => {
          meetings.push(btn.dataset.meeting);
        });
        
        if (subject || teacher) {
          subjects.push({
            subject,
            teacher,
            contactSuffix,
            contactFormatted: contactSuffix ? `010-${contactSuffix}` : '',
            meetings,
            delivery,
            conversation
          });
        }
      });

      return {
        school,
        region,
        visitDate,
        staff,
        visitStartHour: document.getElementById('visitStartHour').value,
        visitStartMinute: document.getElementById('visitStartMinute').value,
        visitDuration: document.getElementById('visitDuration').value,
        subjects
      };
    }

    // Generate summary
    function generateSummary() {
      const data = collectData();
      if (!data.subjects || data.subjects.length === 0) {
        return 'ì…ë ¥ëœ ê³¼ëª©/ì„ ìƒë‹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
      }

      const startHour = parseInt(data.visitStartHour) || 0;
      const startMinute = parseInt(data.visitStartMinute) || 0;
      const durationMinutes = parseInt(data.visitDuration) || 0;
      const endHour = Math.floor((startHour * 60 + startMinute + durationMinutes) / 60);
      const endMinute = (startHour * 60 + startMinute + durationMinutes) % 60;
      const durationHours = Math.floor(durationMinutes / 60);
      const remainMinutes = durationMinutes % 60;

      const totalMeetings = data.subjects.reduce((sum, subj) => sum + (subj.meetings?.length || 0), 0);
      const contactCount = data.subjects.filter(subj => subj.contactFormatted).length;

      let summary = `(${data.staff || 'ì˜ì—…ì‚¬ì›'} ë¶€ì¥ í‡´ê·¼ë³´ê³ )\n`;
      summary += `ë°©ë¬¸ì¼: ${data.visitDate}\n`;
      summary += `ì´ ë°©ë¬¸ í•™êµ: 1ê°œ Â· ì´ ë¯¸íŒ…ìˆ˜: ${totalMeetings}ê±´ Â· ì—°ë½ì²˜ í™•ë³´: ${contactCount}ê±´ Â· ì¶”ê°€ì„ ì • í™•ì¸: 0ê±´\n\n`;

      summary += `1. ì¶œê·¼: ${String(startHour).padStart(2,'0')}:${String(startMinute).padStart(2,'0')} Â· `;
      summary += `í‡´ê·¼: ${String(endHour).padStart(2,'0')}:${String(endMinute).padStart(2,'0')} `;
      summary += `(${durationHours}ì‹œê°„ ${remainMinutes}ë¶„)\n\n`;

      summary += `2. ì„¸ë¶€ì—…ë¬´\n\n`;
      summary += `ê°€. ${data.school} (, , )\n`;
      summary += ` ${String(startHour).padStart(2,'0')}:${String(startMinute).padStart(2,'0')}~${String(endHour).padStart(2,'0')}:${String(endMinute).padStart(2,'0')} (${durationMinutes}ë¶„)\n\n`;

      data.subjects.forEach((subj, idx) => {
        summary += `-ê°€${idx+1}. ${subj.subject || '-'} ${subj.teacher || '-'}`;
        if (subj.contactFormatted) summary += ` (${subj.contactFormatted})`;
        if (subj.meetings && subj.meetings.length > 0) {
          summary += ` Â· ${subj.meetings.join(' Â· ')}`;
        }
        if (subj.delivery) summary += ` Â· ${subj.delivery}`;
        summary += `\n`;
      });

      summary += `\n3. í‡´ê·¼ë³´ê³  ìë£Œ ì •ë¦¬ (${String(endHour).padStart(2,'0')}:${String(endMinute).padStart(2,'0')}~${String(endHour).padStart(2,'0')}:${String(endMinute + 30).padStart(2,'0')}) (30ë¶„)\n\n`;
      summary += `- ë.\n\n`;

      const subjectCounts = {};
      data.subjects.forEach(subj => {
        if (subj.subject) {
          subjectCounts[subj.subject] = (subjectCounts[subj.subject] || 0) + 1;
        }
      });
      const majorSubjects = Object.entries(subjectCounts)
        .map(([subj, count]) => `${subj}(${count}íšŒ)`)
        .join(', ');
      
      summary += `ìë™ íƒœê·¸: ì£¼ìš”ê³¼ëª©: ${majorSubjects || 'ì—†ìŒ'}`;
      if (data.school) summary += `, ì¬ë°©ë¬¸: ${data.school}`;

      return summary.trim();
    }

    // Generate summary button
    document.getElementById('generateSummaryBtn').addEventListener('click', function() {
      const summary = generateSummary();
      document.getElementById('generatedSummary').value = summary;
    });

    // Clear summary button
    document.getElementById('clearSummaryBtn').addEventListener('click', function() {
      if (confirm('ìš”ì•½ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        document.getElementById('generatedSummary').value = 'ìš”ì•½ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤.';
      }
    });

    // Copy to Kakao button - produce a cleaned, icon-free text for KakaoTalk
    document.getElementById('copyKakaoBtn').addEventListener('click', function() {
      const summary = document.getElementById('generatedSummary').value;
      if (!summary || summary === 'ìš”ì•½ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤.') {
        alert('ë¨¼ì € ìš”ì•½ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
      }

      // Remove common icons/emojis and normalize middle-dots to simple separators
      let cleaned = summary.replace(/[âœ…âŒâ€¢â€¢Â·â€¢â˜…â˜†â–ºâ—¦â—âœ”âœ–ğŸŒŸğŸš«]/g, '');
      cleaned = cleaned.replace(/Â·/g, ' - ');
      // Collapse multiple blank lines into one
      cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
      // Trim trailing spaces on lines
      cleaned = cleaned.split('\n').map(s => s.trim()).join('\n');

      navigator.clipboard.writeText(cleaned).then(() => {
        alert('ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('ë³µì‚¬ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      });
    });

    // Save to server button (placeholder)
    document.getElementById('saveToServerBtn').addEventListener('click', function() {
      alert('ì„œë²„ ì €ì¥ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
    });

    // Form submit
    document.getElementById('activityForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const data = collectData();
      console.log('[Form Submit]', data);
      
      // Save to session storage for parent page
      try {
        sessionStorage.setItem('cmass_newVisit', JSON.stringify(data));
      } catch(e) {
        console.error('Failed to save to sessionStorage:', e);
      }
      
      alert('ì…ë ¥ ì™„ë£Œ!');
      
      // Return to input.html
      window.location.href = '/input' + window.location.search;
    });

    // Back button
    document.getElementById('backBtn').addEventListener('click', function() {
      if (confirm('ì…ë ¥í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë’¤ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.location.href = '/input' + window.location.search;
      }
    });
  </script>
</body>
</html>
